{% extends "base.html" %}
{% load i18n %}
{% load i18n_extras %}
{% load form_tags %}
{% load static %}

{% block navbar %}{% endblock %}

{% block title %}{{ titulo_pagina }} | {% trans "ViveMedellín" %}{% endblock %}

{% block meta_description %}
  {{ descripcion_pagina }}. {% trans "Encuentra los lugares mejor valorados en ViveMedellín." %}
{% endblock %}

{% block meta_keywords %}
  {% blocktrans %}lugares Medellín, bares Medellín, restaurantes Medellín, sitios para salir en Medellín{% endblocktrans %}
{% endblock %}

{% block og_title %}{{ titulo_pagina }} | ViveMedellín{% endblock %}

{% block og_description %}
  {{ descripcion_pagina }}. {% trans "Descubre lugares con calificaciones reales en Medellín." %}
{% endblock %}

{% block og_image %}
  {{ '/static/img/og-image.jpg'|ensure_absolute_url:request }}
{% endblock %}

{% block content %}
<section class="places-section">
  <div class="container py-5">
    <div class="places-main-wrapper">

      <!-- Card Superior: Navegación + Título + Filtros -->
      <div class="places-header-card mb-4">
        {% get_current_language as LANGUAGE_CODE %}

        <!-- Navegación superior -->
        <div class="d-flex justify-content-end align-items-center mb-3 px-1 flex-wrap gap-2">
          <div class="home-lang-switch d-flex flex-wrap gap-2">
            <a href="{% url 'explorer:home' %}" class="btn btn-lang-home inactive">{% trans "Inicio" %}</a>
            {% if LANGUAGE_CODE|slice:":2" == 'en' %}
              <a href="{% url 'explorer:about' %}" class="btn btn-lang-home inactive">{% trans "Nosotros" %}</a>
            {% else %}
              <a href="{% url 'explorer:about_es' %}" class="btn btn-lang-home inactive">{% trans "Nosotros" %}</a>
            {% endif %}
            {% include 'components/lang_switcher.html' %}
          </div>
        </div>

        <!-- Título -->
        <div class="text-center mb-4">
          <h1 class="places-title fw-bold">
            <span class="title-main">{{ titulo_pagina }}</span>
          </h1>
          <p class="lead text-white-50">{{ descripcion_pagina }}</p>
        </div>

        <!-- Filtros estilo HOME -->
        <div class="filtros-home-style">
          <div class="row g-3 justify-content-center">

            <!-- DROPDOWN: Áreas -->
            <div class="col-lg-4 col-md-6">
              <div class="dropdown">
                <button class="btn btn-filtro-dropdown w-100 dropdown-toggle {% if region_actual %}selected{% endif %}" type="button"
                        id="areasDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-geo-alt me-2"></i>
                  <span id="area-label">{% if region_actual %}{{ region_actual.name }}{% else %}{% trans "Seleccionar Área" %}{% endif %}</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-filtros shadow-lg" aria-labelledby="areasDropdown">
                  <li>
                    <a class="dropdown-item dropdown-item-filtro area-option" href="javascript:void(0)" 
                       data-area-slug="" data-area-name="{% trans 'Todas las áreas' %}">
                      <i class="bi bi-globe me-2 text-primary"></i>
                      <div>
                        <div class="fw-semibold">{% trans "Todas las áreas" %}</div>
                        <small class="text-muted">{% trans "Ver todo Medellín" %}</small>
                      </div>
                    </a>
                  </li>
                  {% if comunas_medellin %}
                    <li><hr class="dropdown-divider"></li>
                    <li class="dropdown-header"><i class="bi bi-building me-2 text-success"></i>{% trans "Medellín (Áreas)" %}</li>
                    {% for area in comunas_medellin %}
                      <li>
                        <a class="dropdown-item dropdown-item-filtro area-option" href="javascript:void(0)"
                           data-area-slug="{{ area.slug }}" data-area-name="{{ area.name }}">
                          <i class="bi bi-geo-alt me-2 text-primary"></i>
                          <div class="fw-semibold">{{ area.name }}</div>
                        </a>
                      </li>
                    {% endfor %}
                  {% endif %}
                  {% if otras_regiones %}
                    <li><hr class="dropdown-divider"></li>
                    <li class="dropdown-header"><i class="bi bi-map me-2 text-info"></i>{% trans "Otras áreas de Antioquia" %}</li>
                    {% for area in otras_regiones %}
                      <li>
                        <a class="dropdown-item dropdown-item-filtro area-option" href="javascript:void(0)"
                           data-area-slug="{{ area.slug }}" data-area-name="{{ area.name }}">
                          <i class="bi bi-geo-alt me-2 text-primary"></i>
                          <div class="fw-semibold">{{ area.name }}</div>
                        </a>
                      </li>
                    {% endfor %}
                  {% endif %}
                </ul>
              </div>
            </div>

            <!-- DROPDOWN: Tipos -->
            <div class="col-lg-4 col-md-6">
              <div class="dropdown">
                <button class="btn btn-filtro-dropdown w-100 dropdown-toggle {% if tipo_actual %}selected{% endif %}" type="button"
                        id="tiposDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-grid-3x3-gap me-2"></i>
                  <span id="tipo-label-btn">{% if tipo_actual_label %}{{ tipo_actual_label }}{% else %}{% trans "Seleccionar Tipo" %}{% endif %}</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-filtros shadow-lg" aria-labelledby="tiposDropdown">
                  <li>
                    <a class="dropdown-item dropdown-item-filtro tipo-option" href="javascript:void(0)"
                       data-tipo-code="" data-tipo-label="{% trans 'Todos los tipos' %}">
                      <i class="bi bi-grid me-2 text-primary"></i>
                      <div class="fw-semibold">{% trans "Todos los tipos" %}</div>
                    </a>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  {% for grupo in tipo_grupos_ui %}
                    <li class="dropdown-header"><span class="me-2">{{ grupo.emoji }}</span>{{ grupo.name }}</li>
                    {% for item in grupo.items %}
                      <li>
                        <a class="dropdown-item dropdown-item-filtro tipo-option" href="javascript:void(0)"
                           data-tipo-code="{{ item.code }}" data-tipo-label="{{ item.label }}">
                          <i class="bi bi-arrow-right me-2 text-muted"></i>
                          <div class="fw-semibold">{{ item.label }}</div>
                        </a>
                      </li>
                    {% endfor %}
                    {% if not forloop.last %}<li><hr class="dropdown-divider"></li>{% endif %}
                  {% endfor %}
                </ul>
              </div>
            </div>

            <!-- DROPDOWN: Características -->
            <div class="col-lg-4 col-md-6">
              <div class="dropdown">
                <button class="btn btn-filtro-dropdown w-100 dropdown-toggle" type="button"
                        id="featuresDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-stars me-2"></i>
                  <span id="features-label">{% trans "Características" %}</span>
                  <span id="features-count" class="badge bg-success ms-2" style="display: none;">0</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-filtros shadow-lg" aria-labelledby="featuresDropdown">
                  <!-- Limpiar características -->
                  <li>
                    <a class="dropdown-item dropdown-item-filtro feature-clear" href="javascript:void(0)">
                      <i class="bi bi-x-circle me-2 text-muted"></i>
                      <div class="fw-semibold">{% trans "Limpiar características" %}</div>
                    </a>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  
                  <!-- Servicios de Entrega -->
                  <li class="dropdown-header"><i class="bi bi-bicycle me-2 text-primary"></i>{% trans "Servicios de Entrega" %}</li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="delivery" data-label="{% trans 'Delivery' %}"><i class="bi bi-bicycle me-2 text-success"></i><div class="fw-semibold">{% trans "Delivery" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="takeout" data-label="{% trans 'Para Llevar' %}"><i class="bi bi-bag me-2 text-success"></i><div class="fw-semibold">{% trans "Para Llevar" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="dine_in" data-label="{% trans 'Comer en Local' %}"><i class="bi bi-house me-2 text-success"></i><div class="fw-semibold">{% trans "Comer en Local" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  
                  <li><hr class="dropdown-divider"></li>
                  
                  <!-- Ambiente & Experiencia -->
                  <li class="dropdown-header"><i class="bi bi-stars me-2 text-warning"></i>{% trans "Ambiente & Experiencia" %}</li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="outdoor_seating" data-label="{% trans 'Terraza' %}"><i class="bi bi-tree me-2 text-success"></i><div class="fw-semibold">{% trans "Terraza" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="live_music" data-label="{% trans 'Música en Vivo' %}"><i class="bi bi-music-note-beamed me-2 text-success"></i><div class="fw-semibold">{% trans "Música en Vivo" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="good_for_groups" data-label="{% trans 'Para Grupos' %}"><i class="bi bi-people me-2 text-success"></i><div class="fw-semibold">{% trans "Para Grupos" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="good_for_children" data-label="{% trans 'Para Niños' %}"><i class="bi bi-emoji-smile me-2 text-success"></i><div class="fw-semibold">{% trans "Para Niños" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  
                  <li><hr class="dropdown-divider"></li>
                  
                  <!-- Especialidades -->
                  <li class="dropdown-header"><i class="bi bi-cup-straw me-2 text-info"></i>{% trans "Especialidades" %}</li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="serves_cocktails" data-label="{% trans 'Cócteles' %}"><i class="bi bi-cup-straw me-2 text-success"></i><div class="fw-semibold">{% trans "Cócteles" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="serves_wine" data-label="{% trans 'Vinos' %}"><i class="bi bi-cup me-2 text-success"></i><div class="fw-semibold">{% trans "Vinos" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="serves_coffee" data-label="{% trans 'Café Especialidad' %}"><i class="bi bi-cup-hot me-2 text-success"></i><div class="fw-semibold">{% trans "Café Especialidad" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="serves_dessert" data-label="{% trans 'Postres' %}"><i class="bi bi-cake me-2 text-success"></i><div class="fw-semibold">{% trans "Postres" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  
                  <li><hr class="dropdown-divider"></li>
                  
                  <!-- Accesibilidad & Comodidades -->
                  <li class="dropdown-header"><i class="bi bi-universal-access me-2 text-secondary"></i>{% trans "Accesibilidad & Comodidades" %}</li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="wheelchair_accessible_entrance" data-label="{% trans 'Acceso Accesible' %}"><i class="bi bi-universal-access me-2 text-success"></i><div class="fw-semibold">{% trans "Acceso Accesible" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="allows_dogs" data-label="{% trans 'Pet Friendly' %}"><i class="bi bi-heart me-2 text-danger"></i><div class="fw-semibold">{% trans "Pet Friendly" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="accepts_credit_cards" data-label="{% trans 'Tarjetas de Crédito' %}"><i class="bi bi-credit-card me-2 text-success"></i><div class="fw-semibold">{% trans "Tarjetas de Crédito" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                </ul>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Card Inferior: Grid de Lugares -->
      <div class="places-grid-card">
        {% if lugares %}
          <div class="lugares-grid">
            {% for lugar in lugares %}
              <div class="lugar-card-wrapper">
                <div class="card h-100 shadow-sm border-0 rounded-4 place-card">
                  <div class="place-card-media position-relative">
                    {% if lugar.get_primera_foto %}
                      <img src="{{ lugar.get_primera_foto.imagen }}" 
                           class="card-img-top rounded-top-4" 
                           alt="{{ lugar.nombre }}"
                           loading="lazy">
                    {% else %}
                      <div class="place-card-placeholder rounded-top-4 d-flex align-items-center justify-content-center">
                        <i class="bi bi-image text-muted fs-2"></i>
                      </div>
                    {% endif %}
                    {% if lugar.rating %}
                      <div class="place-card-rating badge rounded-pill">
                        <i class="bi bi-star-fill me-1"></i>
                        <span class="fw-semibold">{{ lugar.rating|floatformat:1 }}</span>
                      </div>
                    {% endif %}
                  </div>

                  <div class="card-body d-flex flex-column place-card-body">
                    <h5 class="card-title fw-semibold mb-2 place-card-title">{{ lugar.nombre }}</h5>
                    
                    <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                      <span class="badge place-type-pill">
                        <i class="bi bi-geo-alt me-1"></i>{{ lugar|place_type_label }}
                      </span>
                      {% if lugar.es_destacado %}
                        <span class="badge place-flag-pill place-flag-featured">
                          <i class="bi bi-star-fill me-1"></i>{% trans "Destacado" %}
                        </span>
                      {% endif %}
                      {% if lugar.es_exclusivo %}
                        <span class="badge place-flag-pill place-flag-exclusive">
                          <i class="bi bi-gem me-1"></i>{% trans "Exclusivo" %}
                        </span>
                      {% endif %}
                    </div>

                    {% if lugar.precio %}
                      <div class="small text-muted mb-2">
                        <i class="bi bi-cash-stack me-1"></i>{{ lugar.precio|format_price_range }}
                      </div>
                    {% endif %}

                    {% if lugar.direccion %}
                      <div class="small text-muted mb-2 place-card-address">
                        <i class="bi bi-map me-1"></i>{{ lugar.direccion|truncatechars:50 }}
                      </div>
                    {% endif %}

                    {% if lugar.slug %}
                      <a href="{% url 'explorer:lugares_detail' lugar.slug %}" class="btn mt-auto w-100 rounded-pill place-card-cta">
                        <i class="bi bi-eye me-1"></i>{% trans "Ver detalles" %}
                      </a>
                    {% endif %}
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>

          <!-- Paginación -->
          {% if is_paginated %}
            <nav class="mt-5 d-flex justify-content-center">
              <ul class="pagination">
                {% if page_obj.has_previous %}
                  <li class="page-item">
                    <a class="page-link rounded-pill me-2" href="?page={{ page_obj.previous_page_number }}{% if filtros_url %}&{{ filtros_url }}{% endif %}">
                      <i class="bi bi-chevron-left me-1"></i>{% trans "Anterior" %}
                    </a>
                  </li>
                {% endif %}

                <li class="page-item disabled">
                  <span class="page-link border-0 bg-transparent text-muted">
                    {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
                  </span>
                </li>

                {% if page_obj.has_next %}
                  <li class="page-item">
                    <a class="page-link rounded-pill ms-2" href="?page={{ page_obj.next_page_number }}{% if filtros_url %}&{{ filtros_url }}{% endif %}">
                      {% trans "Siguiente" %}<i class="bi bi-chevron-right ms-1"></i>
                    </a>
                  </li>
                {% endif %}
              </ul>
            </nav>
          {% endif %}

        {% else %}
          <div class="text-center py-5">
            <i class="bi bi-search display-1 mb-3 text-white-50"></i>
            <h3 class="text-white">{% trans "No hay lugares disponibles" %}</h3>
            <p class="text-white-50">{% trans "No se encontraron lugares que coincidan con tu búsqueda." %}</p>
            <a href="{% url 'explorer:lugares_list' %}" class="btn btn-gradient-green rounded-pill px-4">
              {% trans "Ver todos los lugares" %}
            </a>
          </div>
        {% endif %}
      </div>

    </div>
  </div>
</section>
{% endblock %}

{% block extra_css %}
<style>
/* ═══════════════════════════════════════════════════════════════════
   PLACES LIST - Professional Design
   Diseño profesional, simétrico y bien distribuido
   ═══════════════════════════════════════════════════════════════════ */

.places-section {
  background:
    radial-gradient(circle at top, rgba(17, 153, 142, 0.25) 0%, transparent 50%),
    linear-gradient(135deg, #020617 0%, #022c22 35%, #064e3b 100%);
  min-height: 100vh;
  padding: 2.5rem 0 3.5rem;
}

.places-section .container { 
  max-width: 1280px;
}

.places-main-wrapper { 
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 1.5rem;
}

@media (min-width: 992px) {
  .places-main-wrapper {
    padding: 0 2rem;
  }
}

/* Card Superior */
.places-header-card {
  background: rgba(4, 20, 12, 0.95);
  border-radius: 28px;
  padding: 2.5rem 2rem;
  box-shadow: 0 24px 60px rgba(0, 0, 0, 0.6);
  border: 1px solid rgba(255, 255, 255, 0.12);
  position: relative;
  z-index: 10;
  margin-bottom: 2.5rem;
}

@media (min-width: 992px) {
  .places-header-card { 
    padding: 3rem 2.5rem;
  }
}

/* Título principal con vida */
.places-title {
  font-size: 2.25rem;
  line-height: 1.3;
  letter-spacing: -0.02em;
  margin-bottom: 1rem;
  font-weight: 800;
  color: #ffffff;
  text-shadow: 
    0 0 20px rgba(56, 239, 125, 0.4),
    0 2px 4px rgba(0, 0, 0, 0.5);
  position: relative;
}

.places-title::after {
  content: '';
  position: absolute;
  bottom: -12px;
  left: 50%;
  transform: translateX(-50%);
  width: 80px;
  height: 4px;
  background: linear-gradient(90deg, transparent, #11998e, #38ef7d, transparent);
  border-radius: 2px;
  box-shadow: 0 0 12px rgba(56, 239, 125, 0.6);
}

.title-main {
  background: linear-gradient(135deg, #ffffff 0%, #38ef7d 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

@media (min-width: 768px) {
  .places-title { 
    font-size: 2.5rem;
  }
}

@media (min-width: 992px) {
  .places-title { 
    font-size: 3rem;
  }
}

.text-white-50 { 
  color: rgba(255, 255, 255, 0.75) !important;
  font-size: 1.0625rem;
  line-height: 1.6;
}

/* Filtros */
.filtros-home-style {
  background: rgba(3, 30, 20, 0.95);
  border-radius: 24px;
  padding: 2rem 1.75rem;
  border: 1px solid rgba(255, 255, 255, 0.12);
  position: relative;
  z-index: 100;
  margin-top: 2rem;
}

@media (min-width: 992px) {
  .filtros-home-style {
    padding: 2.25rem 2rem;
  }
}

/* Botones Dropdown */
.btn-filtro-dropdown {
  background: rgba(255, 255, 255, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: white !important;
  font-size: 1rem;
  font-weight: 600;
  padding: 0.875rem 1.75rem;
  border-radius: 999px;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.5rem;
}

.btn-filtro-dropdown:hover {
  background: rgba(255, 255, 255, 0.25);
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
  color: white !important;
  border-color: rgba(255, 255, 255, 0.5);
}

.btn-filtro-dropdown:focus {
  box-shadow: 0 0 0 0.25rem rgba(255, 255, 255, 0.25);
  color: white !important;
}

/* Dropdown Menus */
.dropdown-menu-filtros {
  border-radius: 18px;
  padding: 1rem;
  margin-top: 0.625rem;
  min-width: 300px;
  max-width: 380px;
  background: white;
  border: none;
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
  max-height: 400px;
  overflow-y: auto;
  z-index: 1050 !important;
  position: absolute !important;
}

.dropdown-menu-filtros::-webkit-scrollbar { 
  width: 8px;
}

.dropdown-menu-filtros::-webkit-scrollbar-track { 
  background: rgba(0, 0, 0, 0.05);
  border-radius: 4px;
  margin: 0.5rem 0;
}

.dropdown-menu-filtros::-webkit-scrollbar-thumb { 
  background: rgba(17, 153, 142, 0.3);
  border-radius: 4px;
}

.dropdown-menu-filtros::-webkit-scrollbar-thumb:hover { 
  background: rgba(17, 153, 142, 0.6);
}

.dropdown-item-filtro {
  padding: 0.75rem 0.875rem;
  border-radius: 12px;
  display: flex;
  align-items: center;
  transition: all 0.2s ease;
  text-decoration: none;
  color: #1e293b;
  gap: 0.625rem;
  font-size: 0.9375rem;
}

.dropdown-item-filtro:hover {
  background-color: rgba(17, 153, 142, 0.1);
  transform: translateX(3px);
  color: #11998e;
}

.dropdown-item-filtro i {
  font-size: 1.125rem;
  width: 24px;
  text-align: center;
  flex-shrink: 0;
}

.dropdown-header {
  color: #495057;
  font-weight: 700;
  font-size: 0.8125rem;
  padding: 0.625rem 0.875rem 0.375rem;
  margin-top: 0.625rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.dropdown-header:first-child { 
  margin-top: 0;
}

/* Asegurar que los dropdowns siempre estén visibles sobre todo */
.filtros-home-style .dropdown {
  position: relative;
}

.dropdown-menu.show {
  z-index: 1050 !important;
}

/* Card Inferior: Grid de Lugares */
.places-grid-card {
  background: rgba(4, 20, 12, 0.95);
  border-radius: 28px;
  padding: 2rem 1.75rem;
  box-shadow: 0 24px 60px rgba(0, 0, 0, 0.6);
  border: 1px solid rgba(255, 255, 255, 0.12);
  position: relative;
  z-index: 1;
}

@media (min-width: 992px) {
  .places-grid-card { 
    padding: 2.5rem 2rem;
  }
}

/* Grid de lugares */
.lugares-grid {
  display: flex;
  flex-direction: column;
  gap: 1.75rem;
}

@media (min-width: 992px) {
  .lugares-grid {
    gap: 2rem;
  }
}

.lugar-card-wrapper { 
  width: 100%;
}

/* Place Cards */
.place-card {
  background: #ffffff;
  border-radius: 24px !important;
  border: 2px solid rgba(17, 153, 142, 0.2) !important;
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
  transition: all 0.3s ease;
  overflow: hidden;
}

.place-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 16px 40px rgba(17, 153, 142, 0.3) !important;
  border-color: rgba(17, 153, 142, 0.5) !important;
}

@media (min-width: 992px) {
  .place-card {
    display: grid;
    grid-template-columns: 320px minmax(0, 1fr);
    align-items: center;
  }
  
  .place-card-media img,
  .place-card-placeholder {
    height: 100%;
    min-height: 220px;
    max-height: 240px;
    border-radius: 1.5rem 0 0 1.5rem !important;
  }
  
  .place-card-media { 
    height: 100%;
  }
  
  .place-card-body { 
    padding: 2rem 2.25rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
}

.place-card-media img {
  height: 220px;
  object-fit: cover;
  width: 100%;
}

@media (min-width: 768px) {
  .place-card-media img {
    height: 240px;
  }
}

.place-card-placeholder {
  height: 220px;
  background: linear-gradient(135deg, rgba(17, 153, 142, 0.1) 0%, rgba(56, 239, 125, 0.05) 100%);
  display: flex;
  align-items: center;
  justify-content: center;
}

@media (min-width: 768px) {
  .place-card-placeholder {
    height: 240px;
  }
}

.place-card-placeholder i {
  font-size: 3rem;
  color: rgba(17, 153, 142, 0.3);
}

.place-card-rating {
  position: absolute;
  right: 1rem;
  bottom: 1rem;
  background: #ffffff;
  color: #11998e;
  font-size: 0.875rem;
  padding: 0.5rem 0.875rem;
  box-shadow: 0 4px 12px rgba(17, 153, 142, 0.3);
  border: 1px solid rgba(17, 153, 142, 0.2);
  border-radius: 999px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 0.375rem;
}

.place-card-body { 
  padding: 1.5rem;
}

.place-card-title {
  color: #0f172a;
  font-weight: 700;
  font-size: 1.25rem;
  line-height: 1.3;
  margin-bottom: 0.875rem;
  letter-spacing: -0.01em;
}

@media (min-width: 992px) {
  .place-card-title {
    font-size: 1.375rem;
  }
}

.place-type-pill {
  background: rgba(17, 153, 142, 0.1);
  border-radius: 999px;
  color: #11998e;
  border: 1px solid rgba(17, 153, 142, 0.3);
  font-size: 0.8125rem;
  font-weight: 600;
  padding: 0.375rem 0.75rem;
}

.place-flag-pill {
  border-radius: 999px;
  font-size: 0.8125rem;
  font-weight: 600;
  padding: 0.375rem 0.75rem;
}

.place-flag-featured {
  background: rgba(250, 204, 21, 0.15);
  color: #ca8a04;
  border: 1px solid rgba(250, 204, 21, 0.4);
}

.place-flag-exclusive {
  background: rgba(17, 153, 142, 0.15);
  color: #11998e;
  border: 1px solid rgba(17, 153, 142, 0.4);
}

.place-card-address { 
  color: #64748b !important;
  font-size: 0.9375rem;
}

.place-card-cta {
  font-weight: 600;
  font-size: 0.9375rem;
  background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
  border: none;
  color: white;
  transition: all 0.3s ease;
  padding: 0.75rem 1.5rem;
  border-radius: 999px;
}

.place-card-cta:hover {
  background: linear-gradient(135deg, #0e8678 0%, #32d86a 100%);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(17, 153, 142, 0.4);
  color: white;
}

/* Navegación superior */
.home-lang-switch .btn-lang-home {
  border-radius: 999px;
  padding: 0.35rem 0.9rem;
  font-size: 0.85rem;
  font-weight: 700;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  border: 1px solid rgba(255, 255, 255, 0.35);
  background: rgba(0, 0, 0, 0.25);
  color: rgba(255, 255, 255, 0.85);
  box-shadow: 0 4px 14px rgba(0, 0, 0, 0.35);
}

.home-lang-switch .btn-lang-home.active {
  background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
  border-color: transparent;
  color: #03120a;
}

.home-lang-switch .btn-lang-home.inactive:hover {
  background: rgba(255, 255, 255, 0.18);
}

/* Paginación */
.pagination .page-link {
  border: 1px solid rgba(17, 153, 142, 0.3);
  color: #11998e;
  font-weight: 500;
  background: white;
}

.pagination .page-link:hover {
  background: linear-gradient(135deg, rgba(17, 153, 142, 0.1) 0%, rgba(56, 239, 125, 0.05) 100%);
  border-color: rgba(17, 153, 142, 0.5);
  color: #0e8678;
}

/* Botón verde */
.btn-gradient-green {
  background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
  border: none;
  color: white;
  font-weight: 600;
}

.btn-gradient-green:hover {
  background: linear-gradient(135deg, #0e8678 0%, #32d86a 100%);
  color: white;
}

/* Mobile */
@media (max-width: 991px) {
  .places-section { 
    padding: 1.75rem 0 2.5rem;
  }
  
  .places-main-wrapper {
    padding: 0 1rem;
  }
  
  .places-header-card { 
    padding: 1.75rem 1.25rem;
    margin-bottom: 2rem;
    border-radius: 20px;
  }
  
  .places-title {
    font-size: 1.875rem;
    margin-bottom: 0.625rem;
  }
  
  .text-white-50 {
    font-size: 1rem;
  }
  
  .filtros-home-style { 
    padding: 1.5rem 1.25rem;
    margin-top: 1.5rem;
    border-radius: 20px;
  }
  
  .btn-filtro-dropdown { 
    padding: 0.75rem 1.25rem;
    font-size: 0.9375rem;
  }
  
  .dropdown-menu-filtros { 
    min-width: 280px;
    max-height: 320px;
  }
  
  .places-grid-card {
    padding: 1.5rem 1.25rem;
    border-radius: 20px;
  }
  
  .lugares-grid {
    gap: 1.5rem;
  }
  
  .place-card {
    border-radius: 20px !important;
  }
  
  .place-card-media img,
  .place-card-placeholder {
    height: 200px;
  }
  
  .place-card-body {
    padding: 1.25rem;
  }
  
  .place-card-title {
    font-size: 1.125rem;
  }
  
  .place-card-rating {
    right: 0.875rem;
    bottom: 0.875rem;
    padding: 0.4rem 0.75rem;
    font-size: 0.8125rem;
  }
}

/* Estado seleccionado para dropdowns */
.btn-filtro-dropdown.selected {
  background: rgba(17, 153, 142, 0.35) !important;
  border-color: rgba(17, 153, 142, 0.6) !important;
}

/* Check en características seleccionadas */
.feature-option.active {
  background: rgba(17, 153, 142, 0.1);
}

.feature-option.active .feature-check {
  display: inline-block !important;
  color: #11998e;
}

/* Loading overlay */
.places-grid-card.loading {
  opacity: 0.5;
  pointer-events: none;
}

.loading-overlay {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 10;
}

/* Animación para nuevos resultados */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.lugar-card-wrapper.animate {
  animation: fadeInUp 0.3s ease forwards;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // ═══════════════════════════════════════════════════════════════
    // FILTRADO DINÁMICO PROFESIONAL
    // ═══════════════════════════════════════════════════════════════
    
    // Estado inicial de filtros (desde el servidor)
    const filtros = {
        area: '{{ region_actual.slug|default:"" }}',
        areaName: '{{ region_actual.name|default:"" }}',
        tipo: '{{ tipo_actual|default:"" }}',
        tipoLabel: '{{ tipo_actual_label|default:"" }}',
        caracteristicas: {},
        pagina: 1
    };
    
    // Textos traducidos
    const T = {
        selectArea: '{% trans "Seleccionar Área" %}',
        selectType: '{% trans "Seleccionar Tipo" %}',
        features: '{% trans "Características" %}',
        loading: '{% trans "Cargando..." %}',
        noResults: '{% trans "No hay lugares disponibles" %}',
        noResultsMsg: '{% trans "No se encontraron lugares que coincidan con tu búsqueda." %}',
        viewAll: '{% trans "Ver todos los lugares" %}',
        viewDetails: '{% trans "Ver detalles" %}',
        featured: '{% trans "Destacado" %}',
        exclusive: '{% trans "Exclusivo" %}',
        prev: '{% trans "Anterior" %}',
        next: '{% trans "Siguiente" %}'
    };
    
    // Parsear características iniciales desde URL
    const urlParams = new URLSearchParams(window.location.search);
    const featureKeys = ['delivery', 'takeout', 'dine_in', 'outdoor_seating', 'live_music',
        'good_for_groups', 'good_for_children', 'serves_cocktails', 'serves_wine',
        'serves_coffee', 'serves_dessert', 'wheelchair_accessible_entrance',
        'allows_dogs', 'accepts_credit_cards', 'reservable'];
    
    featureKeys.forEach(key => {
        if (urlParams.get(key) === 'true') {
            filtros.caracteristicas[key] = true;
            $(`.feature-option[data-feature="${key}"]`).addClass('active')
                .find('.feature-check').show();
        }
    });
    updateFeaturesCount();
    
    // Control de búsqueda
    let searchTimeout = null;
    let currentRequest = null;
    const DEBOUNCE_MS = 400;
    
    // ─────────────────────────────────────────────────────────────
    // EVENT: Selección de Área
    // ─────────────────────────────────────────────────────────────
    $(document).on('click', '.area-option', function(e) {
        e.preventDefault();
        filtros.area = $(this).data('area-slug') || '';
        filtros.areaName = $(this).data('area-name') || '';
        filtros.pagina = 1;
        
        // Actualizar UI
        $('#area-label').text(filtros.area ? filtros.areaName : T.selectArea);
        $('#areasDropdown').toggleClass('selected', !!filtros.area);
        $('#areasDropdown').dropdown('hide');
        
        ejecutarBusqueda();
    });
    
    // ─────────────────────────────────────────────────────────────
    // EVENT: Selección de Tipo
    // ─────────────────────────────────────────────────────────────
    $(document).on('click', '.tipo-option', function(e) {
        e.preventDefault();
        filtros.tipo = $(this).data('tipo-code') || '';
        filtros.tipoLabel = $(this).data('tipo-label') || '';
        filtros.pagina = 1;
        
        // Actualizar UI
        $('#tipo-label-btn').text(filtros.tipo ? filtros.tipoLabel : T.selectType);
        $('#tiposDropdown').toggleClass('selected', !!filtros.tipo);
        $('#tiposDropdown').dropdown('hide');
        
        ejecutarBusqueda();
    });
    
    // ─────────────────────────────────────────────────────────────
    // EVENT: Toggle de Característica
    // ─────────────────────────────────────────────────────────────
    $(document).on('click', '.feature-option', function(e) {
        e.preventDefault();
        e.stopPropagation(); // No cerrar el dropdown
        
        const feature = $(this).data('feature');
        const isActive = $(this).hasClass('active');
        
        if (isActive) {
            $(this).removeClass('active').find('.feature-check').hide();
            delete filtros.caracteristicas[feature];
        } else {
            $(this).addClass('active').find('.feature-check').show();
            filtros.caracteristicas[feature] = true;
        }
        
        filtros.pagina = 1;
        updateFeaturesCount();
        programarBusqueda();
    });
    
    // ─────────────────────────────────────────────────────────────
    // EVENT: Limpiar Características
    // ─────────────────────────────────────────────────────────────
    $(document).on('click', '.feature-clear', function(e) {
        e.preventDefault();
        filtros.caracteristicas = {};
        filtros.pagina = 1;
        
        $('.feature-option').removeClass('active').find('.feature-check').hide();
        updateFeaturesCount();
        $('#featuresDropdown').dropdown('hide');
        
        ejecutarBusqueda();
    });
    
    // ─────────────────────────────────────────────────────────────
    // HELPERS
    // ─────────────────────────────────────────────────────────────
    function updateFeaturesCount() {
        const count = Object.keys(filtros.caracteristicas).length;
        const $count = $('#features-count');
        const $btn = $('#featuresDropdown');
        
        if (count > 0) {
            $count.text(count).show();
            $btn.addClass('selected');
        } else {
            $count.hide();
            $btn.removeClass('selected');
        }
    }
    
    function programarBusqueda() {
        if (searchTimeout) clearTimeout(searchTimeout);
        searchTimeout = setTimeout(ejecutarBusqueda, DEBOUNCE_MS);
    }
    
    function ejecutarBusqueda() {
        if (searchTimeout) clearTimeout(searchTimeout);
        if (currentRequest) currentRequest.abort();
        
        // Mostrar loading
        $('.places-grid-card').addClass('loading');
        
        // Construir parámetros
        const params = new URLSearchParams();
        if (filtros.area) params.append('area', filtros.area);
        if (filtros.tipo) params.append('tipo', filtros.tipo);
        if (filtros.pagina > 1) params.append('page', filtros.pagina);
        
        Object.keys(filtros.caracteristicas).forEach(key => {
            params.append(key, 'true');
        });
        
        // Actualizar URL sin recargar (History API)
        const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        window.history.pushState({filtros: filtros}, '', newUrl);
        
        // Petición AJAX
        currentRequest = $.ajax({
            url: '{% url "explorer:places_filter_ajax" %}',
            type: 'GET',
            data: params.toString(),
            success: function(response) {
                $('.places-grid-card').removeClass('loading');
                if (response.success) {
                    renderizarResultados(response);
                    actualizarTitulo(response);
                }
            },
            error: function(xhr, status, error) {
                if (status === 'abort') return;
                $('.places-grid-card').removeClass('loading');
                console.error('Error:', error);
            }
        });
    }
    
    function renderizarResultados(data) {
        const $grid = $('.lugares-grid');
        const $container = $('.places-grid-card');
        
        if (data.lugares.length === 0) {
            $container.html(`
                <div class="text-center py-5">
                    <i class="bi bi-search display-1 mb-3 text-white-50"></i>
                    <h3 class="text-white">${T.noResults}</h3>
                    <p class="text-white-50">${data.mensaje || T.noResultsMsg}</p>
                    <a href="{% url 'explorer:lugares_list' %}" class="btn btn-gradient-green rounded-pill px-4">
                        ${T.viewAll}
                    </a>
                </div>
            `);
            return;
        }
        
        // Generar HTML de cards
        let html = '<div class="lugares-grid">';
        data.lugares.forEach((lugar, i) => {
            html += generarCardHtml(lugar, i);
        });
        html += '</div>';
        
        // Agregar paginación si existe
        if (data.paginacion && data.paginacion.total_paginas > 1) {
            html += generarPaginacionHtml(data.paginacion);
        }
        
        $container.html(html);
        
        // Animar cards
        $('.lugar-card-wrapper').each(function(i) {
            $(this).css('animation-delay', (i * 0.05) + 's').addClass('animate');
        });
    }
    
    function generarCardHtml(lugar, index) {
        const rating = lugar.rating ? `
            <div class="place-card-rating badge rounded-pill">
                <i class="bi bi-star-fill me-1"></i>
                <span class="fw-semibold">${lugar.rating.toFixed(1)}</span>
            </div>` : '';
        
        const imagen = lugar.imagen 
            ? `<img src="${lugar.imagen}" class="card-img-top rounded-top-4" alt="${lugar.nombre}" loading="lazy">`
            : `<div class="place-card-placeholder rounded-top-4 d-flex align-items-center justify-content-center">
                 <i class="bi bi-image text-muted fs-2"></i>
               </div>`;
        
        const badges = [];
        badges.push(`<span class="badge place-type-pill"><i class="bi bi-geo-alt me-1"></i>${lugar.tipo}</span>`);
        if (lugar.es_destacado) {
            badges.push(`<span class="badge place-flag-pill place-flag-featured"><i class="bi bi-star-fill me-1"></i>${T.featured}</span>`);
        }
        if (lugar.es_exclusivo) {
            badges.push(`<span class="badge place-flag-pill place-flag-exclusive"><i class="bi bi-gem me-1"></i>${T.exclusive}</span>`);
        }
        
        const direccion = lugar.direccion 
            ? `<div class="small text-muted mb-2 place-card-address"><i class="bi bi-map me-1"></i>${lugar.direccion.substring(0, 50)}...</div>` 
            : '';
        
        const cta = lugar.url 
            ? `<a href="${lugar.url}" class="btn mt-auto w-100 rounded-pill place-card-cta"><i class="bi bi-eye me-1"></i>${T.viewDetails}</a>`
            : '';
        
        return `
            <div class="lugar-card-wrapper">
                <div class="card h-100 shadow-sm border-0 rounded-4 place-card">
                    <div class="place-card-media position-relative">
                        ${imagen}
                        ${rating}
                    </div>
                    <div class="card-body d-flex flex-column place-card-body">
                        <h5 class="card-title fw-semibold mb-2 place-card-title">${lugar.nombre}</h5>
                        <div class="d-flex flex-wrap align-items-center gap-2 mb-2">${badges.join('')}</div>
                        ${direccion}
                        ${cta}
                    </div>
                </div>
            </div>
        `;
    }
    
    function generarPaginacionHtml(pag) {
        let html = '<nav class="mt-5 d-flex justify-content-center"><ul class="pagination">';
        
        if (pag.tiene_anterior) {
            html += `<li class="page-item">
                <a class="page-link rounded-pill me-2 pagination-link" href="javascript:void(0)" data-page="${pag.pagina_anterior}">
                    <i class="bi bi-chevron-left me-1"></i>${T.prev}
                </a>
            </li>`;
        }
        
        html += `<li class="page-item disabled">
            <span class="page-link border-0 bg-transparent text-muted">
                ${pag.pagina_actual} / ${pag.total_paginas}
            </span>
        </li>`;
        
        if (pag.tiene_siguiente) {
            html += `<li class="page-item">
                <a class="page-link rounded-pill ms-2 pagination-link" href="javascript:void(0)" data-page="${pag.pagina_siguiente}">
                    ${T.next}<i class="bi bi-chevron-right ms-1"></i>
                </a>
            </li>`;
        }
        
        html += '</ul></nav>';
        return html;
    }
    
    function actualizarTitulo(data) {
        // Actualizar subtítulo con el mensaje del backend
        $('.places-header-card .lead').text(data.mensaje);
    }
    
    // ─────────────────────────────────────────────────────────────
    // EVENT: Paginación
    // ─────────────────────────────────────────────────────────────
    $(document).on('click', '.pagination-link', function(e) {
        e.preventDefault();
        filtros.pagina = $(this).data('page');
        ejecutarBusqueda();
        
        // Scroll al inicio de resultados
        $('html, body').animate({
            scrollTop: $('.places-grid-card').offset().top - 100
        }, 400);
    });
    
    // ─────────────────────────────────────────────────────────────
    // HISTORY: Manejar navegación hacia atrás/adelante
    // ─────────────────────────────────────────────────────────────
    window.addEventListener('popstate', function(e) {
        if (e.state && e.state.filtros) {
            Object.assign(filtros, e.state.filtros);
            sincronizarUI();
            ejecutarBusqueda();
        }
    });
    
    function sincronizarUI() {
        // Área
        $('#area-label').text(filtros.area ? filtros.areaName : T.selectArea);
        $('#areasDropdown').toggleClass('selected', !!filtros.area);
        
        // Tipo
        $('#tipo-label-btn').text(filtros.tipo ? filtros.tipoLabel : T.selectType);
        $('#tiposDropdown').toggleClass('selected', !!filtros.tipo);
        
        // Características
        $('.feature-option').each(function() {
            const feature = $(this).data('feature');
            if (filtros.caracteristicas[feature]) {
                $(this).addClass('active').find('.feature-check').show();
            } else {
                $(this).removeClass('active').find('.feature-check').hide();
            }
        });
        updateFeaturesCount();
    }
});
</script>
{% endblock %}
