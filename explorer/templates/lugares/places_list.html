{% extends "base.html" %}
{% load i18n %}
{% load i18n_extras %}

{% block title %}{{ titulo_pagina }} | {% trans "ViveMedell√≠n" %}{% endblock %}

{% block meta_description %}
  {{ descripcion_pagina }}. {% trans "Encuentra los lugares mejor valorados en ViveMedell√≠n." %}
{% endblock %}

{% block meta_keywords %}
  {% if tipo_actual == 'restaurant' %}
    restaurantes Medell√≠n, mejores restaurantes, gastronom√≠a Medell√≠n, comida paisa
  {% elif tipo_actual == 'bar' %}
    bares Medell√≠n, discotecas Medell√≠n, vida nocturna, rumba Medell√≠n
  {% elif tipo_actual == 'cafe' %}
    cafeter√≠as Medell√≠n, caf√© paisa, cultura cafetera, caf√©s Medell√≠n
  {% else %}
    lugares Medell√≠n, bares Medell√≠n, restaurantes Medell√≠n, sitios para salir en Medell√≠n
  {% endif %}
{% endblock %}

{% block og_title %}
  {{ titulo_pagina }} | ViveMedell√≠n
{% endblock %}

{% block og_description %}
  {{ descripcion_pagina }}. {% trans "Descubre lugares con calificaciones reales en Medell√≠n." %}
{% endblock %}

{% block og_image %}
  {{ request.build_absolute_uri }}static/img/og-image.jpg
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="text-center mb-5">
    {% if tipo_actual %}
      <div class="mb-3">
        {% if tipo_actual == 'restaurant' %}
          <i class="bi bi-cup-hot text-success fs-1"></i>
        {% elif tipo_actual == 'bar' %}
          <i class="bi bi-cup-straw text-warning fs-1"></i>
        {% elif tipo_actual == 'cafe' %}
          <i class="bi bi-cup text-info fs-1"></i>
        {% else %}
          <i class="bi bi-grid-3x3-gap text-primary fs-1"></i>
        {% endif %}
      </div>
    {% endif %}
    <h1 class="fw-bold">{{ titulo_pagina }}</h1>
    <p class="lead text-muted">{{ descripcion_pagina }}</p>
    
    {% if busqueda_actual %}
      <div class="mt-3">
        <span class="badge bg-primary bg-opacity-10 text-primary fs-6 px-3 py-2">
          <i class="bi bi-search me-1"></i>{% trans "B√∫squeda" %}: "{{ busqueda_actual }}"
        </span>
      </div>
    {% endif %}
  </div>

  <!-- Filtros de la Lista -->
  <div class="container mb-5">
    <div class="card shadow border-0 rounded-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);">
      <div class="card-body" style="background: rgba(255, 255, 255, 0.1); border-radius: 16px; backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);">
        <div class="row g-3">
          <div class="col-md-3">
            <label class="form-label small text-white fw-semibold">
              <i class="bi bi-geo-alt me-1 text-white"></i>{% trans "√Årea" %}
            </label>
                         <select class="form-select form-select-sm rounded-pill" id="filtro-comuna" name="comuna">
               <option value="">{% trans "Todas las √°reas" %}</option>
               {% for region in regiones_filtro %}
                 <option value="{{ region.osm_id }}" 
                         data-slug="{{ region.slug }}"
                         {% if request.GET.comuna == region.osm_id|stringformat:'s' or region_actual.osm_id == region.osm_id %}selected{% endif %}>
                   {{ region.name }}
                 </option>
               {% endfor %}
             </select>
          </div>
          
          <div class="col-md-3">
            <label class="form-label small text-white fw-semibold">
              <i class="bi bi-grid-3x3-gap me-1 text-white"></i>{% trans "Tipo" %}
            </label>
            <select class="form-select form-select-sm rounded-pill" id="filtro-tipo" name="tipo">
              <option value="">{% trans "Todos los tipos" %}</option>
              <optgroup label="üçΩÔ∏è {% trans "Restaurantes" %}">
                <option value="restaurant" {% if tipo_actual == 'restaurant' %}selected{% endif %}>{% trans "Restaurante General" %}</option>
                <option value="fine_dining_restaurant" {% if tipo_actual == 'fine_dining_restaurant' %}selected{% endif %}>{% trans "Restaurante Gourmet" %}</option>
                <option value="pizza_restaurant" {% if tipo_actual == 'pizza_restaurant' %}selected{% endif %}>{% trans "Pizzer√≠a" %}</option>
                <option value="italian_restaurant" {% if tipo_actual == 'italian_restaurant' %}selected{% endif %}>{% trans "Restaurante Italiano" %}</option>
                <option value="mexican_restaurant" {% if tipo_actual == 'mexican_restaurant' %}selected{% endif %}>{% trans "Restaurante Mexicano" %}</option>
                <option value="chinese_restaurant" {% if tipo_actual == 'chinese_restaurant' %}selected{% endif %}>{% trans "Restaurante Chino" %}</option>
                <option value="seafood_restaurant" {% if tipo_actual == 'seafood_restaurant' %}selected{% endif %}>{% trans "Marisquer√≠a" %}</option>
                <option value="steak_house" {% if tipo_actual == 'steak_house' %}selected{% endif %}>{% trans "Parrilla de Carnes" %}</option>
                <option value="fast_food_restaurant" {% if tipo_actual == 'fast_food_restaurant' %}selected{% endif %}>{% trans "Comida R√°pida" %}</option>
              </optgroup>
              <optgroup label="üçª {% trans "Bares & Vida Nocturna" %}">
                <option value="bar" {% if tipo_actual == 'bar' %}selected{% endif %}>{% trans "Bar" %}</option>
                <option value="wine_bar" {% if tipo_actual == 'wine_bar' %}selected{% endif %}>{% trans "Bar de Vinos" %}</option>
                <option value="pub" {% if tipo_actual == 'pub' %}selected{% endif %}>{% trans "Pub" %}</option>
                <option value="night_club" {% if tipo_actual == 'night_club' %}selected{% endif %}>{% trans "Discoteca" %}</option>
                <option value="karaoke" {% if tipo_actual == 'karaoke' %}selected{% endif %}>{% trans "Karaoke" %}</option>
              </optgroup>
              <optgroup label="‚òï {% trans "Cafeter√≠as" %}">
                <option value="cafe" {% if tipo_actual == 'cafe' %}selected{% endif %}>{% trans "Cafeter√≠a" %}</option>
                <option value="internet_cafe" {% if tipo_actual == 'internet_cafe' %}selected{% endif %}>{% trans "Cibercaf√©" %}</option>
                <option value="breakfast_restaurant" {% if tipo_actual == 'breakfast_restaurant' %}selected{% endif %}>{% trans "Desayunos" %}</option>
                <option value="brunch" {% if tipo_actual == 'brunch' %}selected{% endif %}>{% trans "Brunch" %}</option>
              </optgroup>
            </select>
          </div>
          
          <div class="col-md-3">
            <label class="form-label small text-white fw-semibold">
              <i class="bi bi-stars me-1 text-white"></i>{% trans "Caracter√≠sticas" %}
            </label>
            <select class="form-select form-select-sm rounded-pill" id="filtro-caracteristicas" name="caracteristicas">
              <option value="">{% trans "Sin filtro especial" %}</option>
              <optgroup label="üöö {% trans "Servicios de Entrega" %}">
                <option value="delivery" {% if request.GET.delivery == 'true' %}selected{% endif %}>{% trans "Delivery" %}</option>
                <option value="takeout" {% if request.GET.takeout == 'true' %}selected{% endif %}>{% trans "Para Llevar" %}</option>
                <option value="dine_in" {% if request.GET.dine_in == 'true' %}selected{% endif %}>{% trans "Comer en Local" %}</option>
              </optgroup>
              <optgroup label="‚≠ê {% trans "Ambiente & Experiencia" %}">
                <option value="outdoor_seating" {% if request.GET.outdoor_seating == 'true' %}selected{% endif %}>{% trans "Terraza" %}</option>
                <option value="live_music" {% if request.GET.live_music == 'true' %}selected{% endif %}>{% trans "M√∫sica en Vivo" %}</option>
                <option value="good_for_groups" {% if request.GET.good_for_groups == 'true' %}selected{% endif %}>{% trans "Para Grupos" %}</option>
                <option value="good_for_children" {% if request.GET.good_for_children == 'true' %}selected{% endif %}>{% trans "Para Ni√±os" %}</option>
              </optgroup>
              <optgroup label="üçπ {% trans "Especialidades" %}">
                <option value="serves_cocktails" {% if request.GET.serves_cocktails == 'true' %}selected{% endif %}>{% trans "C√≥cteles" %}</option>
                <option value="serves_wine" {% if request.GET.serves_wine == 'true' %}selected{% endif %}>{% trans "Vinos" %}</option>
                <option value="serves_coffee" {% if request.GET.serves_coffee == 'true' %}selected{% endif %}>{% trans "Caf√© Especialidad" %}</option>
                <option value="serves_dessert" {% if request.GET.serves_dessert == 'true' %}selected{% endif %}>{% trans "Postres" %}</option>
              </optgroup>
              <optgroup label="‚ôø {% trans "Accesibilidad" %}">
                <option value="wheelchair_accessible_entrance" {% if request.GET.wheelchair_accessible_entrance == 'true' %}selected{% endif %}>{% trans "Acceso Accesible" %}</option>
                <option value="allows_dogs" {% if request.GET.allows_dogs == 'true' %}selected{% endif %}>{% trans "Pet Friendly" %}</option>
                <option value="accepts_credit_cards" {% if request.GET.accepts_credit_cards == 'true' %}selected{% endif %}>{% trans "Tarjetas de Cr√©dito" %}</option>
              </optgroup>
            </select>
          </div>
          
          <div class="col-md-3 d-flex align-items-end">
            <button type="button" class="btn btn-light btn-sm rounded-pill w-100 fw-semibold" id="aplicar-filtros" style="background: rgba(255, 255, 255, 0.9); border: none; color: #667eea;">
              <i class="bi bi-funnel me-1"></i>{% trans "Aplicar Filtros" %}
            </button>
          </div>
        </div>
        
        <!-- Filtros actuales aplicados -->
        <div id="filtros-aplicados" class="mt-3" style="display: none;">
          <div class="d-flex flex-wrap gap-2">
            <span class="small text-white me-2">{% trans "Filtros activos:" %}</span>
            <div id="badges-filtros"></div>
              <button type="button" class="btn btn-link btn-sm p-0 text-decoration-none text-white" id="limpiar-filtros" style="opacity: 0.9;">
                <i class="bi bi-x-circle me-1"></i>{% trans "Limpiar todos" %}
              </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  {% if lugares %}
    <div class="lugares-grid">
      {% for lugar in lugares %}
        <div class="lugar-card-wrapper">
          <div class="card h-100 shadow-sm border-0 rounded-4">
            {% if lugar.get_primera_foto %}
              <img src="{{ lugar.get_primera_foto.imagen }}" 
                   class="card-img-top rounded-top-4" 
                   alt="{% trans "Imagen de" %} {{ lugar.nombre }}"
                   style="height: 200px; object-fit: cover;"
                   loading="lazy">
            {% else %}
              <div class="bg-light d-flex align-items-center justify-content-center rounded-top-4" style="height: 200px;">
                <i class="bi bi-image text-muted fs-2"></i>
              </div>
            {% endif %}

            <div class="card-body d-flex flex-column">
              <h5 class="card-title fw-semibold mb-2">{{ lugar.nombre }}</h5>
              
              <!-- Tipo de lugar -->
              <div class="mb-2">
                <span class="badge bg-primary bg-opacity-10 text-primary rounded-pill">
                  <i class="bi bi-geo-alt me-1"></i>{{ lugar|place_type_label }}
                </span>
              </div>

              <!-- Badges de estado -->
              <div class="mb-3">
                {% if lugar.es_destacado %}
                  <span class="badge bg-warning text-dark me-1">
                    <i class="bi bi-star-fill me-1"></i>{% trans "Destacado" %}
                  </span>
                {% endif %}
                {% if lugar.es_exclusivo %}
                  <span class="badge bg-success me-1">
                    <i class="bi bi-gem me-1"></i>{% trans "Exclusivo" %}
                  </span>
                {% endif %}
                {% if lugar.rating and lugar.rating >= 4.5 %}
                  <span class="badge bg-info text-dark">
                    <i class="bi bi-award me-1"></i>{% trans "Top Valorado" %}
                  </span>
                {% endif %}
              </div>

              <!-- Rating -->
                            {% if lugar.rating %}
                <div class="small text-muted mb-3">
                  <i class="bi bi-star-fill text-warning me-1"></i>
                  <span class="fw-semibold">{{ lugar.rating|floatformat:1 }}</span> / 5
                </div>
              {% endif %}

              {% if lugar.slug %}
                <a href="{% url 'explorer:lugares_detail' lugar.slug %}" class="btn btn-gradient-purple mt-auto w-100 rounded-pill">
                  <i class="bi bi-eye me-1"></i>{% trans "Ver detalles" %}
                </a>
              {% else %}
                <span class="btn btn-outline-secondary disabled mt-auto w-100 rounded-pill">{% trans "Sin detalles" %}</span>
              {% endif %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- Paginaci√≥n -->
    {% if is_paginated %}
      <nav class="mt-5 d-flex justify-content-center">
        <ul class="pagination">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link rounded-pill me-2" href="?page={{ page_obj.previous_page_number }}{% if filtros_url %}&{{ filtros_url }}{% endif %}">
                <i class="bi bi-chevron-left me-1"></i>{% trans "Anterior" %}
              </a>
            </li>
          {% endif %}

          <li class="page-item disabled">
            <span class="page-link border-0 bg-transparent text-muted">
              {% trans "P√°gina" %} {{ page_obj.number }} {% trans "de" %} {{ page_obj.paginator.num_pages }}
            </span>
          </li>

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link rounded-pill ms-2" href="?page={{ page_obj.next_page_number }}{% if filtros_url %}&{{ filtros_url }}{% endif %}">
                {% trans "Siguiente" %}<i class="bi bi-chevron-right ms-1"></i>
              </a>
            </li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}

  {% else %}
    <div class="text-center py-5">
      <i class="bi bi-search display-1 text-muted mb-3"></i>
      <h3 class="text-muted">{% trans "No hay lugares disponibles" %}</h3>
      <p class="text-muted">{% trans "No se encontraron lugares que coincidan con tu b√∫squeda." %}</p>
      <a href="{% url 'explorer:lugares_list' %}" class="btn btn-primary rounded-pill">
        {% trans "Ver todos los lugares" %}
      </a>
    </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Card Hover Effects */
.card:hover {
    transform: translateY(-5px);
    transition: all 0.3s ease;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

/* Pagination styling */
.pagination .page-link {
    border: 1px solid #dee2e6;
    color: #6c757d;
    font-weight: 500;
}

.pagination .page-link:hover {
    background-color: #f8f9fa;
    border-color: #6c757d;
}

/* Estilos para la secci√≥n de filtros con glassmorphism */
#aplicar-filtros:hover {
    background: rgba(255, 255, 255, 1) !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
}

.form-select.rounded-pill {
    backdrop-filter: blur(5px);
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.form-select.rounded-pill:focus {
    background: rgba(255, 255, 255, 0.95);
    border-color: rgba(255, 255, 255, 0.5);
    box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.25);
}

/* Efecto hover para el bot√≥n limpiar filtros */
#limpiar-filtros:hover {
    opacity: 1 !important;
    text-decoration: underline !important;
}

/* Degradados para botones */
.btn-gradient-purple {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-gradient-purple:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    color: white;
}

.btn-gradient-green {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    border: none;
    color: white;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-gradient-green:hover {
    background: linear-gradient(135deg, #0e8678 0%, #32d86a 100%);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4);
    color: white;
}


</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Aplicar filtros
    $('#aplicar-filtros').on('click', function() {
        aplicarFiltros();
    });
    
    // Limpiar filtros
    $('#limpiar-filtros').on('click', function() {
        $('#filtro-comuna').val('');
        $('#filtro-tipo').val('');
        $('#filtro-caracteristicas').val('');
        aplicarFiltros();
    });
    
    // Cambio de filtros autom√°tico (opcional)
    $('#filtro-comuna, #filtro-tipo, #filtro-caracteristicas').on('change', function() {
        actualizarBadgesFiltros();
    });
    
    function aplicarFiltros() {
        const params = new URLSearchParams();
        
        // Obtener valores de filtros
        const comuna = $('#filtro-comuna').val();
        const tipo = $('#filtro-tipo').val();
        const caracteristica = $('#filtro-caracteristicas').val();
        
        console.log('=== DEBUG aplicarFiltros ===');
        console.log('Comuna ID:', comuna);
        console.log('Tipo:', tipo);
        console.log('Caracter√≠stica:', caracteristica);
        
        // Mantener b√∫squeda si existe
        const busqueda = '{{ busqueda_actual|escapejs }}';
        if (busqueda) params.append('q', busqueda);
        
        // Construir URL seg√∫n si hay comuna seleccionada
        let baseUrl = '{% url "explorer:lugares_list" %}';
        
        // Si hay comuna, usar URL con slug
        if (comuna) {
            // Obtener el slug real de la opci√≥n seleccionada
            const comunaSlug = $('#filtro-comuna option:selected').data('slug');
            console.log('Slug encontrado:', comunaSlug);
            
            if (comunaSlug) {
                // Usar URL con slug para comunas
                baseUrl = `/lugares/${comunaSlug}/`;
                console.log('Usando URL con slug:', baseUrl);
            } else {
                // Fallback a URL con par√°metros si no hay slug
                baseUrl = '{% url "explorer:lugares_list" %}';
                params.append('comuna', comuna);
                console.log('Fallback a URL con par√°metros, comuna ID:', comuna);
            }
        } else {
            // Sin comuna, usar URL base
            baseUrl = '{% url "explorer:lugares_list" %}';
            console.log('Sin comuna, URL base:', baseUrl);
        }
        
        // Agregar filtros adicionales como par√°metros
        if (tipo) params.append('tipo', tipo);
        if (caracteristica) params.append(caracteristica, 'true');
        
        // Redireccionar
        const finalUrl = params.toString() ? `${baseUrl}?${params.toString()}` : baseUrl;
        console.log('URL final:', finalUrl);
        console.log('=== FIN DEBUG ===');
        
        window.location.href = finalUrl;
    }
    
    function actualizarBadgesFiltros() {
        const comuna = $('#filtro-comuna option:selected').text();
        const tipo = $('#filtro-tipo option:selected').text();
        const caracteristica = $('#filtro-caracteristicas option:selected').text();
        
        let badges = [];
        
        if ($('#filtro-comuna').val()) {
            badges.push(`<span class="badge bg-primary me-1">üìç ${comuna}</span>`);
        }
        if ($('#filtro-tipo').val()) {
            badges.push(`<span class="badge bg-success me-1">üè¢ ${tipo}</span>`);
        }
        if ($('#filtro-caracteristicas').val()) {
            badges.push(`<span class="badge bg-info me-1">‚≠ê ${caracteristica}</span>`);
        }
        
        if (badges.length > 0) {
            $('#badges-filtros').html(badges.join(''));
            $('#filtros-aplicados').show();
        } else {
            $('#filtros-aplicados').hide();
        }
    }
    
    // Inicializar badges al cargar la p√°gina
    actualizarBadgesFiltros();
});
</script>

<style>
/* Grid/Carrusel de lugares - mismo estilo que home */
.lugares-grid {
  padding: 0.5rem 0;
}

/* M√≥vil: Carrusel horizontal */
@media (max-width: 767.98px) {
  .lugares-grid {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    scroll-behavior: smooth;
    scrollbar-width: thin;
    scrollbar-color: rgba(102, 126, 234, 0.3) transparent;
    padding-bottom: 1rem;
    margin: 0 -1rem;
    padding-left: 1rem;
    padding-right: 1rem;
  }
  
  .lugares-grid::-webkit-scrollbar {
    height: 6px;
  }
  
  .lugares-grid::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 3px;
  }
  
  .lugares-grid::-webkit-scrollbar-thumb {
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    border-radius: 3px;
  }
  
  .lugar-card-wrapper {
    flex: 0 0 auto;
    width: 85vw;
    max-width: 400px;
  }
}

/* Desktop: Grid est√°ndar */
@media (min-width: 768px) {
  .lugares-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
  }
  
  .lugar-card-wrapper {
    width: 100%;
  }
}

/* Card styles */
.card {
  position: relative;
}

.card:hover {
  transform: translateY(-5px);
  transition: all 0.3s ease;
  box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}
</style>
{% endblock %}
