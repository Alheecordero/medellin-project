{% extends "base.html" %}
{% load i18n %}
{% load i18n_extras %}
{% load form_tags %}
{% load static %}

{% block navbar %}{% endblock %}

{% block title %}{{ titulo_pagina }} | ViveMedellín{% endblock %}

{% block meta_description %}{{ descripcion_pagina }} {% trans "Ratings de Google, horarios actualizados y ubicación exacta. Filtra por tipo, zona y características." %}{% endblock %}

{% block meta_keywords %}{% if tipo_actual %}{{ tipo_actual_label }} Medellín, {% trans "mejores" %} {{ tipo_actual_label|lower }} Medellín, {% endif %}{% if region_actual %}{{ region_actual.name }} Medellín, {% trans "lugares" %} {{ region_actual.name }}, {% endif %}{% trans "bares" %} Medellín, {% trans "restaurantes" %} Medellín, {% trans "vida nocturna" %} Medellín{% endblock %}

{% block og_title %}{{ titulo_pagina }} | ViveMedellín{% endblock %}

{% block og_description %}{{ descripcion_pagina }} {% trans "Encuentra lugares con ratings reales y horarios actualizados." %}{% endblock %}

{% block og_image %}
  {{ '/static/img/og-image.jpg'|ensure_absolute_url:request }}
{% endblock %}

{% block content %}
<!-- Schema.org JSON-LD para SEO -->
{% include 'components/schema_org.html' with schema_type='list' lugares=lugares titulo_pagina=titulo_pagina descripcion_pagina=descripcion_pagina %}

<section class="places-section">
  <div class="container py-5">
    <div class="places-main-wrapper">

      <!-- Card Superior: Navegación + Título + Filtros -->
      <div class="places-header-card mb-4">
        {% get_current_language as LANGUAGE_CODE %}

        <!-- Navegación superior -->
        <div class="d-flex justify-content-end align-items-center mb-3 px-1 flex-wrap gap-2">
          <div class="home-lang-switch d-flex flex-wrap gap-2">
            <a href="{% url 'explorer:home' %}" class="btn btn-lang-home inactive">{% trans "Inicio" %}</a>
            {% if LANGUAGE_CODE|slice:":2" == 'en' %}
              <a href="{% url 'explorer:about' %}" class="btn btn-lang-home inactive">{% trans "Nosotros" %}</a>
            {% else %}
              <a href="{% url 'explorer:about_es' %}" class="btn btn-lang-home inactive">{% trans "Nosotros" %}</a>
            {% endif %}
            {% include 'components/lang_switcher.html' %}
          </div>
        </div>

        <!-- Título -->
        <div class="text-center mb-4">
          <h1 class="places-title fw-bold">
            <span class="title-main">{{ titulo_pagina }}</span>
          </h1>
          <p class="lead text-white-50">{{ descripcion_pagina }}</p>
        </div>

        <!-- Filtros estilo HOME -->
        <div class="filtros-home-style">
          <div class="row g-3 justify-content-center">

            <!-- DROPDOWN: Áreas -->
            <div class="col-lg-4 col-md-6">
              <div class="dropdown">
                <button class="btn btn-filtro-dropdown w-100 dropdown-toggle {% if region_actual %}selected{% endif %}" type="button"
                        id="areasDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-geo-alt me-2"></i>
                  <span id="area-label">{% if region_actual %}{{ region_actual.name }}{% else %}{% trans "Seleccionar Área" %}{% endif %}</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-filtros shadow-lg" aria-labelledby="areasDropdown">
                  <li>
                    <a class="dropdown-item dropdown-item-filtro area-option" href="javascript:void(0)" 
                       data-area-slug="" data-area-name="{% trans 'Todas las áreas' %}">
                      <i class="bi bi-globe me-2 text-primary"></i>
                      <div>
                        <div class="fw-semibold">{% trans "Todas las áreas" %}</div>
                        <small class="text-muted">{% trans "Ver todo Medellín" %}</small>
                      </div>
                    </a>
                  </li>
                  {% if comunas_medellin %}
                    <li><hr class="dropdown-divider"></li>
                    <li class="dropdown-header"><i class="bi bi-building me-2 text-success"></i>{% trans "Medellín (Áreas)" %}</li>
                    {% for area in comunas_medellin %}
                      <li>
                        <a class="dropdown-item dropdown-item-filtro area-option" href="javascript:void(0)"
                           data-area-slug="{{ area.slug }}" data-area-name="{{ area.name }}">
                          <i class="bi bi-geo-alt me-2 text-primary"></i>
                          <div class="fw-semibold">{{ area.name }}</div>
                        </a>
                      </li>
                    {% endfor %}
                  {% endif %}
                  {% if otras_regiones %}
                    <li><hr class="dropdown-divider"></li>
                    <li class="dropdown-header"><i class="bi bi-map me-2 text-info"></i>{% trans "Otras áreas de Antioquia" %}</li>
                    {% for area in otras_regiones %}
                      <li>
                        <a class="dropdown-item dropdown-item-filtro area-option" href="javascript:void(0)"
                           data-area-slug="{{ area.slug }}" data-area-name="{{ area.name }}">
                          <i class="bi bi-geo-alt me-2 text-primary"></i>
                          <div class="fw-semibold">{{ area.name }}</div>
                        </a>
                      </li>
                    {% endfor %}
                  {% endif %}
                </ul>
              </div>
            </div>

            <!-- DROPDOWN: Tipos -->
            <div class="col-lg-4 col-md-6">
              <div class="dropdown">
                <button class="btn btn-filtro-dropdown w-100 dropdown-toggle {% if tipo_actual %}selected{% endif %}" type="button"
                        id="tiposDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-grid-3x3-gap me-2"></i>
                  <span id="tipo-label-btn">{% if tipo_actual_label %}{{ tipo_actual_label }}{% else %}{% trans "Seleccionar Tipo" %}{% endif %}</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-filtros shadow-lg" aria-labelledby="tiposDropdown">
                  <li>
                    <a class="dropdown-item dropdown-item-filtro tipo-option" href="javascript:void(0)"
                       data-tipo-code="" data-tipo-label="{% trans 'Todos los tipos' %}">
                      <i class="bi bi-grid me-2 text-primary"></i>
                      <div class="fw-semibold">{% trans "Todos los tipos" %}</div>
                    </a>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  {% for grupo in tipo_grupos_ui %}
                    <li class="dropdown-header"><span class="me-2">{{ grupo.emoji }}</span>{{ grupo.name }}</li>
                    {% for item in grupo.items %}
                      <li>
                        <a class="dropdown-item dropdown-item-filtro tipo-option" href="javascript:void(0)"
                           data-tipo-code="{{ item.code }}" data-tipo-label="{{ item.label }}">
                          <i class="bi bi-arrow-right me-2 text-muted"></i>
                          <div class="fw-semibold">{{ item.label }}</div>
                        </a>
                      </li>
                    {% endfor %}
                    {% if not forloop.last %}<li><hr class="dropdown-divider"></li>{% endif %}
                  {% endfor %}
                </ul>
              </div>
            </div>

            <!-- DROPDOWN: Características -->
            <div class="col-lg-4 col-md-6">
              <div class="dropdown">
                <button class="btn btn-filtro-dropdown w-100 dropdown-toggle" type="button"
                        id="featuresDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="bi bi-stars me-2"></i>
                  <span id="features-label">{% trans "Características" %}</span>
                  <span id="features-count" class="badge bg-success ms-2" style="display: none;">0</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-filtros shadow-lg" aria-labelledby="featuresDropdown">
                  <!-- Limpiar características -->
                  <li>
                    <a class="dropdown-item dropdown-item-filtro feature-clear" href="javascript:void(0)">
                      <i class="bi bi-x-circle me-2 text-muted"></i>
                      <div class="fw-semibold">{% trans "Limpiar características" %}</div>
                    </a>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  
                  <!-- Servicios de Entrega -->
                  <li class="dropdown-header"><i class="bi bi-bicycle me-2 text-primary"></i>{% trans "Servicios de Entrega" %}</li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="delivery" data-label="{% trans 'Delivery' %}"><i class="bi bi-bicycle me-2 text-success"></i><div class="fw-semibold">{% trans "Delivery" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="takeout" data-label="{% trans 'Para Llevar' %}"><i class="bi bi-bag me-2 text-success"></i><div class="fw-semibold">{% trans "Para Llevar" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="dine_in" data-label="{% trans 'Comer en Local' %}"><i class="bi bi-house me-2 text-success"></i><div class="fw-semibold">{% trans "Comer en Local" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  
                  <li><hr class="dropdown-divider"></li>
                  
                  <!-- Ambiente & Experiencia -->
                  <li class="dropdown-header"><i class="bi bi-stars me-2 text-warning"></i>{% trans "Ambiente & Experiencia" %}</li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="outdoor_seating" data-label="{% trans 'Terraza' %}"><i class="bi bi-tree me-2 text-success"></i><div class="fw-semibold">{% trans "Terraza" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="live_music" data-label="{% trans 'Música en Vivo' %}"><i class="bi bi-music-note-beamed me-2 text-success"></i><div class="fw-semibold">{% trans "Música en Vivo" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="good_for_groups" data-label="{% trans 'Para Grupos' %}"><i class="bi bi-people me-2 text-success"></i><div class="fw-semibold">{% trans "Para Grupos" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="good_for_children" data-label="{% trans 'Para Niños' %}"><i class="bi bi-emoji-smile me-2 text-success"></i><div class="fw-semibold">{% trans "Para Niños" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  
                  <li><hr class="dropdown-divider"></li>
                  
                  <!-- Especialidades -->
                  <li class="dropdown-header"><i class="bi bi-cup-straw me-2 text-info"></i>{% trans "Especialidades" %}</li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="serves_cocktails" data-label="{% trans 'Cócteles' %}"><i class="bi bi-cup-straw me-2 text-success"></i><div class="fw-semibold">{% trans "Cócteles" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="serves_wine" data-label="{% trans 'Vinos' %}"><i class="bi bi-cup me-2 text-success"></i><div class="fw-semibold">{% trans "Vinos" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="serves_coffee" data-label="{% trans 'Café Especialidad' %}"><i class="bi bi-cup-hot me-2 text-success"></i><div class="fw-semibold">{% trans "Café Especialidad" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="serves_dessert" data-label="{% trans 'Postres' %}"><i class="bi bi-cake me-2 text-success"></i><div class="fw-semibold">{% trans "Postres" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  
                  <li><hr class="dropdown-divider"></li>
                  
                  <!-- Accesibilidad & Comodidades -->
                  <li class="dropdown-header"><i class="bi bi-universal-access me-2 text-secondary"></i>{% trans "Accesibilidad & Comodidades" %}</li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="wheelchair_accessible_entrance" data-label="{% trans 'Acceso Accesible' %}"><i class="bi bi-universal-access me-2 text-success"></i><div class="fw-semibold">{% trans "Acceso Accesible" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="allows_dogs" data-label="{% trans 'Pet Friendly' %}"><i class="bi bi-heart me-2 text-danger"></i><div class="fw-semibold">{% trans "Pet Friendly" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                  <li><a class="dropdown-item dropdown-item-filtro feature-option" href="javascript:void(0)" data-feature="accepts_credit_cards" data-label="{% trans 'Tarjetas de Crédito' %}"><i class="bi bi-credit-card me-2 text-success"></i><div class="fw-semibold">{% trans "Tarjetas de Crédito" %}</div><i class="bi bi-check2 ms-auto feature-check" style="display:none;"></i></a></li>
                </ul>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- Card Inferior: Grid de Lugares -->
      <div class="places-grid-card" id="places-grid-container">
        {% if lugares %}
          <div class="places-grid">
            {% for lugar in lugares %}
              {% include 'components/place_card.html' with lugar=lugar card_variant='horizontal' %}
            {% endfor %}
          </div>

          <!-- Paginación -->
          {% if is_paginated %}
            <nav class="mt-5 d-flex justify-content-center">
              <ul class="pagination">
                {% if page_obj.has_previous %}
                  <li class="page-item">
                    <a class="page-link rounded-pill me-2" href="?page={{ page_obj.previous_page_number }}{% if filtros_url %}&{{ filtros_url }}{% endif %}">
                      <i class="bi bi-chevron-left me-1"></i>{% trans "Anterior" %}
                    </a>
                  </li>
                {% endif %}

                <li class="page-item disabled">
                  <span class="page-link border-0 bg-transparent text-muted">
                    {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
                  </span>
                </li>

                {% if page_obj.has_next %}
                  <li class="page-item">
                    <a class="page-link rounded-pill ms-2" href="?page={{ page_obj.next_page_number }}{% if filtros_url %}&{{ filtros_url }}{% endif %}">
                      {% trans "Siguiente" %}<i class="bi bi-chevron-right ms-1"></i>
                    </a>
                  </li>
                {% endif %}
              </ul>
            </nav>
          {% endif %}

        {% else %}
          <div class="text-center py-5">
            <i class="bi bi-search display-1 mb-3 text-white-50"></i>
            <h3 class="text-white">{% trans "No hay lugares disponibles" %}</h3>
            <p class="text-white-50">{% trans "No se encontraron lugares que coincidan con tu búsqueda." %}</p>
            <a href="{% url 'explorer:lugares_list' %}" class="btn btn-gradient-green rounded-pill px-4">
              {% trans "Ver todos los lugares" %}
            </a>
          </div>
        {% endif %}
      </div>

    </div>
  </div>
</section>
{% endblock %}

{% block extra_css %}
<style>
/* ═══════════════════════════════════════════════════════════════════
   PLACES LIST - Page Specific Styles
   Los estilos de cards están en components.css
   ═══════════════════════════════════════════════════════════════════ */

.places-section {
  background: var(--gradient-glow), var(--gradient-dark-bg);
  min-height: 100vh;
  padding: var(--space-10) 0 var(--space-12);
}

.places-section .container { max-width: 1280px; }

.places-main-wrapper { 
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 var(--space-6);
}

@media (min-width: 992px) {
  .places-main-wrapper { padding: 0 var(--space-8); }
}

/* Card Header */
.places-header-card {
  background: var(--dark-card-95);
  border-radius: var(--radius-4xl);
  padding: var(--space-10) var(--space-8);
  box-shadow: var(--shadow-3xl);
  border: 1px solid var(--white-12);
  position: relative;
  z-index: 10;
  margin-bottom: var(--space-10);
}

/* Título */
.places-title {
  font-size: var(--font-size-4xl);
  font-weight: var(--font-weight-extrabold);
  color: var(--color-white);
  text-shadow: 0 0 20px var(--accent-40), 0 2px 4px var(--black-50);
  position: relative;
  margin-bottom: var(--space-4);
}

.places-title::after {
  content: '';
  position: absolute;
  bottom: -12px;
  left: 50%;
  transform: translateX(-50%);
  width: 80px;
  height: 4px;
  background: linear-gradient(90deg, transparent, var(--color-primary), var(--color-accent), transparent);
  border-radius: 2px;
  box-shadow: 0 0 12px var(--accent-60);
}

.title-main {
  background: linear-gradient(135deg, var(--color-white) 0%, var(--color-accent) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

@media (min-width: 768px) { .places-title { font-size: 2.5rem; } }
@media (min-width: 992px) { .places-title { font-size: var(--font-size-5xl); } }

/* Filtros */
.filtros-home-style {
  background: rgba(3, 30, 20, 0.95);
  border-radius: var(--radius-3xl);
  padding: var(--space-8) var(--space-6);
  border: 1px solid var(--white-12);
  position: relative;
  z-index: 100;
  margin-top: var(--space-8);
}

/* Grid Container */
.places-grid-card {
  background: var(--dark-card-95);
  border-radius: var(--radius-4xl);
  padding: var(--space-8) var(--space-6);
  box-shadow: var(--shadow-3xl);
  border: 1px solid var(--white-12);
  position: relative;
  z-index: 1;
}

@media (min-width: 992px) {
  .places-grid-card { padding: var(--space-10) var(--space-8); }
}

/* Cards - títulos con gradiente verde */
.places-grid .place-card__title,
.lugares-grid .place-card__title {
  background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
  -webkit-background-clip: text !important;
  -webkit-text-fill-color: transparent !important;
  background-clip: text !important;
}

/* Nav Links - estilos en components.css */

/* Paginación */
.pagination .page-link {
  border: 1px solid var(--primary-30);
  color: var(--color-primary);
  font-weight: var(--font-weight-medium);
  background: var(--color-white);
}

.pagination .page-link:hover {
  background: var(--primary-10);
  border-color: var(--primary-50);
  color: var(--color-primary-dark);
}

/* Estados de filtros */
.btn-filtro-dropdown.selected {
  background: var(--primary-35) !important;
  border-color: var(--primary-60) !important;
}

.feature-option.active {
  background: var(--primary-10);
}

.feature-option.active .feature-check {
  display: inline-block !important;
  color: var(--color-primary);
}

/* Loading */
.places-grid-card.loading {
  opacity: 0.5;
  pointer-events: none;
}

/* Mobile */
@media (max-width: 991px) {
  .places-section { padding: var(--space-6) 0 var(--space-10); }
  .places-main-wrapper { padding: 0 var(--space-4); }
  .places-header-card { 
    padding: var(--space-6) var(--space-5);
    margin-bottom: var(--space-8);
    border-radius: var(--radius-2xl);
  }
  .places-title { font-size: var(--font-size-3xl); }
  .filtros-home-style { 
    padding: var(--space-6) var(--space-5);
    margin-top: var(--space-6);
    border-radius: var(--radius-2xl);
  }
  .places-grid-card {
    padding: var(--space-6) var(--space-5);
    border-radius: var(--radius-2xl);
  }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Helper global para rango de precios (coherente con form_tags.format_price_range)
function formatPriceRangeJs(raw) {
    if (!raw) return '';
    const val = String(raw).toUpperCase();
    const map = {
        '$': '$', '$$': '$$', '$$$': '$$$', '$$$$': '$$$$',
        'PRICE_LEVEL_INEXPENSIVE': '$',
        'PRICE_LEVEL_MODERATE': '$$',
        'PRICE_LEVEL_EXPENSIVE': '$$$',
        'PRICE_LEVEL_VERY_EXPENSIVE': '$$$$',
    };
    if (map[val]) return map[val];
    if (/^\$+$/.test(val) && val.length <= 4) return val;
    return '';
}

// ═══════════════════════════════════════════════════════════════════
// FUNCIÓN GLOBAL: Genera HTML de card idéntica al componente place_card.html
// Usa clases BEM: place-card__* para consistencia total
// ═══════════════════════════════════════════════════════════════════
function generarPlaceCardHtml(lugar, opciones = {}) {
    const T = {
        viewDetails: opciones.viewDetails || '{% trans "Ver detalles" %}',
        featured: opciones.featured || '{% trans "Destacado" %}',
        exclusive: opciones.exclusive || '{% trans "Exclusivo" %}',
        top: opciones.top || '{% trans "Top" %}'
    };
    
    // Distancia formateada
    const distancia = lugar.distancia_km || lugar.distancia;
    const distanciaStr = distancia ? (distancia < 1 ? `${Math.round(distancia * 1000)} m` : `${Number(distancia).toFixed(1)} km`) : '';
    
    // Precio formateado
    const precio = formatPriceRangeJs(lugar.precio);
    
    // URL
    const url = lugar.url || `/lugar/${lugar.slug}/`;
    
    // Imagen con fallback a original si falla
    const imagenFull = lugar.imagen_full || lugar.imagen;
    const imagenHtml = lugar.imagen 
        ? `<img src="${lugar.imagen}" class="place-card__img" alt="${lugar.nombre}" loading="lazy" onerror="this.onerror=null; this.src='${imagenFull}';">`
        : `<div class="place-card__placeholder"><i class="bi bi-image"></i></div>`;
    
    // Rating badge con número de reviews
    let ratingHtml = '';
    if (typeof lugar.rating === 'number') {
        const reviewsCount = lugar.total_reviews ? `<small class="place-card__reviews">(${lugar.total_reviews})</small>` : '';
        ratingHtml = `<div class="place-card__rating"><i class="bi bi-star-fill"></i><span>${lugar.rating.toFixed(1)}</span>${reviewsCount}</div>`;
    }
    
    // Distance badge
    const distanceHtml = distanciaStr 
        ? `<div class="place-card__distance"><i class="bi bi-geo-alt"></i><span>${distanciaStr}</span></div>` 
        : '';
    
    // Badges
    let badgesHtml = `<span class="place-card__badge place-card__badge--type"><i class="bi bi-geo-alt"></i>${lugar.tipo || ''}</span>`;
    if (lugar.es_destacado) {
        badgesHtml += `<span class="place-card__badge place-card__badge--featured"><i class="bi bi-star-fill"></i>${T.featured}</span>`;
    }
    if (lugar.es_exclusivo) {
        badgesHtml += `<span class="place-card__badge place-card__badge--exclusive"><i class="bi bi-gem"></i>${T.exclusive}</span>`;
    }
    if (typeof lugar.rating === 'number' && lugar.rating >= 4.5) {
        badgesHtml += `<span class="place-card__badge place-card__badge--top-rated"><i class="bi bi-award"></i>${T.top}</span>`;
    }
    
    // Precio
    const precioHtml = precio 
        ? `<div class="place-card__meta"><i class="bi bi-cash-stack"></i><span>${precio}</span></div>` 
        : '';
    
    // Dirección (truncada a 45 chars)
    const direccion = lugar.direccion ? lugar.direccion.substring(0, 45) + (lugar.direccion.length > 45 ? '...' : '') : '';
    const direccionHtml = direccion 
        ? `<div class="place-card__address"><i class="bi bi-map"></i><span>${direccion}</span></div>` 
        : '';
    
    // CTA
    const ctaHtml = lugar.slug 
        ? `<a href="${url}" class="place-card__cta"><i class="bi bi-eye"></i>${T.viewDetails}</a>` 
        : '';
    
    return `
        <div class="place-card-wrapper">
            <article class="place-card place-card--horizontal">
                <div class="place-card__media">
                    ${imagenHtml}
                    ${ratingHtml}
                    ${distanceHtml}
                </div>
                <div class="place-card__body">
                    <h3 class="place-card__title">${lugar.nombre}</h3>
                    <div class="place-card__badges">${badgesHtml}</div>
                    ${precioHtml}
                    ${direccionHtml}
                    ${ctaHtml}
                </div>
            </article>
        </div>`;
}

$(document).ready(function() {
    // ═══════════════════════════════════════════════════════════════
    // FILTRADO DINÁMICO PROFESIONAL
    // ═══════════════════════════════════════════════════════════════
    
    // Estado inicial de filtros (desde el servidor)
    const filtros = {
        area: '{{ region_actual.slug|default:"" }}',
        areaName: '{{ region_actual.name|default:"" }}',
        tipo: '{{ tipo_actual|default:"" }}',
        tipoLabel: '{{ tipo_actual_label|default:"" }}',
        caracteristicas: {},
        pagina: 1
    };
    
    // Textos traducidos
    const T = {
        selectArea: '{% trans "Seleccionar Área" %}',
        selectType: '{% trans "Seleccionar Tipo" %}',
        features: '{% trans "Características" %}',
        loading: '{% trans "Cargando..." %}',
        noResults: '{% trans "No hay lugares disponibles" %}',
        noResultsMsg: '{% trans "No se encontraron lugares que coincidan con tu búsqueda." %}',
        viewAll: '{% trans "Ver todos los lugares" %}',
        viewDetails: '{% trans "Ver detalles" %}',
        featured: '{% trans "Destacado" %}',
        exclusive: '{% trans "Exclusivo" %}',
        prev: '{% trans "Anterior" %}',
        next: '{% trans "Siguiente" %}'
    };
    
    // Parsear características iniciales desde URL
    const urlParams = new URLSearchParams(window.location.search);
    const featureKeys = ['delivery', 'takeout', 'dine_in', 'outdoor_seating', 'live_music',
        'good_for_groups', 'good_for_children', 'serves_cocktails', 'serves_wine',
        'serves_coffee', 'serves_dessert', 'wheelchair_accessible_entrance',
        'allows_dogs', 'accepts_credit_cards', 'reservable'];
    
    featureKeys.forEach(key => {
        if (urlParams.get(key) === 'true') {
            filtros.caracteristicas[key] = true;
            $(`.feature-option[data-feature="${key}"]`).addClass('active')
                .find('.feature-check').show();
        }
    });
    updateFeaturesCount();
    
    // Control de búsqueda
    let searchTimeout = null;
    let currentRequest = null;
    const DEBOUNCE_MS = 400;
    
    // ─────────────────────────────────────────────────────────────
    // EVENT: Selección de Área
    // ─────────────────────────────────────────────────────────────
    $(document).on('click', '.area-option', function(e) {
        e.preventDefault();
        filtros.area = $(this).data('area-slug') || '';
        filtros.areaName = $(this).data('area-name') || '';
        filtros.pagina = 1;
        
        // Actualizar UI
        $('#area-label').text(filtros.area ? filtros.areaName : T.selectArea);
        $('#areasDropdown').toggleClass('selected', !!filtros.area);
        $('#areasDropdown').dropdown('hide');
        
        ejecutarBusqueda();
    });
    
    // ─────────────────────────────────────────────────────────────
    // EVENT: Selección de Tipo
    // ─────────────────────────────────────────────────────────────
    $(document).on('click', '.tipo-option', function(e) {
        e.preventDefault();
        filtros.tipo = $(this).data('tipo-code') || '';
        filtros.tipoLabel = $(this).data('tipo-label') || '';
        filtros.pagina = 1;
        
        // Actualizar UI
        $('#tipo-label-btn').text(filtros.tipo ? filtros.tipoLabel : T.selectType);
        $('#tiposDropdown').toggleClass('selected', !!filtros.tipo);
        $('#tiposDropdown').dropdown('hide');
        
        ejecutarBusqueda();
    });
    
    // ─────────────────────────────────────────────────────────────
    // EVENT: Toggle de Característica
    // ─────────────────────────────────────────────────────────────
    $(document).on('click', '.feature-option', function(e) {
        e.preventDefault();
        e.stopPropagation(); // No cerrar el dropdown
        
        const feature = $(this).data('feature');
        const isActive = $(this).hasClass('active');
        
        if (isActive) {
            $(this).removeClass('active').find('.feature-check').hide();
            delete filtros.caracteristicas[feature];
        } else {
            $(this).addClass('active').find('.feature-check').show();
            filtros.caracteristicas[feature] = true;
        }
        
        filtros.pagina = 1;
        updateFeaturesCount();
        programarBusqueda();
    });
    
    // ─────────────────────────────────────────────────────────────
    // EVENT: Limpiar Características
    // ─────────────────────────────────────────────────────────────
    $(document).on('click', '.feature-clear', function(e) {
        e.preventDefault();
        filtros.caracteristicas = {};
        filtros.pagina = 1;
        
        $('.feature-option').removeClass('active').find('.feature-check').hide();
        updateFeaturesCount();
        $('#featuresDropdown').dropdown('hide');
        
        ejecutarBusqueda();
    });
    
    // ─────────────────────────────────────────────────────────────
    // HELPERS
    // ─────────────────────────────────────────────────────────────
    function updateFeaturesCount() {
        const count = Object.keys(filtros.caracteristicas).length;
        const $count = $('#features-count');
        const $btn = $('#featuresDropdown');
        
        if (count > 0) {
            $count.text(count).show();
            $btn.addClass('selected');
        } else {
            $count.hide();
            $btn.removeClass('selected');
        }
    }
    
    function programarBusqueda() {
        if (searchTimeout) clearTimeout(searchTimeout);
        searchTimeout = setTimeout(ejecutarBusqueda, DEBOUNCE_MS);
    }
    
    function ejecutarBusqueda() {
        if (searchTimeout) clearTimeout(searchTimeout);
        if (currentRequest) currentRequest.abort();
        
        // Mostrar loading
        $('.places-grid-card').addClass('loading');
        
        // Construir parámetros
        const params = new URLSearchParams();
        if (filtros.area) params.append('area', filtros.area);
        if (filtros.tipo) params.append('tipo', filtros.tipo);
        if (filtros.pagina > 1) params.append('page', filtros.pagina);
        
        Object.keys(filtros.caracteristicas).forEach(key => {
            params.append(key, 'true');
        });
        
        // Actualizar URL sin recargar (History API)
        const newUrl = window.location.pathname + (params.toString() ? '?' + params.toString() : '');
        window.history.pushState({filtros: filtros}, '', newUrl);
        
        // Petición AJAX
        currentRequest = $.ajax({
            url: '{% url "explorer:places_filter_ajax" %}',
            type: 'GET',
            data: params.toString(),
            success: function(response) {
                $('.places-grid-card').removeClass('loading');
                if (response.success) {
                    renderizarResultados(response);
                    actualizarTitulo(response);
                }
            },
            error: function(xhr, status, error) {
                if (status === 'abort') return;
                $('.places-grid-card').removeClass('loading');
                console.error('Error:', error);
            }
        });
    }
    
    function renderizarResultados(data) {
        const $grid = $('.lugares-grid');
        const $container = $('.places-grid-card');
        
        if (data.lugares.length === 0) {
            $container.html(`
                <div class="text-center py-5">
                    <i class="bi bi-search display-1 mb-3 text-white-50"></i>
                    <h3 class="text-white">${T.noResults}</h3>
                    <p class="text-white-50">${data.mensaje || T.noResultsMsg}</p>
                    <a href="{% url 'explorer:lugares_list' %}" class="btn btn-gradient-green rounded-pill px-4">
                        ${T.viewAll}
                    </a>
                </div>
            `);
            return;
        }
        
        // Generar HTML de cards
        let html = '<div class="lugares-grid">';
        data.lugares.forEach((lugar, i) => {
            html += generarCardHtml(lugar, i);
        });
        html += '</div>';
        
        // Agregar paginación si existe
        if (data.paginacion && data.paginacion.total_paginas > 1) {
            html += generarPaginacionHtml(data.paginacion);
        }
        
        $container.html(html);
        
        // Animar cards
        $('.lugar-card-wrapper').each(function(i) {
            $(this).css('animation-delay', (i * 0.05) + 's').addClass('animate');
        });
    }
    
    // ═══════════════════════════════════════════════════════════════
    // Función estandarizada para generar HTML de card
    // Muestra: Imagen, Rating, Tipo, Destacado, Exclusivo, Top, Precio, Dirección, CTA
    // ═══════════════════════════════════════════════════════════════
    // Usa la función global generarPlaceCardHtml para mantener consistencia
    function generarCardHtml(lugar) {
        return generarPlaceCardHtml(lugar);
    }
    
    function generarPaginacionHtml(pag) {
        let html = '<nav class="mt-5 d-flex justify-content-center"><ul class="pagination">';
        
        if (pag.tiene_anterior) {
            html += `<li class="page-item">
                <a class="page-link rounded-pill me-2 pagination-link" href="javascript:void(0)" data-page="${pag.pagina_anterior}">
                    <i class="bi bi-chevron-left me-1"></i>${T.prev}
                </a>
            </li>`;
        }
        
        html += `<li class="page-item disabled">
            <span class="page-link border-0 bg-transparent text-muted">
                ${pag.pagina_actual} / ${pag.total_paginas}
            </span>
        </li>`;
        
        if (pag.tiene_siguiente) {
            html += `<li class="page-item">
                <a class="page-link rounded-pill ms-2 pagination-link" href="javascript:void(0)" data-page="${pag.pagina_siguiente}">
                    ${T.next}<i class="bi bi-chevron-right ms-1"></i>
                </a>
            </li>`;
        }
        
        html += '</ul></nav>';
        return html;
    }
    
    function actualizarTitulo(data) {
        // Actualizar subtítulo con el mensaje del backend
        $('.places-header-card .lead').text(data.mensaje);
    }
    
    // ─────────────────────────────────────────────────────────────
    // EVENT: Paginación
    // ─────────────────────────────────────────────────────────────
    $(document).on('click', '.pagination-link', function(e) {
        e.preventDefault();
        filtros.pagina = $(this).data('page');
        ejecutarBusqueda();
        
        // Scroll al inicio de resultados
        $('html, body').animate({
            scrollTop: $('.places-grid-card').offset().top - 100
        }, 400);
    });
    
    // ─────────────────────────────────────────────────────────────
    // HISTORY: Manejar navegación hacia atrás/adelante
    // ─────────────────────────────────────────────────────────────
    window.addEventListener('popstate', function(e) {
        if (e.state && e.state.filtros) {
            Object.assign(filtros, e.state.filtros);
            sincronizarUI();
            ejecutarBusqueda();
        }
    });
    
    function sincronizarUI() {
        // Área
        $('#area-label').text(filtros.area ? filtros.areaName : T.selectArea);
        $('#areasDropdown').toggleClass('selected', !!filtros.area);
        
        // Tipo
        $('#tipo-label-btn').text(filtros.tipo ? filtros.tipoLabel : T.selectType);
        $('#tiposDropdown').toggleClass('selected', !!filtros.tipo);
        
        // Características
        $('.feature-option').each(function() {
            const feature = $(this).data('feature');
            if (filtros.caracteristicas[feature]) {
                $(this).addClass('active').find('.feature-check').show();
            } else {
                $(this).removeClass('active').find('.feature-check').hide();
            }
        });
        updateFeaturesCount();
    }
});
</script>
{% endblock %}
