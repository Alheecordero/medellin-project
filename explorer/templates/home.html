{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "ViveMedellín | Bares, Restaurantes y Vida Nocturna en Medellín" %}{% endblock %}

{% block meta_description %}{% blocktrans %}Tu guía local de Medellín: miles de bares, restaurantes, rooftops y discotecas con ratings de Google. Explora El Poblado, Laureles, Envigado y más.{% endblocktrans %}{% endblock %}

{% block meta_keywords %}{% blocktrans %}bares Medellín, restaurantes Medellín, rooftops El Poblado, discotecas Medellín, dónde comer Medellín, vida nocturna Medellín, mejores bares El Poblado, restaurantes Laureles{% endblocktrans %}{% endblock %}

{% block og_title %}{% trans "ViveMedellín | Los Mejores Bares y Restaurantes de Medellín" %}{% endblock %}

{% block og_description %}{% blocktrans %}Descubre miles de lugares en Medellín: bares, restaurantes, rooftops y discotecas. Ratings de Google, horarios y ubicación exacta.{% endblocktrans %}{% endblock %}

{% block og_image %}{{ request.scheme }}://{{ request.get_host }}{% static 'img/og-image.jpg' %}{% endblock %}
{% block og_image_alt %}{% trans "Vista panorámica de Medellín - ViveMedellín" %}{% endblock %}

{% block navbar %}{% endblock %}

{% block content %}

<!-- Hero Section -->
<section class="hero-section-clean position-relative overflow-hidden">
    <div class="container py-5">
        <div class="row min-vh-100 align-items-center justify-content-center">
            <div class="col-xl-10 col-lg-11 col-md-12 text-center">
                <div class="hero-content">
                    <div class="hero-top">
                        {% get_current_language as LANGUAGE_CODE %}
                        <div class="d-flex justify-content-center justify-content-sm-end mb-3 home-lang-switch gap-2 flex-wrap">
                            <!-- Home / About us con mismo estilo que ES / EN -->
                            <a href="{% url 'explorer:home' %}" class="btn btn-lang-home inactive">
                                {% trans "Inicio" %}
                            </a>
                            {% if LANGUAGE_CODE|slice:":2" == 'en' %}
                              <a href="{% url 'explorer:about' %}" class="btn btn-lang-home inactive">
                                {% trans "Nosotros" %}
                              </a>
                            {% else %}
                              <a href="{% url 'explorer:about_es' %}" class="btn btn-lang-home inactive">
                                {% trans "Nosotros" %}
                              </a>
                            {% endif %}
                            <!-- Selector de idioma -->
                            {% include 'components/lang_switcher.html' %}
                        </div>                    
                        <h1 class="hero-title display-2 mb-4 fw-bold">
                            {% blocktrans trimmed %}Descubre Medellín<br><span class="title-accent">como nunca antes</span>{% endblocktrans %}
                        </h1>
                        
                        <!-- Search Bar -->
                        <div class="search-modern-clean mb-3">
                            <div class="input-group input-group-lg shadow-lg">
                                <input type="text" 
                                       id="search-places" 
                                       class="form-control form-control-lg rounded-start-pill border-0"
                                       placeholder="{% trans 'Busca bares, restaurantes, lugares...' %}"
                                       aria-label="{% trans 'Buscar lugares en Medellín' %}">
                                <button class="btn btn-light rounded-end-pill px-4" type="button" aria-label="{% trans 'Buscar' %}">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Filtros Dropdown -->
                        <div class="filtros-home mb-5">
                        <div class="row g-3 justify-content-center">
                            
                            <!-- 1. ÁREAS -->
                            <div class="col-lg-4 col-md-6">
                                <div class="dropdown" style="position: relative; z-index: 1000;">
                                    <button class="btn btn-filtro-dropdown w-100 dropdown-toggle" type="button" id="areasDropdown" data-bs-toggle="dropdown" data-bs-placement="bottom" data-bs-auto-close="true" aria-expanded="false">
                                        <i class="bi bi-geo-alt me-2"></i>
                                        <span id="area-selected-text">{% trans "Seleccionar Área" %}</span>
                                        <span id="area-check" class="ms-2" style="display: none;">✓</span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-filtros shadow-lg" aria-labelledby="areasDropdown">
                                        {% if comunas_medellin %}
                                          <li class="dropdown-header">
                                            <i class="bi bi-building me-2 text-success"></i>{% trans "Medellín (Áreas)" %}
                                          </li>
                                          {% for area in comunas_medellin %}
                                        <li>
                                            <a class="dropdown-item dropdown-item-filtro area-option" 
                                               href="javascript:void(0)" 
                                               data-area-id="{{ area.osm_id }}" 
                                               data-area-name="{{ area.name }}"
                                               data-area-slug="{{ area.slug }}">
                                                <i class="bi bi-geo-alt me-2 text-primary"></i>
                                                <div>
                                                    <div class="fw-semibold">{{ area.name }}</div>
                                                    <small class="text-muted">{% trans "Explorar esta comuna" %}</small>
                                                </div>
                                            </a>
                                        </li>
                                        {% endfor %}
                                        {% endif %}

                                        {% if otras_regiones %}
                                          <li><hr class="dropdown-divider"></li>
                                          <li class="dropdown-header">
                                            <i class="bi bi-map me-2 text-info"></i>{% trans "Otras áreas de Antioquia" %}
                                          </li>
                                          {% for area in otras_regiones %}
                                          <li>
                                            <a class="dropdown-item dropdown-item-filtro area-option" 
                                               href="javascript:void(0)" 
                                               data-area-id="{{ area.osm_id }}" 
                                               data-area-name="{{ area.name }}"
                                               data-area-slug="{{ area.slug }}">
                                                <i class="bi bi-geo-alt me-2 text-primary"></i>
                                                <div>
                                                    <div class="fw-semibold">{{ area.name }}</div>
                                                    <small class="text-muted">{% trans "Explorar esta área" %}</small>
                                                </div>
                                            </a>
                                          </li>
                                          {% endfor %}
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>

                            <!-- 2. CATEGORÍAS REALES -->
                            <div class="col-lg-4 col-md-6">
                                <div class="dropdown" style="position: relative; z-index: 999;">
                                    <button class="btn btn-filtro-dropdown w-100 dropdown-toggle" type="button" id="categoriasDropdown" data-bs-toggle="dropdown" data-bs-placement="bottom" data-bs-auto-close="true" aria-expanded="false">
                                        <i class="bi bi-grid-3x3-gap me-2"></i>
                                        <span id="categoria-selected-text">{% trans "Seleccionar Tipo" %}</span>
                                        <span id="categoria-check" class="ms-2" style="display: none;">✓</span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-filtros shadow-lg" aria-labelledby="categoriasDropdown">
                                        {% for categoria in categorias_reales %}
                                        <li class="dropdown-header">
                                            <i class="{{ categoria.icon }} me-2 text-{{ categoria.color }}"></i>{{ categoria.name }}
                                        </li>
                                        {% for subcategoria in categoria.subcategorias %}
                                        <li>
                                            <a class="dropdown-item dropdown-item-filtro categoria-option" 
                                               href="javascript:void(0)"
                                               data-categoria-id="{{ subcategoria.value }}" 
                                               data-categoria-name="{{ subcategoria.name }}">
                                                <i class="bi bi-arrow-right me-2 text-muted"></i>
                                                <div>
                                                    <div class="fw-semibold">{{ subcategoria.name }}</div>
                                                </div>
                                            </a>
                                        </li>
                                        {% endfor %}
                                        {% if not forloop.last %}<li><hr class="dropdown-divider"></li>{% endif %}
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>

                            <!-- 3. ETIQUETAS ESPECIALES -->
                            <div class="col-lg-4 col-md-6">
                                <div class="dropdown" style="position: relative; z-index: 998;">
                                    <button class="btn btn-filtro-dropdown w-100 dropdown-toggle" type="button" id="etiquetasDropdown" data-bs-toggle="dropdown" data-bs-placement="bottom" data-bs-auto-close="true" aria-expanded="false">
                                        <i class="bi bi-stars me-2"></i>
                                        <span id="caracteristica-selected-text">{% trans "Características" %}</span>
                                        <span id="caracteristica-check" class="ms-2" style="display: none;">✓</span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-filtros shadow-lg" aria-labelledby="etiquetasDropdown">
                                        <!-- Opción para no seleccionar característica -->
                                        <li>
                                            <a class="dropdown-item dropdown-item-filtro caracteristica-option" 
                                               href="javascript:void(0)"
                                               data-caracteristica-id="none" 
                                               data-caracteristica-name="{% trans 'Sin característica especial' %}">
                                                <i class="bi bi-x-circle me-2 text-muted"></i>
                                                <div>
                                                    <div class="fw-semibold">{% trans "Sin característica especial" %}</div>
                                                    <small class="text-muted">{% trans "Buscar sin filtros adicionales" %}</small>
                                                </div>
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        
                                        {% for grupo in etiquetas_especiales %}
                                        <li class="dropdown-header">
                                            <i class="{{ grupo.icon }} me-2 text-warning"></i>{{ grupo.name }}
                                        </li>
                                        {% for opcion in grupo.opciones %}
                                        <li>
                                            <a class="dropdown-item dropdown-item-filtro caracteristica-option" 
                                               href="javascript:void(0)"
                                               data-caracteristica-id="{{ opcion.field }}" 
                                               data-caracteristica-name="{{ opcion.name }}">
                                                <i class="{{ opcion.icon }} me-2 text-success"></i>
                                                <div>
                                                    <div class="fw-semibold">{{ opcion.name }}</div>
                                                </div>
                                            </a>
                                        </li>
                                        {% endfor %}
                                        {% if not forloop.last %}<li><hr class="dropdown-divider"></li>{% endif %}
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>

                        </div>
                        
                        <!-- Botones principales -->
                        <div class="text-center mt-4 d-flex flex-wrap justify-content-center gap-3">
                            <button id="cerca-de-mi-btn" class="btn btn-near-me-toggle" type="button">
                                <i id="ubicacion-icon" class="bi bi-geo-fill me-2"></i>
                                    <span id="ubicacion-text">{% trans "Cerca de Mí" %}</span>
                            </button>
                            
                            <a href="{% url 'explorer:lugares_list' %}" class="btn btn-gradient-green btn-lg rounded-pill px-4">
                                <i class="bi bi-compass me-2"></i>{% trans "Ver Todos los Lugares" %}
                            </a>
                        </div>
                    </div>
                    
                    <!-- Loading y Resultados AJAX -->
                    <div id="ajax-loading" class="text-center py-5" style="display: none; position: relative; z-index: 1;">
                        <div class="spinner-border text-light" role="status">
                            <span class="visually-hidden">{% trans "Cargando..." %}</span>
                        </div>
                        <div class="text-white mt-3">
                            <h5>{% trans "Buscando lugares..." %}</h5>
                            <p>{% trans "Esto puede tardar unos segundos" %}</p>
                        </div>
                    </div>
                    
                    <!-- Contenedor de resultados principal se define fuera del hero para no afectar el fondo -->

                    <!-- Burbujas de áreas de Medellín (en la parte inferior de la card) -->
                    {% if comunas_medellin_chips or otras_regiones_chips or comunas_medellin or otras_regiones %}
                    <div class="areas-burbujas mt-2 flex-column">
                        {% with comunas_chips=comunas_medellin_chips|default:comunas_medellin otras_chips=otras_regiones_chips|default:otras_regiones %}
                        {% if comunas_chips %}
                        <div class="areas-group">
                            <div class="areas-group-label">
                                {% trans "Medellín (Áreas)" %}
                            </div>
                            <div class="areas-group-bubbles">
                                {% for area in comunas_chips %}
                            <a href="{% url 'explorer:lugares_por_comuna' area.slug %}" class="area-bubble">
                                <span class="dot"></span>
                                <span class="label">{{ area.name }}</span>
                            </a>
                        {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        {% if otras_chips %}
                        <div class="areas-group mt-2">
                            <div class="areas-group-label">
                                {% trans "Otras áreas de Antioquia" %}
                            </div>
                            <div class="areas-group-bubbles">
                                {% for area in otras_chips %}
                                    <a href="{% url 'explorer:lugares_por_comuna' area.slug %}" class="area-bubble">
                                        <span class="dot"></span>
                                        <span class="label">{{ area.name }}</span>
                                    </a>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        <div class="areas-group mt-2">
                            <div class="areas-group-bubbles">
                        <a href="{% url 'explorer:lugares_list' %}" class="area-bubble area-bubble-all">
                            <span class="dot"></span>
                            <span class="label">{% trans "Ver todas las áreas" %}</span>
                        </a>
                            </div>
                        </div>
                    </div>
                        {% endwith %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Sección separada para resultados dinámicos (semánticos, cerca de mí, etc.) -->
<section id="search-results-section" style="display: none;">
    <div id="ajax-results"></div>
</section>

<!-- Schema.org JSON-LD -->
{% include 'components/schema_org.html' with schema_type='website' %}
{% include 'components/schema_org.html' with schema_type='organization' %}

    <!-- Pre-carga i18n para textos usados solo en JS (oculto) -->
    <div class="visually-hidden" aria-hidden="true">
        {% trans "Obteniendo ubicación..." %}
        {% trans "Ubicación encontrada" %}
        {% trans "Permiso de ubicación denegado. Por favor, habilita la ubicación en tu navegador." %}
        {% trans "No se pudo determinar tu ubicación. Intenta de nuevo." %}
        {% trans "La solicitud de ubicación tardó demasiado. Intenta de nuevo." %}
        {% trans "Error desconocido al obtener la ubicación." %}
        {% trans "Error en la búsqueda" %}
        {% trans "Error de conexión" %}
        {% trans "No hay lugares cercanos disponibles en este momento." %}
        {% trans "Error al cargar lugares cercanos." %}
        {% trans "Reintentar" %}
        {% trans "No hay lugares similares disponibles en este momento." %}
        {% trans "Error al cargar lugares similares." %}
        {% trans "No hay más lugares en esta zona disponibles en este momento." %}
        {% trans "Error al cargar lugares de la zona." %}
    </div>
{% endblock %}

{% block extra_css %}
<style>
/* Ocultar espaciador del navbar solo en home */
.navbar-spacer {
    display: none;
}

/* Botones de idioma - estilos en components.css */

/* Hero Section con foto limpia de Medellín como fondo */
.hero-section-clean {
    position: relative;
    background-image: url("{% static 'img/juan-saravia-03gVOLHq9ec-unsplash.jpg' %}");
    background-size: cover;
    background-position: center center;
    background-repeat: no-repeat;
    min-height: 100vh;
    margin-top: 0;
    padding-top: 95px;
    padding-bottom: 80px;
}

/* Contenedor central tipo “glassmorphism” */
.hero-content {
    background: rgba(4, 20, 12, 0.7);
    border-radius: 28px;
    padding: 2.5rem 2rem 1.8rem 2rem;
    box-shadow: 0 24px 60px rgba(0, 0, 0, 0.55);
    border: 1px solid rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(18px);
    min-height: 80vh;
    display: flex;
    flex-direction: column;
}

/* Hero title centrado y más compacto, tipo landing moderna */
.hero-title {
    text-align: center;
    line-height: 1.1;
    letter-spacing: -0.03em;
    color: #f8fafc;
    font-size: clamp(2rem, 6vw, 4rem);
}

.title-accent {
    background: linear-gradient(135deg, #4ade80 0%, #22d3ee 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    display: inline-block;
}

/* Search Input Styling */
.search-modern-clean .form-control {
    padding: 0.95rem 1.6rem;
    font-size: 1.05rem;
    border-radius: 999px 0 0 999px;
}

.search-modern-clean .form-control:focus {
    box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
    border-color: #667eea;
}

/* Botón de búsqueda grande, circular y protagonista */
.search-modern-clean .btn {
    border-radius: 0 999px 999px 0;
    font-weight: 600;
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    border: none;
    color: #fff;
}

.search-modern-clean .btn:hover {
    background: linear-gradient(135deg, #0f8a7f 0%, #2fd86f 100%);
    transform: translateY(-1px);
    box-shadow: 0 8px 20px rgba(47, 216, 111, 0.45);
}

/* Burbujas de áreas (chips de zonas de Medellín) al fondo de la card */
.areas-burbujas {
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
    padding: 0.5rem 0 0.25rem 0;
    justify-content: center;
    align-items: stretch;
}

.area-bubble {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.35rem 0.9rem;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.55);
    background: rgba(0, 0, 0, 0.25);
    color: #f6fdfb;
    font-size: 0.85rem;
    text-decoration: none;
    white-space: nowrap;
    transition: all 0.2s ease;
}

.area-bubble .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #38ef7d;
}

.area-bubble-all .dot {
    background: #ffca28;
}

.areas-group {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
}

.areas-group-label {
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    color: rgba(226, 232, 240, 0.8);
    text-align: center;
}

.areas-group-bubbles {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    justify-content: center;
}

.area-bubble:hover {
    background: rgba(0, 0, 0, 0.45);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
}

/* Grid de lugares: vertical en mobile, múltiple en desktop */
.lugares-grid {
  padding: 0.5rem 0;
}

/* Mobile: lista vertical (sin scroll horizontal) */
@media (max-width: 767.98px) {
  .lugares-grid {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
    padding-bottom: 1rem;
    margin: 0;
  }
  
  .lugar-card-wrapper {
    width: 100%;
  }
}

/* Desktop: grid de 3 columnas */
@media (min-width: 768px) {
  .lugares-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
  }
  
  .lugar-card-wrapper {
    width: 100%;
  }
}

/* Card Hover Effects */
.card {
    position: relative;
}

/* Badge overlay sobre imagen de card */
.badge-overlay {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    z-index: 10;
}

.badge-overlay .badge {
    background-color: rgba(13, 110, 253, 0.95) !important;
    backdrop-filter: blur(4px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    font-weight: 600;
}

.card:hover {
    transform: translateY(-5px);
    transition: all 0.3s ease;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

/* Filtros del Home */
.filtros-home {
    background: rgba(3, 30, 20, 0.88);
    backdrop-filter: blur(16px);
    border-radius: 22px;
    padding: 2rem 1.75rem;
    border: 1px solid rgba(255, 255, 255, 0.12);
    position: relative;
    z-index: 2; /* por encima del área de resultados */
}

/* Botones y Dropdowns de Filtros - estilos base en components.css */

/* Posicionamiento específico del dropdown para Home */
.dropdown-menu-filtros {
    position: absolute !important;
    top: 100% !important;
    bottom: auto !important;
    left: 0 !important;
    right: auto !important;
    transform: none !important;
    will-change: auto !important;
    inset: auto !important;
    z-index: 100 !important;
}

/* Dropdown específico para características */
#etiquetasDropdown + .dropdown-menu-filtros {
    max-height: 280px;
    overflow-y: auto;
    overflow-x: hidden;
}

@media (max-width: 768px) {
    #etiquetasDropdown + .dropdown-menu-filtros {
        max-height: 250px;
    }
}

.dropdown-header {
    color: #495057;
    font-weight: 600;
    font-size: 0.9rem;
    padding: 0.5rem 0.75rem 0.25rem;
    margin-top: 0.5rem;
}

.dropdown-header:first-child {
    margin-top: 0;
}

/* ═══════════════════════════════════════════════════════════════
   NEAR ME TOGGLE - DISEÑO PROFESIONAL
   ═══════════════════════════════════════════════════════════════ */

/* Botón Near Me Toggle */
.btn-near-me-toggle {
    background: rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.25);
    color: white;
    font-size: 1rem;
    font-weight: 600;
    padding: 0.75rem 1.75rem;
    border-radius: 999px;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    position: relative;
    overflow: hidden;
}

.btn-near-me-toggle::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.btn-near-me-toggle:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: translateY(-2px);
    box-shadow: 0 6px 25px rgba(0, 0, 0, 0.25);
    color: white;
}

.btn-near-me-toggle:hover::before {
    left: 100%;
}

.btn-near-me-toggle.locating {
    background: rgba(17, 153, 142, 0.3);
    border-color: rgba(17, 153, 142, 0.6);
    pointer-events: none;
}

.btn-near-me-toggle.locating #ubicacion-icon {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.btn-near-me-toggle.active {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    border-color: transparent;
    color: #0f172a;
    box-shadow: 0 6px 25px rgba(17, 153, 142, 0.4);
}

.btn-near-me-toggle.error {
    background: rgba(239, 68, 68, 0.25);
    border-color: rgba(239, 68, 68, 0.5);
    animation: shake 0.5s ease-in-out;
}

@keyframes shake {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-5px); }
    40%, 80% { transform: translateX(5px); }
}

/* Filtros en resultados Near Me - estilo dropdown */
.filtros-nearme-results {
    background: rgba(3, 30, 20, 0.6);
    border-radius: 18px;
    padding: 1rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.filtros-nearme-results .btn-filtro-dropdown {
    font-size: 0.85rem;
    padding: 0.55rem 0.9rem;
}

.filtros-nearme-results .btn-filtro-dropdown.selected {
    background: rgba(17, 153, 142, 0.35);
    border-color: rgba(17, 153, 142, 0.6);
}

.filtros-nearme-results .dropdown-menu-filtros {
    min-width: 220px;
    max-height: 350px;
    overflow-y: auto;
}

/* Near Me Section responsive */
.near-me-section {
    position: relative;
    z-index: 1;
}

/* Mobile optimizations for Near Me */
@media (max-width: 768px) {
    .btn-near-me-toggle {
        font-size: 0.9rem;
        padding: 0.65rem 1.5rem;
    }
    
    .filtros-nearme-results {
        padding: 1rem;
        border-radius: 14px;
    }
    
    .filtros-nearme-results .row {
        gap: 0.5rem !important;
    }
    
    .filtros-nearme-results .col-6 {
        flex: 0 0 100%;
        max-width: 100%;
    }
    
    .filtros-nearme-results .btn-filtro-dropdown {
        font-size: 0.85rem;
        padding: 0.6rem 0.85rem;
    }
    
    .nearby-actions {
        padding: 0 1rem;
    }
    
    .nearby-actions .btn {
        font-size: 0.9rem;
        padding: 0.65rem 1.25rem;
    }
}

/* Smooth transitions for results */
#ajax-results,
#search-results-section {
    transition: opacity 0.3s ease;
}

#ajax-loading {
    transition: opacity 0.2s ease;
}

/* Grid de lugares con transiciones */
.semantic-home-grid {
    transition: opacity 0.25s ease;
    min-height: 200px;
}

.semantic-home-grid.loading {
    opacity: 0.4;
    pointer-events: none;
}

/* Loading overlay para el grid */
.grid-loading-overlay {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
}

.semantic-home-wrapper {
    position: relative;
}

/* Botón cerrar Near Me */
.btn-close-nearme {
    position: absolute;
    top: 1rem;
    right: 1rem;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 1px solid rgba(255, 255, 255, 0.3);
    background: rgba(0, 0, 0, 0.3);
    color: rgba(255, 255, 255, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    z-index: 10;
    font-size: 1rem;
}

.btn-close-nearme:hover {
    background: rgba(239, 68, 68, 0.8);
    border-color: rgba(239, 68, 68, 0.9);
    color: white;
    transform: scale(1.1);
}

@media (max-width: 768px) {
    .btn-close-nearme {
        top: 0.75rem;
        right: 0.75rem;
        width: 32px;
        height: 32px;
        font-size: 0.9rem;
    }
}

/* Animación de entrada para cards */
.lugar-card-wrapper {
    animation: cardFadeIn 0.3s ease forwards;
    opacity: 0;
}

@keyframes cardFadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Stagger animation para cards */
.lugar-card-wrapper:nth-child(1) { animation-delay: 0.05s; }
.lugar-card-wrapper:nth-child(2) { animation-delay: 0.1s; }
.lugar-card-wrapper:nth-child(3) { animation-delay: 0.15s; }
.lugar-card-wrapper:nth-child(4) { animation-delay: 0.2s; }
.lugar-card-wrapper:nth-child(5) { animation-delay: 0.25s; }
.lugar-card-wrapper:nth-child(6) { animation-delay: 0.3s; }
.lugar-card-wrapper:nth-child(7) { animation-delay: 0.35s; }
.lugar-card-wrapper:nth-child(8) { animation-delay: 0.4s; }
.lugar-card-wrapper:nth-child(9) { animation-delay: 0.45s; }
.lugar-card-wrapper:nth-child(10) { animation-delay: 0.5s; }

/* Título con transición */
.semantic-home-title {
    transition: opacity 0.2s ease;
}

.semantic-home-title.updating {
    opacity: 0.6;
}

/* Mensaje de estado */
.filtro-mensaje {
    animation: fadeInUp 0.3s ease;
}

.mensaje-pill {
    display: inline-flex;
    align-items: center;
    background: rgba(17, 153, 142, 0.25);
    border: 1px solid rgba(17, 153, 142, 0.5);
    color: #a7f3d0;
    padding: 0.6rem 1.2rem;
    border-radius: 999px;
    font-size: 0.9rem;
    font-weight: 500;
}

.btn-limpiar {
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    cursor: pointer;
    padding: 0 0.25rem;
    font-size: 1rem;
    transition: all 0.2s;
}

.btn-limpiar:hover {
    color: #ef4444;
    transform: scale(1.2);
}

/* Área de resultados AJAX envuelta en sección separada */
#search-results-section {
    background:
        radial-gradient(circle at top, rgba(17, 153, 142, 0.25) 0%, transparent 50%),
        linear-gradient(135deg, #0a1628 0%, #0a3d32 35%, #0d5f4a 100%);
    padding: 3rem 0 4rem;
}

#ajax-results {
    max-width: 1120px;
    margin: 0 auto;
}

#ajax-results .card:hover {
    transform: translateY(-5px);
    transition: all 0.3s ease;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

/* Loading spinner personalizado */
#ajax-loading {
    margin-top: 2.5rem;
    position: static;   /* evitar solaparse con filtros */
    z-index: auto;
}

#ajax-loading .spinner-border {
    width: 3rem;
    height: 3rem;
    border-width: 0.3em;
}

/* Asegurar z-index controlado para dropdowns */
.dropdown-menu.show {
    z-index: 100 !important;
}

.dropdown {
    position: relative !important;
}

/* Prevenir overflow de contenido detrás de dropdowns */
.dropdown.show {
    z-index: 100 !important;
}

/* === Resultados del home - estilos de cards === */
.semantic-home-wrapper {
    background: rgba(4, 20, 12, 0.8);
    border-radius: 24px;
    padding: 2rem 1.5rem 2.25rem;
    border: 1px solid rgba(255, 255, 255, 0.12);
    box-shadow: 0 24px 55px rgba(0, 0, 0, 0.65);
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
}

@media (min-width: 992px) {
    .semantic-home-wrapper { padding: 2.25rem 2rem 2.5rem; }
}

.semantic-home-title { font-size: 2rem; }
.semantic-home-query { font-weight: 600; color: #a5f3fc; }
.semantic-home-grid { padding: 0.5rem 0; display: flex; flex-direction: column; gap: 1.25rem; }
.semantic-home-item { width: 100%; }

/* Cards en resultados del home - títulos con gradiente */
.semantic-home-wrapper .place-card__title,
.lugares-grid .place-card__title {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    background-clip: text !important;
}

/* Acciones de resultados cercanos */
.nearby-actions { max-width: 480px; margin-left: auto; margin-right: auto; }
@media (max-width: 767.98px) { .nearby-actions .btn { width: 100%; } }

/* Search Autocomplete Styling */

/* Mobile Optimizations */
@media (max-width: 768px) {
    .hero-title {
        font-size: clamp(1.75rem, 8vw, 2.5rem) !important;
        line-height: 1.15;
        margin-bottom: 1.5rem !important;
    }
    
    .hero-title br {
        display: inline;
        content: ' ';
    }
    
    .title-accent {
        display: block;
        margin-top: 0.25rem;
    }
    
    .search-modern-clean .form-control {
        font-size: 1rem;
        padding: 0.875rem 1.25rem;
    }
    
    .filtros-home {
        padding: 1.5rem;
        margin: 0 1rem;
    }
    
    .btn-filtro-dropdown {
        font-size: 0.9rem;
        padding: 0.6rem 1.2rem;
    }
    
    .dropdown-menu-filtros {
        min-width: 280px;
        max-width: 320px;
        max-height: 300px;
    }
    
    .dropdown-item-filtro {
        padding: 0.6rem;
        font-size: 0.9rem;
    }
}

/* ═══════════════════════════════════════════════════════════════
   SMALL MOBILE OPTIMIZATIONS (iPhone 15/16/16e ~ 393px)
   ═══════════════════════════════════════════════════════════════ */
@media (max-width: 430px) {
    /* Hero section ajustes */
    .hero-section-clean {
        padding-top: 60px;
        padding-bottom: 40px;
    }
    
    .hero-content {
        padding: 1.25rem 1rem 1rem 1rem;
        border-radius: 20px;
        min-height: auto;
    }
    
    /* Navegación superior compacta */
    .home-lang-switch {
        gap: 0.35rem !important;
        margin-bottom: 0.75rem !important;
    }
    
    .home-lang-switch .btn-lang-home {
        padding: 0.35rem 0.65rem !important;
        font-size: 0.75rem !important;
        min-width: auto !important;
    }
    
    /* Título más compacto */
    .hero-title {
        font-size: 1.5rem !important;
        margin-bottom: 1rem !important;
    }
    
    .title-accent {
        font-size: 1.4rem;
    }
    
    /* Barra de búsqueda */
    .search-modern-clean {
        margin-bottom: 0.75rem !important;
    }
    
    .search-modern-clean .form-control {
        font-size: 0.9rem;
        padding: 0.7rem 1rem;
    }
    
    .search-modern-clean .btn {
        padding: 0.7rem 1rem;
    }
    
    /* Filtros más compactos */
    .filtros-home {
        padding: 1rem 0.75rem;
        margin: 0 0.5rem;
        border-radius: 16px;
    }
    
    .filtros-home .row.g-3 {
        gap: 0.5rem !important;
    }
    
    .filtros-home .col-lg-4,
    .filtros-home .col-md-6 {
        padding-left: 0.25rem;
        padding-right: 0.25rem;
    }
    
    .btn-filtro-dropdown {
        font-size: 0.8rem !important;
        padding: 0.5rem 0.75rem !important;
        border-radius: 10px !important;
    }
    
    .btn-filtro-dropdown i {
        font-size: 0.9rem;
        margin-right: 0.35rem !important;
    }
    
    /* Dropdowns */
    .dropdown-menu-filtros {
        min-width: 260px;
        max-width: 300px;
        max-height: 280px;
        font-size: 0.85rem;
    }
    
    .dropdown-item-filtro {
        padding: 0.5rem;
        font-size: 0.85rem;
    }
    
    .dropdown-header {
        font-size: 0.8rem;
        padding: 0.4rem 0.6rem 0.2rem;
    }
    
    /* Botones principales */
    .btn-near-me-toggle {
        font-size: 0.85rem;
        padding: 0.6rem 1.25rem;
    }
    
    .btn-gradient-green.btn-lg {
        font-size: 0.85rem !important;
        padding: 0.6rem 1.25rem !important;
    }
    
    /* Burbujas de áreas */
    .areas-burbujas {
        padding: 0.25rem 0;
        gap: 0.3rem;
    }
    
    .areas-group-label {
        font-size: 0.7rem;
        letter-spacing: 0.1em;
    }
    
    .areas-group-bubbles {
        gap: 0.35rem;
    }
    
    .area-bubble {
        padding: 0.25rem 0.65rem;
        font-size: 0.75rem;
        border-radius: 20px;
    }
    
    .area-bubble .dot {
        width: 6px;
        height: 6px;
    }
    
    /* Resultados AJAX */
    .semantic-home-wrapper {
        padding: 1.25rem 1rem;
        border-radius: 18px;
    }
    
    .semantic-home-title {
        font-size: 1.4rem !important;
    }
    
    .semantic-home-header .lead {
        font-size: 0.9rem;
    }
    
    /* Filtros en resultados Near Me */
    .filtros-nearme-results {
        padding: 0.75rem;
        border-radius: 12px;
    }
    
    .filtros-nearme-results .btn-filtro-dropdown {
        font-size: 0.75rem !important;
        padding: 0.45rem 0.6rem !important;
    }
    
    /* Cards de lugares */
    .lugar-card-wrapper,
    .place-card-wrapper {
        margin-bottom: 0.75rem;
    }
}

/* Extra small devices (iPhone SE, older phones ~ 375px) */
@media (max-width: 375px) {
    .hero-content {
        padding: 1rem 0.75rem 0.75rem 0.75rem;
    }
    
    .hero-title {
        font-size: 1.35rem !important;
    }
    
    .home-lang-switch .btn-lang-home {
        padding: 0.3rem 0.5rem !important;
        font-size: 0.7rem !important;
    }
    
    .filtros-home {
        padding: 0.75rem 0.5rem;
        margin: 0;
    }
    
    .btn-filtro-dropdown {
        font-size: 0.75rem !important;
        padding: 0.45rem 0.6rem !important;
    }
    
    .btn-near-me-toggle,
    .btn-gradient-green.btn-lg {
        font-size: 0.8rem !important;
        padding: 0.55rem 1rem !important;
    }
    
    .area-bubble {
        padding: 0.2rem 0.5rem;
        font-size: 0.7rem;
    }
}

/* Degradados para botones - Máxima especificidad */
.btn.btn-gradient-purple, 
a.btn.btn-gradient-purple,
button.btn.btn-gradient-purple {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
    border: none !important;
    color: white !important;
    font-weight: 600 !important;
    transition: all 0.3s ease !important;
    box-shadow: none !important;
}

.btn.btn-gradient-purple:hover, 
a.btn.btn-gradient-purple:hover,
button.btn.btn-gradient-purple:hover,
.btn.btn-gradient-purple:focus,
a.btn.btn-gradient-purple:focus {
    background: linear-gradient(135deg, #0e8678 0%, #32d86a 100%) !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4) !important;
    color: white !important;
    border: none !important;
}

.btn.btn-gradient-green,
a.btn.btn-gradient-green,
button.btn.btn-gradient-green {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
    border: none !important;
    color: white !important;
    font-weight: 600 !important;
    transition: all 0.3s ease !important;
    box-shadow: none !important;
}

.btn.btn-gradient-green:hover,
a.btn.btn-gradient-green:hover,
button.btn.btn-gradient-green:hover,
.btn.btn-gradient-green:focus,
a.btn.btn-gradient-green:focus {
    background: linear-gradient(135deg, #0e8678 0%, #32d86a 100%) !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4) !important;
    color: white !important;
    border: none !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Idioma (normalizado). Django puede entregar 'en-us', 'en', etc.
const CURRENT_LANG_RAW = ('{{ LANGUAGE_CODE|default:"es" }}' || 'es').toLowerCase();
const CURRENT_LANG = CURRENT_LANG_RAW.slice(0, 2); // 'es' | 'en'
// Helper seguro para traducciones en JS (usa djangojs si está disponible)
const gettext = (window.gettext) ? window.gettext : (s => s);
// Fallbacks para pluralización/interpolación si por algún motivo jsi18n no cargó (evita que el JS se rompa en EN)
const ngettext = (window.ngettext) ? window.ngettext : ((singular, plural, count) => (Number(count) === 1 ? singular : plural));
const interpolate = (window.interpolate) ? window.interpolate : ((fmt, obj) => {
    try {
        // Regex para %(key)s - construido sin backslashes problemáticos en templates
        const re = new RegExp('%[(]([^)]+)[)]s', 'g');
        return String(fmt).replace(re, (_, k) => (obj && obj[k] !== undefined ? obj[k] : ''));
    } catch (_) {
        return String(fmt);
    }
});

// Helper global para rango de precios (coherente con form_tags.format_price_range)
function formatPriceRangeJs(raw) {
    if (!raw) return '';
    const val = String(raw).toUpperCase();
    const map = {
        '$': '$',
        '$$': '$$',
        '$$$': '$$$',
        '$$$$': '$$$$',
        'PRICE_LEVEL_INEXPENSIVE': '$',
        'PRICE_LEVEL_MODERATE': '$$',
        'PRICE_LEVEL_EXPENSIVE': '$$$',
        'PRICE_LEVEL_VERY_EXPENSIVE': '$$$$',
    };
    if (map[val]) return map[val];
    if (/^\$+$/.test(val) && val.length <= 4) return val;
    return '';
}

// ═══════════════════════════════════════════════════════════════════
// FUNCIÓN GLOBAL: Genera HTML de card idéntica al componente place_card.html
// Usa clases BEM: place-card__* para consistencia total
// ═══════════════════════════════════════════════════════════════════
function generarPlaceCardHtml(lugar, opciones = {}) {
    const T = {
        viewDetails: opciones.viewDetails || '{% trans "Ver detalles" %}',
        featured: opciones.featured || '{% trans "Destacado" %}',
        exclusive: opciones.exclusive || '{% trans "Exclusivo" %}',
        top: opciones.top || '{% trans "Top" %}'
    };
    
    // Distancia formateada
    const distancia = lugar.distancia_km || lugar.distancia;
    const distanciaStr = distancia ? (distancia < 1 ? `${Math.round(distancia * 1000)} m` : `${Number(distancia).toFixed(1)} km`) : '';
    
    // Precio formateado
    const precio = formatPriceRangeJs(lugar.precio);
    
    // URL
    const url = lugar.url || (typeof buildPlaceUrl === 'function' ? buildPlaceUrl(lugar.slug, null) : `/lugar/${lugar.slug}/`);
    
    // Imagen con fallback a original si falla, luego placeholder
    const imagenFull = lugar.imagen_full || '';
    const imgAlt = (lugar.nombre || '').replace(/"/g, '&quot;');
    let imagenHtml;
    if (lugar.imagen) {
        const errorHandler = imagenFull 
            ? `this.onerror=function(){this.style.display='none';this.nextElementSibling.style.display='flex';};this.src='${imagenFull}';`
            : `this.style.display='none';this.nextElementSibling.style.display='flex';`;
        imagenHtml = `
            <img src="${lugar.imagen}" class="place-card__img" alt="${imgAlt}" loading="lazy" onerror="${errorHandler}">
            <div class="place-card__placeholder" style="display:none;"><i class="bi bi-image"></i></div>`;
    } else {
        imagenHtml = `<div class="place-card__placeholder"><i class="bi bi-image"></i></div>`;
    }
    
    // Rating badge con número de reviews
    let ratingHtml = '';
    if (typeof lugar.rating === 'number') {
        const reviewsCount = lugar.total_reviews ? `<small class="place-card__reviews">(${lugar.total_reviews})</small>` : '';
        ratingHtml = `<div class="place-card__rating"><i class="bi bi-star-fill"></i><span>${lugar.rating.toFixed(1)}</span>${reviewsCount}</div>`;
    }
    
    // Distance badge
    const distanceHtml = distanciaStr 
        ? `<div class="place-card__distance"><i class="bi bi-geo-alt"></i><span>${distanciaStr}</span></div>` 
        : '';
    
    // Badges
    let badgesHtml = `<span class="place-card__badge place-card__badge--type"><i class="bi bi-geo-alt"></i>${lugar.tipo || ''}</span>`;
    if (lugar.es_destacado) {
        badgesHtml += `<span class="place-card__badge place-card__badge--featured"><i class="bi bi-star-fill"></i>${T.featured}</span>`;
    }
    if (lugar.es_exclusivo) {
        badgesHtml += `<span class="place-card__badge place-card__badge--exclusive"><i class="bi bi-gem"></i>${T.exclusive}</span>`;
    }
    if (typeof lugar.rating === 'number' && lugar.rating >= 4.5) {
        badgesHtml += `<span class="place-card__badge place-card__badge--top-rated"><i class="bi bi-award"></i>${T.top}</span>`;
    }
    
    // Precio
    const precioHtml = precio 
        ? `<div class="place-card__meta"><i class="bi bi-cash-stack"></i><span>${precio}</span></div>` 
        : '';
    
    // Dirección (truncada a 45 chars)
    const direccion = lugar.direccion ? lugar.direccion.substring(0, 45) + (lugar.direccion.length > 45 ? '...' : '') : '';
    const direccionHtml = direccion 
        ? `<div class="place-card__address"><i class="bi bi-map"></i><span>${direccion}</span></div>` 
        : '';
    
    // CTA
    const ctaHtml = lugar.slug 
        ? `<a href="${url}" class="place-card__cta"><i class="bi bi-eye"></i>${T.viewDetails}</a>` 
        : '';
    
    return `
        <div class="place-card-wrapper">
            <article class="place-card place-card--horizontal">
                <div class="place-card__media">
                    ${imagenHtml}
                    ${ratingHtml}
                    ${distanceHtml}
                </div>
                <div class="place-card__body">
                    <h3 class="place-card__title">${lugar.nombre}</h3>
                    <div class="place-card__badges">${badgesHtml}</div>
                    ${precioHtml}
                    ${direccionHtml}
                    ${ctaHtml}
                </div>
            </article>
        </div>`;
}

// Helper para construir la URL del detalle de un lugar
function buildPlaceUrl(slug, backendUrl) {
    if (backendUrl) return backendUrl;
    if (!slug) return null;
    if (CURRENT_LANG === 'es') {
        return `/lugar/${slug}/`;
    }
    return `/en/place/${slug}/`;
}

// Helper para construir la URL de lista de lugares (con o sin comuna)
function buildPlacesListUrl(areaSlug) {
    if (!areaSlug) {
        // Usa la URL i18n de Django para la lista general
        return '{% url "explorer:lugares_list" %}';
    }
    if (CURRENT_LANG === 'es') {
        return `/lugares/${areaSlug}/`;
    }
    // Versión traducida de "lugares/" -> "places/"
    return `/en/places/${areaSlug}/`;
}

// Búsqueda semántica (Enter o botón)
$(document).ready(function() {
    function ejecutarBusquedaSemantica(texto) {
        if (!texto || texto.length < 2) return;
        $('#ajax-loading').show();
        $('#ajax-results').hide();
        $('#search-results-section').hide();
        $.ajax({
            url: "{% url 'explorer:semantic_search_ajax' %}",
            type: 'GET',
            data: { q: texto, top: 12 },
            success: function(resp) {
                $('#ajax-loading').hide();
                if (resp.success) {
                    renderizarResultadosSemanticos(resp);
                } else {
                    mostrarError(gettext('Error en búsqueda semántica') + ': ' + resp.error);
                }
            },
            error: function(xhr, status, error) {
                $('#ajax-loading').hide();
                mostrarError(gettext('Error de conexión') + ': ' + error);
            }
        });
    }
    $('#search-places').on('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            ejecutarBusquedaSemantica($(this).val().trim());
        }
    });
    $('.search-modern-clean button').on('click', function() {
        ejecutarBusquedaSemantica($('#search-places').val().trim());
    });
    
    // Smooth scroll for anchor links
    $('a[href^="#"]').on('click', function(e) {
        e.preventDefault();
        const target = $(this.getAttribute('href'));
        if(target.length) {
            $('html, body').animate({
                scrollTop: target.offset().top - 80
            }, 800);
        }
    });
    
    // Variables para almacenar selecciones
    let filtrosSeleccionados = {
        area: null,
        categoria: null,
        caracteristica: null
    };
    
    // Variable para almacenar ubicación del usuario
    let ubicacionUsuario = null;

    // Control de búsquedas: auto-búsqueda con debounce y una sola request activa
    let currentSearchRequest = null;
    let searchTimeoutId = null;
    const SEARCH_DEBOUNCE_MS = 600;
    
    // Cerrar dropdowns al hacer scroll (sin romper futuros clics)
    $(window).on('scroll', function() {
        $('.dropdown-menu.show').removeClass('show').css('display', '');
        $('.dropdown.show').removeClass('show');
        $('[data-bs-toggle="dropdown"][aria-expanded="true"]').attr('aria-expanded', 'false');
    });
    
    // Configurar dropdowns para que siempre se abran hacia abajo
    document.addEventListener('show.bs.dropdown', function(event) {
        // Forzar posición hacia abajo
        const dropdown = event.target;
        const menu = dropdown.nextElementSibling;
        
        if (menu && menu.classList.contains('dropdown-menu-filtros')) {
            // Configurar Popper.js para forzar posición bottom
            menu.setAttribute('data-bs-popper', 'static');
            
            // Aplicar estilos directamente para forzar posición
            setTimeout(() => {
                menu.style.position = 'absolute';
                menu.style.top = '100%';
                menu.style.bottom = 'auto';
                menu.style.left = '0';
                menu.style.right = 'auto';
                menu.style.transform = 'none';
                menu.style.inset = 'auto';
            }, 10);
        }
    });
    
    // Función para actualizar estado de filtros
    function actualizarEstadoFiltros() {
        const requiredCount = (filtrosSeleccionados.area !== null ? 1 : 0) + (filtrosSeleccionados.categoria !== null ? 1 : 0);
        const totalCount = Object.values(filtrosSeleccionados).filter(v => v !== null).length;
        
        // Texto simple y robusto para el contador (evita depender de ngettext en JS)
        let countLabel;
        if (CURRENT_LANG === 'en') {
            countLabel = `${requiredCount}/2 required`;
        } else {
            countLabel = `${requiredCount}/2 obligatorios`;
        }
        $('#filtros-count').text(countLabel);
        
        if (totalCount > 0) {
            $('#filtros-estado').show();
            
            // Actualizar resumen
            let resumen = [];
            if (filtrosSeleccionados.area) resumen.push(`📍 ${filtrosSeleccionados.area.name}`);
            if (filtrosSeleccionados.categoria) resumen.push(`🏢 ${filtrosSeleccionados.categoria.name}`);
        if (filtrosSeleccionados.caracteristica) resumen.push(`⭐ ${filtrosSeleccionados.caracteristica.name}`);
            $('#filtros-resumen').html(resumen.join(' • '));
            
            // Solo requiere área y categoría para habilitar búsqueda
            if (requiredCount === 2) {
                $('#buscar-btn').show().prop('disabled', false);
                // Disparar auto-búsqueda con debounce
                programarBusquedaAuto();
            } else {
                $('#buscar-btn').prop('disabled', true);
            }
        } else {
            $('#filtros-estado').hide();
            $('#buscar-btn').hide();
        }
    }
    
    // Función para limpiar filtros
    function limpiarFiltros() {
        filtrosSeleccionados = {
            area: null,
            categoria: null,
            caracteristica: null
        };
        
        // Resetear UI de áreas
        $('#area-selected-text').text(gettext('Seleccionar Área'));
        $('#area-check').hide();
        $('#areasDropdown').removeClass('selected');
        
        // Resetear UI de categorías
        $('#categoria-selected-text').text(gettext('Seleccionar Tipo'));
        $('#categoria-check').hide();
        $('#categoriasDropdown').removeClass('selected');
        
        // Resetear UI de características
        $('#caracteristica-selected-text').text(gettext('Características'));
        $('#caracteristica-check').hide();
        $('#etiquetasDropdown').removeClass('selected');
        
        // Cancelar búsquedas pendientes
        if (searchTimeoutId) {
            clearTimeout(searchTimeoutId);
            searchTimeoutId = null;
        }
        if (currentSearchRequest) {
            currentSearchRequest.abort();
            currentSearchRequest = null;
        }

        // Ocultar resultados y estado
        $('#ajax-results').hide();
        $('#search-results-section').hide();
        $('#filtros-estado').hide();
        $('#buscar-btn').hide();
        
        actualizarEstadoFiltros();
    }
    
    // Botón para limpiar filtros
    $('#limpiar-filtros-btn').on('click', function(e) {
        e.preventDefault();
        limpiarFiltros();
    });
    
    // Manejar selección de área
    $('.area-option').on('click', function(e) {
        e.preventDefault();
        filtrosSeleccionados.area = {
            id: $(this).data('area-id'),
            name: $(this).data('area-name'),
            slug: $(this).data('area-slug')
        };
        $('#area-selected-text').text(filtrosSeleccionados.area.name);
        $('#area-check').show();
        $('#areasDropdown').addClass('selected');
        $('#areasDropdown').dropdown('hide');
        actualizarEstadoFiltros();
    });
    
    // Manejar selección de categoría
    $('.categoria-option').on('click', function(e) {
        e.preventDefault();
        filtrosSeleccionados.categoria = {
            id: $(this).data('categoria-id'),
            name: $(this).data('categoria-name')
        };
        $('#categoria-selected-text').text(filtrosSeleccionados.categoria.name);
        $('#categoria-check').show();
        $('#categoriasDropdown').addClass('selected');
        $('#categoriasDropdown').dropdown('hide');
        actualizarEstadoFiltros();
    });
    
    // Manejar selección de característica
    $('.caracteristica-option').on('click', function(e) {
        e.preventDefault();
        const caracteristicaId = $(this).data('caracteristica-id');
        const caracteristicaName = $(this).data('caracteristica-name');
        
        if (caracteristicaId === 'none') {
            filtrosSeleccionados.caracteristica = null;
            $('#caracteristica-selected-text').text(gettext('Características (Opcional)'));
            $('#caracteristica-check').hide();
            $('#etiquetasDropdown').removeClass('selected');
        } else {
            filtrosSeleccionados.caracteristica = {
                id: caracteristicaId,
                name: caracteristicaName
            };
            $('#caracteristica-selected-text').text(filtrosSeleccionados.caracteristica.name);
            $('#caracteristica-check').show();
            $('#etiquetasDropdown').addClass('selected');
        }
        
        $('#etiquetasDropdown').dropdown('hide');
        actualizarEstadoFiltros();
    });
    
    // Programar auto-búsqueda (debounced)
    function programarBusquedaAuto() {
        // Solo buscar si tenemos área y categoría
        if (!filtrosSeleccionados.area || !filtrosSeleccionados.categoria) {
            return;
        }

        if (searchTimeoutId) {
            clearTimeout(searchTimeoutId);
        }

        searchTimeoutId = setTimeout(ejecutarBusquedaFiltros, SEARCH_DEBOUNCE_MS);
    }

    // Ejecutar búsqueda AJAX (garantizando una sola request activa)
    function ejecutarBusquedaFiltros() {
        searchTimeoutId = null;

        if (!filtrosSeleccionados.area || !filtrosSeleccionados.categoria) {
            return;
        }

        // Cancelar request anterior si sigue en curso
        if (currentSearchRequest && currentSearchRequest.readyState !== 4) {
            currentSearchRequest.abort();
        }

        // Mostrar loading
        $('#ajax-loading').show();
        $('#ajax-results').hide();
        $('#search-results-section').hide();

        currentSearchRequest = $.ajax({
            url: "{% url 'explorer:filtros_ajax' %}",
            type: 'GET',
            data: {
                area: filtrosSeleccionados.area.id,
                categoria: filtrosSeleccionados.categoria.id,
                caracteristica: filtrosSeleccionados.caracteristica ? filtrosSeleccionados.caracteristica.id : 'all'
            },
            success: function(response) {
                $('#ajax-loading').hide();
                
                if (response.success) {
                    renderizarResultados(response);
                } else {
                    mostrarError('Error en la búsqueda: ' + response.error);
                }
            },
            error: function(xhr, status, error) {
                if (status === 'abort') {
                    // Búsqueda cancelada por una nueva, no mostrar error
                    return;
                }
                $('#ajax-loading').hide();
                mostrarError('Error de conexión: ' + error);
            },
            complete: function() {
                currentSearchRequest = null;
            }
        });
    }

    // Botón "Buscar Lugares" como disparador manual adicional (sin debounce)
    $('#buscar-btn').on('click', function() {
        ejecutarBusquedaFiltros();
    });
    
    // Función para generar URL completa con slugs
    function generarUrlCompleta(data) {
        let baseUrl;
        let params = new URLSearchParams();
        
        // Priorizar slug de área seleccionada, luego del area_info del response
        let areaSlug = null;
        if (filtrosSeleccionados.area && filtrosSeleccionados.area.slug) {
            areaSlug = filtrosSeleccionados.area.slug;
        } else if (data.area_info && data.area_info.slug) {
            areaSlug = data.area_info.slug;
        }
        
        // Usar helper que respeta el idioma actual
        baseUrl = buildPlacesListUrl(areaSlug);
        if (!areaSlug && filtrosSeleccionados.area) {
            // Cuando no tenemos slug pero sí id de comuna, añadirlo como query param
            params.append('comuna', filtrosSeleccionados.area.id);
        }
        
        // Agregar otros filtros como parámetros
        if (filtrosSeleccionados.categoria && filtrosSeleccionados.categoria.id !== 'all') {
            params.append('tipo', filtrosSeleccionados.categoria.id);
        }
        
        if (filtrosSeleccionados.caracteristica && filtrosSeleccionados.caracteristica.id !== 'all') {
            params.append(filtrosSeleccionados.caracteristica.id, 'true');
        }
        
        // Construir URL final
        return params.toString() ? `${baseUrl}?${params.toString()}` : baseUrl;
    }
    
    // Función para renderizar resultados
    function renderizarResultados(data) {
        // Cerrar TODOS los dropdowns de forma agresiva (pero sin dejar inline display:none)
        $('.dropdown-menu-filtros').removeClass('show').css('display', '');
        $('.dropdown-menu').removeClass('show').css('display', '');
        $('.dropdown').removeClass('show');
        $('[data-bs-toggle="dropdown"]').attr('aria-expanded', 'false').removeClass('show');
        
        // Forzar cierre con Bootstrap API (si existe; bootstrap bundle carga con defer)
        if (window.bootstrap && window.bootstrap.Dropdown) {
            document.querySelectorAll('[data-bs-toggle="dropdown"]').forEach(btn => {
                const dropdown = window.bootstrap.Dropdown.getInstance(btn);
                if (dropdown) dropdown.hide();
            });
        }
        
        // Mensaje de resultados: usar ngettext si está disponible, si no, fallback simple (ES)
        let msgResultados;
        if (typeof ngettext === 'function' && typeof interpolate === 'function') {
            msgResultados = interpolate(
                ngettext(
                    'Encontramos %s lugar que coincide con tus filtros',
                    'Encontramos %s lugares que coinciden con tus filtros',
                    data.total
                ),
                [data.total]
            );
        } else {
            msgResultados = data.total === 1
                ? `Encontramos ${data.total} lugar que coincide con tus filtros`
                : `Encontramos ${data.total} lugares que coinciden con tus filtros`;
        }

        let html = `
            <div class="semantic-home-wrapper">
                <div class="semantic-home-header text-center mb-4 text-white">
                    <h2 class="fw-bold semantic-home-title">{% trans "Resultados de tu Búsqueda" %}</h2>
                    <p class="lead mb-0">${msgResultados}</p>
                    <div class="mt-3">
                        <span class="badge bg-primary bg-opacity-20 text-white fs-6 px-3 py-2 me-2">
                            📍 ${filtrosSeleccionados.area.name}
                        </span>
                        <span class="badge bg-primary bg-opacity-20 text-white fs-6 px-3 py-2 me-2">
                            🏢 ${filtrosSeleccionados.categoria.name}
                        </span>
                        ${filtrosSeleccionados.caracteristica ? 
                            `<span class="badge bg-primary bg-opacity-20 text-white fs-6 px-3 py-2">
                                ⭐ ${filtrosSeleccionados.caracteristica.name}
                            </span>` : 
                            `<span class="badge bg-secondary bg-opacity-20 text-white fs-6 px-3 py-2">${gettext('Sin filtro especial')}</span>`
                        }
                    </div>
                </div>
                
                <div class="semantic-home-grid lugares-grid">
        `;
        
        // Usar función estandarizada para generar cards
        data.lugares.forEach(lugar => {
            html += generarPlaceCardHtml(lugar);
        });
        
        html += `
                </div>
                
                <div class="text-center mt-5">
                    <a href="${generarUrlCompleta(data)}" 
                       class="btn btn-outline-light btn-lg rounded-pill px-4">
                        <i class="bi bi-arrow-right me-2"></i>{% trans "Ver Todos los Resultados" %}
                    </a>
                </div>
            </div>
        `;
        
        $('#ajax-results').html(html).show();
        $('#search-results-section').show();
        
        // Scroll suave a los resultados
        $('html, body').animate({
            scrollTop: $('#ajax-results').offset().top - 100
        }, 800);
    }
    
    // Función para mostrar errores
    function mostrarError(mensaje) {
        $('#ajax-results').html(`
            <div class="container py-5">
                <div class="text-center text-white">
                    <i class="bi bi-exclamation-triangle fs-1 text-warning mb-3"></i>
                    <h3>{% trans "¡Ups! Algo salió mal" %}</h3>
                    <p class="lead">${mensaje}</p>
                    <button class="btn btn-outline-light" onclick="location.reload();">
                        <i class="bi bi-arrow-clockwise me-2"></i>{% trans "Intentar de nuevo" %}
                    </button>
                </div>
            </div>
        `).show();
    }
    
    // ═══════════════════════════════════════════════════════════════
    // NEAR ME - GEOLOCALIZACIÓN PROFESIONAL
    // ═══════════════════════════════════════════════════════════════
    
    // Estado global de Near Me
    let nearMeActivo = false;
    let tipoNearMe = null;
    let featureNearMe = null;
    let radioDistancia = 2;
    
    // Labels traducidos - TODOS los tipos
    const TIPOS_LABELS = {
        'restaurant': '{% trans "Restaurantes" %}',
        'bar': '{% trans "Bares" %}',
        'cafe': '{% trans "Cafés" %}',
        'bakery': '{% trans "Panaderías" %}',
        'night_club': '{% trans "Discotecas" %}',
        'rooftop_bar': '{% trans "Rooftops" %}',
        'karaoke': '{% trans "Karaokes" %}',
        'sports_bar': '{% trans "Bares Deportivos" %}',
        'casino': '{% trans "Casinos" %}',
        'bowling_alley': '{% trans "Boleras" %}',
        'spa': '{% trans "Spas" %}',
        'art_gallery': '{% trans "Galerías de Arte" %}',
        'museum': '{% trans "Museos" %}',
        'tourist_attraction': '{% trans "Atracciones Turísticas" %}',
        'all': '{% trans "Todos" %}'
    };
    
    // Labels traducidos - TODAS las características
    const FEATURES_LABELS = {
        'outdoor_seating': '{% trans "Terraza" %}',
        'live_music': '{% trans "Música en Vivo" %}',
        'good_for_groups': '{% trans "Para Grupos" %}',
        'good_for_children': '{% trans "Para Niños" %}',
        'delivery': '{% trans "Delivery" %}',
        'takeout': '{% trans "Para Llevar" %}',
        'dine_in': '{% trans "Comer en Local" %}',
        'reservable': '{% trans "Reservaciones" %}',
        'serves_cocktails': '{% trans "Cócteles" %}',
        'serves_wine': '{% trans "Vinos" %}',
        'serves_coffee': '{% trans "Café Especialidad" %}',
        'serves_dessert': '{% trans "Postres" %}',
        'allows_dogs': '{% trans "Pet Friendly" %}',
        'wheelchair_accessible_entrance': '{% trans "Acceso Accesible" %}',
        'accepts_credit_cards': '{% trans "Tarjetas de Crédito" %}'
    };
    
    // Textos
    const T_NEAR_ME = '{% trans "Cerca de Mí" %}';
    const T_LOCATING = '{% trans "Localizando..." %}';
    const T_ACTIVE = '{% trans "GPS Activo" %}';
    
    // Click handler para Near Me
    $('#cerca-de-mi-btn').on('click', function() {
        if (nearMeActivo) {
            desactivarNearMe();
        } else {
            activarNearMe();
        }
    });
    
    // Exponer funciones globalmente
    window.activarNearMe = activarNearMe;
    window.desactivarNearMe = desactivarNearMe;

    function activarNearMe() {
        const $btn = $('#cerca-de-mi-btn');
        const $text = $('#ubicacion-text');
        const $icon = $('#ubicacion-icon');
        
        // Verificar soporte
        if (!navigator.geolocation) {
            mostrarErrorNearMe('{% trans "Tu navegador no soporta geolocalización" %}');
            return;
        }
        
        // Estado: localizando
        $btn.addClass('locating').removeClass('active error');
        $text.text(T_LOCATING);
        
        // Solicitar ubicación
        navigator.geolocation.getCurrentPosition(
            // Éxito
            function(pos) {
                ubicacionUsuario = {
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude,
                    accuracy: pos.coords.accuracy
                };
                nearMeActivo = true;
                
                // UI: activo
                $btn.removeClass('locating').addClass('active');
                $text.text(T_ACTIVE + ' ✓');
                
                // Deshabilitar área y buscar
                deshabilitarSelectArea();
                buscarLugaresCercanos();
            },
            // Error
            function(err) {
                $btn.removeClass('locating').addClass('error');
                let msg = '{% trans "Error de ubicación" %}';
                
                if (err.code === 1) msg = '{% trans "Permiso denegado. Habilita la ubicación." %}';
                else if (err.code === 2) msg = '{% trans "Ubicación no disponible" %}';
                else if (err.code === 3) msg = '{% trans "Tiempo de espera agotado" %}';
                
                $text.text(msg);
                
                // Reset después de 3s
                setTimeout(() => {
                    $btn.removeClass('error');
                    $text.text(T_NEAR_ME);
                }, 3000);
            },
            // Opciones
            { enableHighAccuracy: true, timeout: 12000, maximumAge: 60000 }
        );
    }
    
    function desactivarNearMe() {
        nearMeActivo = false;
        nearMeResultsVisible = false;
        tipoNearMe = null;
        featureNearMe = null;
        ubicacionUsuario = null;
        
        const $btn = $('#cerca-de-mi-btn');
        $btn.removeClass('active locating error');
        $('#ubicacion-text').text(T_NEAR_ME);
        
        habilitarSelectArea();
        $('#ajax-results').fadeOut(200);
        $('#search-results-section').fadeOut(200);
        
        // Scroll suave de vuelta al hero
        $('html, body').animate({
            scrollTop: $('.hero-section-clean').offset().top
        }, 400);
    }
    
    function mostrarErrorNearMe(msg) {
        const $btn = $('#cerca-de-mi-btn');
        $btn.removeClass('locating active').addClass('error');
        $('#ubicacion-text').text(msg);
        
        setTimeout(() => {
            $btn.removeClass('error');
            $('#ubicacion-text').text(T_NEAR_ME);
        }, 3000);
    }
    
    // Exclusividad: Near Me vs Select Area
    function deshabilitarSelectArea() {
        // Limpiar selección de área
        filtrosSeleccionados.area = null;
        $('#area-selected-text').text('{% trans "Usando Near Me" %}');
        $('#area-check').hide();
        $('#areasDropdown').addClass('disabled').prop('disabled', true);
        
        // Deshabilitar visualmente el dropdown
        $('#areasDropdown').css({
            'opacity': '0.5',
            'pointer-events': 'none'
        });
    }
    
    function habilitarSelectArea() {
        $('#areasDropdown').removeClass('disabled').prop('disabled', false);
        $('#area-selected-text').text(gettext('Seleccionar Área'));
        $('#areasDropdown').css({
            'opacity': '1',
            'pointer-events': 'auto'
        });
                }
                
    // Si el usuario selecciona un área, desactivar Near Me
    $('.area-option').on('click', function() {
        if (nearMeActivo) {
            desactivarNearMe();
        }
    });
    
    // Flag para saber si es una actualización de filtros
    let nearMeResultsVisible = false;
    
    function buscarLugaresCercanos(esActualizacion = false) {
        if (!ubicacionUsuario) {
            mostrarErrorNearMe('{% trans "Ubicación no disponible" %}');
            return;
        }
        
        // Si ya hay resultados visibles, solo mostrar loading en el grid
        if (esActualizacion && nearMeResultsVisible) {
            $('.semantic-home-grid').addClass('loading');
            $('.semantic-home-title').addClass('updating');
        } else {
        $('#ajax-loading').show();
        $('#ajax-results').hide();
            $('#search-results-section').hide();
        }
        
        // Construir datos de la petición
        const requestData = {
            lat: ubicacionUsuario.lat,
            lng: ubicacionUsuario.lng,
            radio: radioDistancia
        };
        
        // Agregar tipo si está seleccionado
        if (tipoNearMe) {
            requestData.tipo = tipoNearMe;
        }
        
        // Agregar característica si está seleccionada (desde chips o dropdown)
        if (featureNearMe) {
            requestData.caracteristica = featureNearMe;
        } else if (filtrosSeleccionados.caracteristica && filtrosSeleccionados.caracteristica.id !== 'none') {
            requestData.caracteristica = filtrosSeleccionados.caracteristica.id;
        }
        
        // Llamada AJAX
        $.ajax({
            url: "{% url 'explorer:lugares_cercanos_near_me' %}",
            type: 'GET',
            data: requestData,
            success: function(response) {
                $('#ajax-loading').hide();
                if (response.success) {
                    renderizarResultadosCercanos(response);
                } else {
                    mostrarError(response.error || '{% trans "Error en la búsqueda" %}');
                }
            },
            error: function(xhr, status, error) {
                $('#ajax-loading').hide();
                mostrarError('{% trans "Error de conexión" %}');
            }
        });
    }
    
    // Botón buscar (unificado)
    $('#buscar-btn').on('click', function() {
        if (nearMeActivo && ubicacionUsuario) {
            buscarLugaresCercanos();
        } else if (filtrosSeleccionados.area && filtrosSeleccionados.categoria) {
            ejecutarBusquedaFiltros();
        }
    });
    
    function renderizarResultadosCercanos(data) {
        // Cerrar TODOS los dropdowns de forma agresiva (pero sin forzar display:none permanente)
        $('.dropdown-menu-filtros').removeClass('show').css('display', '');
        $('.dropdown-menu').removeClass('show').css('display', '');
        $('.dropdown').removeClass('show');
        $('[data-bs-toggle="dropdown"]').attr('aria-expanded', 'false').removeClass('show');
        
        // Forzar cierre con Bootstrap API (si existe; bootstrap bundle carga con defer)
        if (window.bootstrap && window.bootstrap.Dropdown) {
            document.querySelectorAll('[data-bs-toggle="dropdown"]').forEach(btn => {
                const dropdown = window.bootstrap.Dropdown.getInstance(btn);
                if (dropdown) dropdown.hide();
            });
        }
        
        // Textos traducidos inyectados desde servidor
        const T_VIEW_DETAILS = '{% trans "Ver detalles" %}';
        const T_NO_DETAILS = '{% trans "Sin detalles" %}';
        const T_FEATURED = '{% trans "Destacado" %}';
        const T_EXCLUSIVE = '{% trans "Exclusivo" %}';
        const T_TOP_RATED = '{% trans "Top Valorado" %}';
        const T_PLACES_NEAR = '{% trans "Lugares cerca de mí" %}';
        const T_NEAR_ME = '{% trans "cerca de mí" %}';
        const T_WITH = '{% trans "con" %}';
        const T_PLACES_WITH = '{% trans "Lugares con" %}';
        const T_NO_RESULTS = '{% trans "Sin resultados" %}';
        const T_TRY_EXPANDING = '{% trans "Intenta ampliar el radio de búsqueda" %}';
        
        // ═══════════════════════════════════════════════════════════════
        // USAR DATOS REALES DEL BACKEND (no variables locales)
        // ═══════════════════════════════════════════════════════════════
        const filtros = data.filtros_aplicados || {};
        const tipoLabelReal = filtros.tipo_label || '';
        const featureLabelReal = filtros.caracteristica_label || '';
        const radioReal = filtros.radio_km || radioDistancia;
        const radioDisplay = filtros.radio_display || `${radioReal}km`;
        const totalReal = data.total || 0;
        
        // Sincronizar variables locales con datos reales del backend
        tipoNearMe = filtros.tipo || null;
        featureNearMe = filtros.caracteristica || null;
        radioDistancia = radioReal;
        
        // Construir título basado en datos REALES
        let titulo;
        if (totalReal === 0) {
            titulo = T_NO_RESULTS;
        } else if (tipoLabelReal && featureLabelReal) {
            titulo = `${totalReal} ${tipoLabelReal} ${T_WITH} ${featureLabelReal}`;
        } else if (tipoLabelReal) {
            titulo = `${totalReal} ${tipoLabelReal} ${T_NEAR_ME}`;
        } else if (featureLabelReal) {
            titulo = `${totalReal} ${T_PLACES_WITH} ${featureLabelReal}`;
        } else {
            titulo = `${totalReal} ${T_PLACES_NEAR}`;
        }
        
        // Subtítulo: usar mensaje del backend (ya viene traducido y formateado)
        let subtitulo = data.mensaje || '';
        if (totalReal === 0) {
            subtitulo = `${data.mensaje}<br><small class="text-muted">${T_TRY_EXPANDING}</small>`;
        }
        
        // Construir badges con datos reales
        const filtrosActivos = [];
        if (tipoLabelReal) {
            filtrosActivos.push(`<span class="badge bg-success bg-opacity-25 text-white me-1"><i class="bi bi-check2 me-1"></i>${tipoLabelReal}</span>`);
        }
        if (featureLabelReal) {
            filtrosActivos.push(`<span class="badge bg-info bg-opacity-25 text-white me-1"><i class="bi bi-check2 me-1"></i>${featureLabelReal}</span>`);
        }
        filtrosActivos.push(`<span class="badge bg-warning bg-opacity-25 text-white"><i class="bi bi-geo-alt me-1"></i>${radioDisplay}</span>`);
        
        const filtrosHtml = `<div class="mt-2">${filtrosActivos.join('')}</div>`;
        
        // Labels para dropdowns (basados en datos reales)
        const tipoSelectedLabel = tipoLabelReal || '{% trans "Tipo" %}';
        const featureSelectedLabel = featureLabelReal || '{% trans "Características" %}';
        
        let html = `
            <div class="semantic-home-wrapper">
                <!-- Botón cerrar -->
                <button class="btn-close-nearme" onclick="window.desactivarNearMe()" title="{% trans 'Cerrar' %}">
                    <i class="bi bi-x-lg"></i>
                </button>
                
                <div class="semantic-home-header text-center mb-4 text-white">
                    <h2 class="fw-bold semantic-home-title">${titulo}</h2>
                    <p class="lead mb-0">${subtitulo}</p>
                    ${filtrosHtml}
                    
                    <!-- Filtros completos -->
                    <div class="filtros-nearme-results mt-4">
                        <div class="row g-2 justify-content-center">
                            
                            <!-- Dropdown: Tipo (COMPLETO) -->
                            <div class="col-lg-3 col-md-4 col-6">
                                <div class="dropdown">
                                    <button class="btn btn-filtro-dropdown w-100 dropdown-toggle ${tipoNearMe ? 'selected' : ''}" type="button"
                                            id="tipoNearMeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-grid-3x3-gap me-2"></i>
                                        <span>${tipoSelectedLabel}</span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-filtros shadow-lg" aria-labelledby="tipoNearMeDropdown">
                                        <li><a class="dropdown-item dropdown-item-filtro tipo-nearme-option" href="javascript:void(0)" data-tipo="">
                                            <i class="bi bi-grid me-2 text-primary"></i>{% trans "Todos los tipos" %}
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        
                                        <!-- Comida & Bebida -->
                                        <li class="dropdown-header"><i class="bi bi-cup-straw me-2"></i>{% trans "Comida & Bebida" %}</li>
                                        <li><a class="dropdown-item dropdown-item-filtro tipo-nearme-option" href="javascript:void(0)" data-tipo="restaurant">
                                            <i class="bi bi-egg-fried me-2 text-warning"></i>{% trans "Restaurantes" %}
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro tipo-nearme-option" href="javascript:void(0)" data-tipo="bar">
                                            <i class="bi bi-cup-straw me-2 text-info"></i>{% trans "Bares" %}
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro tipo-nearme-option" href="javascript:void(0)" data-tipo="cafe">
                                            <i class="bi bi-cup-hot me-2 text-success"></i>{% trans "Cafés" %}
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro tipo-nearme-option" href="javascript:void(0)" data-tipo="bakery">
                                            <i class="bi bi-cake me-2 text-warning"></i>{% trans "Panaderías" %}
                                        </a></li>
                                        
                                        <li><hr class="dropdown-divider"></li>
                                        
                                        <!-- Vida Nocturna -->
                                        <li class="dropdown-header"><i class="bi bi-moon-stars me-2"></i>{% trans "Vida Nocturna" %}</li>
                                        <li><a class="dropdown-item dropdown-item-filtro tipo-nearme-option" href="javascript:void(0)" data-tipo="night_club">
                                            <i class="bi bi-moon-stars me-2 text-purple"></i>{% trans "Discotecas" %}
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro tipo-nearme-option" href="javascript:void(0)" data-tipo="rooftop_bar">
                                            <i class="bi bi-building me-2 text-primary"></i>{% trans "Rooftops" %}
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro tipo-nearme-option" href="javascript:void(0)" data-tipo="karaoke">
                                            <i class="bi bi-mic me-2 text-info"></i>{% trans "Karaokes" %}
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro tipo-nearme-option" href="javascript:void(0)" data-tipo="sports_bar">
                                            <i class="bi bi-controller me-2 text-success"></i>{% trans "Bares Deportivos" %}
                                        </a></li>
                                        
                                        <li><hr class="dropdown-divider"></li>
                                        
                                        <!-- Entretenimiento -->
                                        <li class="dropdown-header"><i class="bi bi-controller me-2"></i>{% trans "Entretenimiento" %}</li>
                                        <li><a class="dropdown-item dropdown-item-filtro tipo-nearme-option" href="javascript:void(0)" data-tipo="casino">
                                            <i class="bi bi-dice-5 me-2 text-danger"></i>{% trans "Casinos" %}
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro tipo-nearme-option" href="javascript:void(0)" data-tipo="bowling_alley">
                                            <i class="bi bi-circle me-2 text-primary"></i>{% trans "Boleras" %}
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro tipo-nearme-option" href="javascript:void(0)" data-tipo="spa">
                                            <i class="bi bi-droplet me-2 text-info"></i>{% trans "Spas" %}
                                        </a></li>
                                        
                                        <li><hr class="dropdown-divider"></li>
                                        
                                        <!-- Cultura -->
                                        <li class="dropdown-header"><i class="bi bi-palette me-2"></i>{% trans "Cultura & Arte" %}</li>
                                        <li><a class="dropdown-item dropdown-item-filtro tipo-nearme-option" href="javascript:void(0)" data-tipo="art_gallery">
                                            <i class="bi bi-palette me-2 text-warning"></i>{% trans "Galerías de Arte" %}
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro tipo-nearme-option" href="javascript:void(0)" data-tipo="museum">
                                            <i class="bi bi-bank me-2 text-secondary"></i>{% trans "Museos" %}
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro tipo-nearme-option" href="javascript:void(0)" data-tipo="tourist_attraction">
                                            <i class="bi bi-camera me-2 text-success"></i>{% trans "Atracciones Turísticas" %}
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                            
                            <!-- Dropdown: Características (COMPLETO) -->
                            <div class="col-lg-3 col-md-4 col-6">
                                <div class="dropdown">
                                    <button class="btn btn-filtro-dropdown w-100 dropdown-toggle ${featureNearMe ? 'selected' : ''}" type="button"
                                            id="featureNearMeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-stars me-2"></i>
                                        <span>${featureSelectedLabel}</span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-filtros shadow-lg" aria-labelledby="featureNearMeDropdown">
                                        <li><a class="dropdown-item dropdown-item-filtro feature-nearme-option" href="javascript:void(0)" data-feature="">
                                            <i class="bi bi-x-circle me-2 text-muted"></i>{% trans "Sin filtro especial" %}
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        
                                        <!-- Ambiente -->
                                        <li class="dropdown-header"><i class="bi bi-stars me-2"></i>{% trans "Ambiente" %}</li>
                                        <li><a class="dropdown-item dropdown-item-filtro feature-nearme-option" href="javascript:void(0)" data-feature="outdoor_seating">
                                            <i class="bi bi-tree me-2 text-success"></i>{% trans "Terraza" %}
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro feature-nearme-option" href="javascript:void(0)" data-feature="live_music">
                                            <i class="bi bi-music-note-beamed me-2 text-warning"></i>{% trans "Música en Vivo" %}
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro feature-nearme-option" href="javascript:void(0)" data-feature="good_for_groups">
                                            <i class="bi bi-people me-2 text-info"></i>{% trans "Para Grupos" %}
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro feature-nearme-option" href="javascript:void(0)" data-feature="good_for_children">
                                            <i class="bi bi-emoji-smile me-2 text-success"></i>{% trans "Para Niños" %}
                                        </a></li>
                                        
                                        <li><hr class="dropdown-divider"></li>
                                        
                                        <!-- Servicios -->
                                        <li class="dropdown-header"><i class="bi bi-bicycle me-2"></i>{% trans "Servicios" %}</li>
                                        <li><a class="dropdown-item dropdown-item-filtro feature-nearme-option" href="javascript:void(0)" data-feature="delivery">
                                            <i class="bi bi-bicycle me-2 text-primary"></i>{% trans "Delivery" %}
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro feature-nearme-option" href="javascript:void(0)" data-feature="takeout">
                                            <i class="bi bi-bag me-2 text-success"></i>{% trans "Para Llevar" %}
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro feature-nearme-option" href="javascript:void(0)" data-feature="dine_in">
                                            <i class="bi bi-house me-2 text-info"></i>{% trans "Comer en Local" %}
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro feature-nearme-option" href="javascript:void(0)" data-feature="reservable">
                                            <i class="bi bi-calendar-check me-2 text-warning"></i>{% trans "Reservaciones" %}
                                        </a></li>
                                        
                                        <li><hr class="dropdown-divider"></li>
                                        
                                        <!-- Especialidades -->
                                        <li class="dropdown-header"><i class="bi bi-cup-straw me-2"></i>{% trans "Especialidades" %}</li>
                                        <li><a class="dropdown-item dropdown-item-filtro feature-nearme-option" href="javascript:void(0)" data-feature="serves_cocktails">
                                            <i class="bi bi-cup-straw me-2 text-danger"></i>{% trans "Cócteles" %}
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro feature-nearme-option" href="javascript:void(0)" data-feature="serves_wine">
                                            <i class="bi bi-cup me-2 text-purple"></i>{% trans "Vinos" %}
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro feature-nearme-option" href="javascript:void(0)" data-feature="serves_coffee">
                                            <i class="bi bi-cup-hot me-2 text-warning"></i>{% trans "Café Especialidad" %}
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro feature-nearme-option" href="javascript:void(0)" data-feature="serves_dessert">
                                            <i class="bi bi-cake me-2 text-pink"></i>{% trans "Postres" %}
                                        </a></li>
                                        
                                        <li><hr class="dropdown-divider"></li>
                                        
                                        <!-- Accesibilidad -->
                                        <li class="dropdown-header"><i class="bi bi-universal-access me-2"></i>{% trans "Accesibilidad" %}</li>
                                        <li><a class="dropdown-item dropdown-item-filtro feature-nearme-option" href="javascript:void(0)" data-feature="allows_dogs">
                                            <i class="bi bi-heart me-2 text-danger"></i>{% trans "Pet Friendly" %}
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro feature-nearme-option" href="javascript:void(0)" data-feature="wheelchair_accessible_entrance">
                                            <i class="bi bi-universal-access me-2 text-primary"></i>{% trans "Acceso Accesible" %}
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro feature-nearme-option" href="javascript:void(0)" data-feature="accepts_credit_cards">
                                            <i class="bi bi-credit-card me-2 text-success"></i>{% trans "Tarjetas de Crédito" %}
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                            
                            <!-- Dropdown: Distancia -->
                            <div class="col-lg-3 col-md-4 col-6">
                                <div class="dropdown">
                                    <button class="btn btn-filtro-dropdown w-100 dropdown-toggle" type="button"
                                            id="distanceNearMeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bi bi-rulers me-2"></i>
                                        <span id="distance-label-result">${radioDisplay}</span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-filtros shadow-lg" aria-labelledby="distanceNearMeDropdown">
                                        <li><a class="dropdown-item dropdown-item-filtro distance-nearme-option" href="javascript:void(0)" data-distance="1">
                                            <i class="bi bi-geo me-2"></i>1 km
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro distance-nearme-option" href="javascript:void(0)" data-distance="2">
                                            <i class="bi bi-geo me-2"></i>2 km
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro distance-nearme-option" href="javascript:void(0)" data-distance="3">
                                            <i class="bi bi-geo me-2"></i>3 km
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro distance-nearme-option" href="javascript:void(0)" data-distance="5">
                                            <i class="bi bi-geo me-2"></i>5 km
                                        </a></li>
                                        <li><a class="dropdown-item dropdown-item-filtro distance-nearme-option" href="javascript:void(0)" data-distance="10">
                                            <i class="bi bi-geo me-2"></i>10 km
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                </div>
                
                <div class="semantic-home-grid lugares-grid">
        `;
        
        // Usar función estandarizada para generar cards
        data.lugares.forEach(lugar => {
            html += generarPlaceCardHtml(lugar);
        });
        
        html += `
                </div>
                
                <div class="nearby-actions mt-4 d-flex flex-wrap justify-content-center gap-2">
                    <button class="btn btn-outline-light rounded-pill px-3" onclick="window.activarNearMe()">
                        <i class="bi bi-arrow-clockwise me-1"></i>{% trans "Actualizar Ubicación" %}
                    </button>
                    <a href="{% url 'explorer:lugares_list' %}" class="btn btn-gradient-green rounded-pill px-3">
                        <i class="bi bi-compass me-1"></i>{% trans "Ver Todos los Lugares" %}
                    </a>
                </div>
            </div>
        `;
        
        // Detectar si es una actualización (ya hay resultados)
        const $container = $('#ajax-results');
        const isUpdate = nearMeResultsVisible && $container.find('.semantic-home-wrapper').length > 0;
        
        if (isUpdate) {
            // Solo actualizar el título, mensaje, badges y grid (sin recargar los filtros)
            $('.semantic-home-title').removeClass('updating').html(titulo);
            $('.semantic-home-header .lead').first().html(subtitulo);
            
            // Actualizar badges de filtros activos (con datos reales del backend)
            $('.semantic-home-header .mt-2').first().html(filtrosActivos.join(''));
            
            // Actualizar labels de los dropdowns con datos reales
            $('#tipoNearMeDropdown span').text(tipoSelectedLabel);
            $('#featureNearMeDropdown span').text(featureSelectedLabel);
            $('#distance-label-result').text(radioDisplay);
            
            // Actualizar clases selected de los dropdowns (basado en datos reales)
            $('#tipoNearMeDropdown').toggleClass('selected', !!tipoLabelReal);
            $('#featureNearMeDropdown').toggleClass('selected', !!featureLabelReal);
        
            // Generar solo el grid
            let gridHtml = '';
            data.lugares.forEach((lugar, index) => {
                gridHtml += generarCardHtml(lugar, T_VIEW_DETAILS, T_NO_DETAILS, T_FEATURED, T_EXCLUSIVE, T_TOP_RATED);
            });
            
            // Actualizar grid con transición
            const $grid = $('.semantic-home-grid');
            $grid.removeClass('loading');
            $grid.fadeOut(150, function() {
                $(this).html(gridHtml).fadeIn(200);
            });
        } else {
            // Primera vez: renderizar todo
            $container.html(html).hide().fadeIn(300);
            $('#search-results-section').fadeIn(300);
            nearMeResultsVisible = true;
            
            // Scroll suave solo la primera vez
        $('html, body').animate({
                scrollTop: $container.offset().top - 100
            }, 600);
    }
    
        // Event handlers (usar delegación para que funcionen siempre)
        $(document).off('click', '.tipo-nearme-option').on('click', '.tipo-nearme-option', function(e) {
            e.preventDefault();
            tipoNearMe = $(this).data('tipo') || null;
            buscarLugaresCercanos(true);
        });
        
        $(document).off('click', '.feature-nearme-option').on('click', '.feature-nearme-option', function(e) {
            e.preventDefault();
            featureNearMe = $(this).data('feature') || null;
            buscarLugaresCercanos(true);
        });
        
        $(document).off('click', '.distance-nearme-option').on('click', '.distance-nearme-option', function(e) {
            e.preventDefault();
            radioDistancia = parseInt($(this).data('distance'));
            buscarLugaresCercanos(true);
        });
    }
    
    // Helper para generar HTML de una card
    // Esta función ahora usa generarPlaceCardHtml para mantener consistencia
    function generarCardHtml(lugar) {
        return generarPlaceCardHtml(lugar);
    }

    function renderizarResultadosSemanticos(data) {
        // Cerrar TODOS los dropdowns de forma agresiva (sin bloquear futuros clics)
        $('.dropdown-menu-filtros').removeClass('show').css('display', '');
        $('.dropdown-menu').removeClass('show').css('display', '');
        $('.dropdown').removeClass('show');
        $('[data-bs-toggle="dropdown"]').attr('aria-expanded', 'false').removeClass('show');
        
        // Forzar cierre con Bootstrap API (si existe; bootstrap bundle carga con defer)
        if (window.bootstrap && window.bootstrap.Dropdown) {
            document.querySelectorAll('[data-bs-toggle="dropdown"]').forEach(btn => {
                const dropdown = window.bootstrap.Dropdown.getInstance(btn);
                if (dropdown) dropdown.hide();
            });
        }
        
        const T_VIEW_DETAILS = '{% trans "Ver detalles" %}';
        const T_NO_DETAILS = '{% trans "Sin detalles" %}';
        
        let html = `
            <div class="semantic-home-wrapper">
                <div class="semantic-home-header text-center mb-4 text-white">
                    <h2 class="fw-bold semantic-home-title">${gettext('Resultados Semánticos')}</h2>
                    <p class="lead mb-0">${gettext('Consulta')}: <span class="semantic-home-query">“${data.query || ''}”</span></p>
                </div>
                <div class="semantic-home-grid lugares-grid">
        `;
        
        // Usar función estandarizada para generar cards
        (data.lugares || []).forEach(lugar => {
            html += generarPlaceCardHtml(lugar);
        });
        
        html += `
                </div>
            </div>
        `;
        
        $('#ajax-results').html(html).show();
        $('#search-results-section').show();
        $('html, body').animate({ scrollTop: $('#ajax-results').offset().top - 100 }, 800);
    }
});
</script>
{% endblock %}
