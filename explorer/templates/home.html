{% extends "base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Inicio | ViveMedell√≠n" %}{% endblock %}

{% block meta_description %}
  {% blocktrans %}Bienvenido a ViveMedell√≠n: descubre los mejores bares, discotecas, rooftops y restaurantes de Medell√≠n, organizados por comunas. ¬°Explora como un local!{% endblocktrans %}
{% endblock %}

{% block meta_keywords %}
  {% blocktrans %}ViveMedell√≠n, bares Medell√≠n, discotecas Medell√≠n, restaurantes Medell√≠n, comunas Medell√≠n, vida nocturna Medell√≠n{% endblocktrans %}
{% endblock %}

{% block og_title %}
  {% trans "ViveMedell√≠n | Descubre los mejores lugares por comuna" %}
{% endblock %}

{% block og_description %}
  {% blocktrans %}Navega los mejores sitios para salir en Medell√≠n. Desde El Poblado hasta Laureles, descubre lugares √∫nicos en cada comuna.{% endblocktrans %}
{% endblock %}

{% block og_image %}
  {{ request.build_absolute_uri }}static/img/og-image.jpg
{% endblock %}

{% block navbar %}{% endblock %}

{% block content %}

<!-- Hero Section -->
<section class="hero-section-clean position-relative overflow-hidden">
    <div class="container py-5">
        <div class="row min-vh-100 align-items-center justify-content-center">
            <div class="col-xl-10 col-lg-11 col-md-12 text-center">
                <div class="hero-content">
                    <div class="hero-top">
                        {% get_current_language as LANGUAGE_CODE %}
                        <div class="d-flex justify-content-end mb-3 home-lang-switch gap-2 flex-wrap">
                            <!-- Home / About us con mismo estilo que ES / EN -->
                            <a href="{% url 'explorer:home' %}" class="btn btn-lang-home inactive">
                                {% trans "Home" %}
                            </a>
                            {% if LANGUAGE_CODE|slice:":2" == 'en' %}
                              <a href="{% url 'explorer:about' %}" class="btn btn-lang-home inactive">
                                {% trans "About us" %}
                              </a>
                            {% else %}
                              <a href="{% url 'explorer:about_es' %}" class="btn btn-lang-home inactive">
                                {% trans "Nosotros" %}
                              </a>
                            {% endif %}
                            <!-- Selector de idioma -->
                            <form action="{% url 'set_language' %}" method="post">
                                {% csrf_token %}
                                <input type="hidden" name="language" value="es">
                                {% if request.path|slice:":4" == "/en/" %}
                                    {# Si estamos en /en/... quitar prefijo al volver a ES #}
                                    <input type="hidden" name="next" value="{{ request.path|slice:'3:' }}">
                                {% else %}
                                    <input type="hidden" name="next" value="{{ request.path }}">
                                {% endif %}
                                <button type="submit" class="btn btn-lang-home {% if LANGUAGE_CODE == 'es' %}active{% else %}inactive{% endif %}">ES</button>
                            </form>
                            <form action="{% url 'set_language' %}" method="post">
                                {% csrf_token %}
                                <input type="hidden" name="language" value="en">
                                {% if request.path|slice:":4" == "/en/" %}
                                    {# Ya estamos en /en/... mantenemos el prefijo #}
                                    <input type="hidden" name="next" value="{{ request.path }}">
                                {% else %}
                                    {# A√±adir prefijo /en al cambiar a ingl√©s #}
                                    <input type="hidden" name="next" value="/en{{ request.path }}">
                                {% endif %}
                                <button type="submit" class="btn btn-lang-home {% if LANGUAGE_CODE|slice:":2" == 'en' %}active{% else %}inactive{% endif %}">EN</button>
                            </form>
                        </div>                    
                        <h1 class="hero-title display-2 mb-4 text-white fw-bold">
                            {% blocktrans %}Descubre <span class="text-white">Medell√≠n</span><br>Como Nunca Antes{% endblocktrans %}
                        </h1>
                        
                        <!-- Search Bar -->
                        <div class="search-modern-clean mb-3">
                            <div class="input-group input-group-lg shadow-lg">
                                <input type="text" 
                                       id="search-places" 
                                       class="form-control form-control-lg rounded-start-pill border-0"
                                       placeholder="{% trans 'Busca bares, restaurantes, lugares...' %}">
                                <button class="btn btn-light rounded-end-pill px-4" type="button">
                                    <i class="bi bi-search"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Filtros Dropdown -->
                        <div class="filtros-home mb-5">
                        <div class="row g-3 justify-content-center">
                            
                            <!-- 1. √ÅREAS -->
                            <div class="col-lg-4 col-md-6">
                                <div class="dropdown" style="position: relative; z-index: 1000;">
                                    <button class="btn btn-filtro-dropdown w-100 dropdown-toggle" type="button" id="areasDropdown" data-bs-toggle="dropdown" data-bs-placement="bottom" data-bs-auto-close="true" aria-expanded="false">
                                        <i class="bi bi-geo-alt me-2"></i>
                                        <span id="area-selected-text">{% trans "Seleccionar √Årea" %}</span>
                                        <span id="area-check" class="ms-2" style="display: none;">‚úì</span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-filtros shadow-lg" aria-labelledby="areasDropdown">
                                        {% for area in regiones_areas %}
                                        <li>
                                            <a class="dropdown-item dropdown-item-filtro area-option" 
                                               href="javascript:void(0)" 
                                               data-area-id="{{ area.osm_id }}" 
                                               data-area-name="{{ area.name }}"
                                               data-area-slug="{{ area.slug }}">
                                                <i class="bi bi-map me-2 text-primary"></i>
                                                <div>
                                                    <div class="fw-semibold">{{ area.name }}</div>
                                                    <small class="text-muted">{% trans "Explorar esta zona" %}</small>
                                                </div>
                                            </a>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>

                            <!-- 2. CATEGOR√çAS REALES -->
                            <div class="col-lg-4 col-md-6">
                                <div class="dropdown" style="position: relative; z-index: 999;">
                                    <button class="btn btn-filtro-dropdown w-100 dropdown-toggle" type="button" id="categoriasDropdown" data-bs-toggle="dropdown" data-bs-placement="bottom" data-bs-auto-close="true" aria-expanded="false">
                                        <i class="bi bi-grid-3x3-gap me-2"></i>
                                        <span id="categoria-selected-text">{% trans "Seleccionar Tipo" %}</span>
                                        <span id="categoria-check" class="ms-2" style="display: none;">‚úì</span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-filtros shadow-lg" aria-labelledby="categoriasDropdown">
                                        {% for categoria in categorias_reales %}
                                        <li class="dropdown-header">
                                            <i class="{{ categoria.icon }} me-2 text-{{ categoria.color }}"></i>{{ categoria.name }}
                                        </li>
                                        {% for subcategoria in categoria.subcategorias %}
                                        <li>
                                            <a class="dropdown-item dropdown-item-filtro categoria-option" 
                                               href="javascript:void(0)"
                                               data-categoria-id="{{ subcategoria.value }}" 
                                               data-categoria-name="{{ subcategoria.name }}">
                                                <i class="bi bi-arrow-right me-2 text-muted"></i>
                                                <div>
                                                    <div class="fw-semibold">{{ subcategoria.name }}</div>
                                                </div>
                                            </a>
                                        </li>
                                        {% endfor %}
                                        {% if not forloop.last %}<li><hr class="dropdown-divider"></li>{% endif %}
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>

                            <!-- 3. ETIQUETAS ESPECIALES -->
                            <div class="col-lg-4 col-md-6">
                                <div class="dropdown" style="position: relative; z-index: 998;">
                                    <button class="btn btn-filtro-dropdown w-100 dropdown-toggle" type="button" id="etiquetasDropdown" data-bs-toggle="dropdown" data-bs-placement="bottom" data-bs-auto-close="true" aria-expanded="false">
                                        <i class="bi bi-stars me-2"></i>
                                        <span id="caracteristica-selected-text">{% trans "Caracter√≠sticas" %}</span>
                                        <span id="caracteristica-check" class="ms-2" style="display: none;">‚úì</span>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-filtros shadow-lg" aria-labelledby="etiquetasDropdown">
                                        <!-- Opci√≥n para no seleccionar caracter√≠stica -->
                                        <li>
                                            <a class="dropdown-item dropdown-item-filtro caracteristica-option" 
                                               href="javascript:void(0)"
                                               data-caracteristica-id="none" 
                                               data-caracteristica-name="{% trans 'Sin caracter√≠stica especial' %}">
                                                <i class="bi bi-x-circle me-2 text-muted"></i>
                                                <div>
                                                    <div class="fw-semibold">{% trans "Sin caracter√≠stica especial" %}</div>
                                                    <small class="text-muted">{% trans "Buscar sin filtros adicionales" %}</small>
                                                </div>
                                            </a>
                                        </li>
                                        <li><hr class="dropdown-divider"></li>
                                        
                                        {% for grupo in etiquetas_especiales %}
                                        <li class="dropdown-header">
                                            <i class="{{ grupo.icon }} me-2 text-warning"></i>{{ grupo.name }}
                                        </li>
                                        {% for opcion in grupo.opciones %}
                                        <li>
                                            <a class="dropdown-item dropdown-item-filtro caracteristica-option" 
                                               href="javascript:void(0)"
                                               data-caracteristica-id="{{ opcion.field }}" 
                                               data-caracteristica-name="{{ opcion.name }}">
                                                <i class="{{ opcion.icon }} me-2 text-success"></i>
                                                <div>
                                                    <div class="fw-semibold">{{ opcion.name }}</div>
                                                </div>
                                            </a>
                                        </li>
                                        {% endfor %}
                                        {% if not forloop.last %}<li><hr class="dropdown-divider"></li>{% endif %}
                                        {% endfor %}
                                    </ul>
                                </div>
                            </div>

                        </div>
                        
                        <!-- Bot√≥n Cerca de M√≠ -->
                        <div class="row justify-content-center mt-4" style="position: relative; z-index: 1;">
                            <div class="col-lg-4 col-md-6">
                                <button id="cerca-de-mi-btn" class="btn btn-filtro-dropdown w-100" type="button">
                                    <i class="bi bi-geo-fill me-2"></i>
                                    <span id="ubicacion-text">{% trans "Cerca de M√≠" %}</span>
                                    <span id="ubicacion-loading" class="ms-2" style="display: none;">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">{% trans "Cargando..." %}</span>
                                        </div>
                                    </span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Estado de Filtros y Bot√≥n de B√∫squeda -->
                        <div class="text-center mt-4">
                            <div id="filtros-estado" class="mb-3" style="display: none;">
                                <div class="alert alert-info d-inline-block">
                                    <i class="bi bi-funnel me-2"></i>
                                    <span id="filtros-count"></span>
                                    <span class="ms-1" id="filtros-optional">+ {% trans "caracter√≠stica opcional" %}</span>
                                    <div class="small mt-1" id="filtros-resumen"></div>
                                    <button id="limpiar-filtros-btn" class="btn btn-sm btn-outline-light rounded-pill mt-2">
                                        <i class="bi bi-x-circle me-1"></i>{% trans "Limpiar filtros" %}
                                    </button>
                                </div>
                            </div>
                            
                            <button id="buscar-btn" class="btn btn-success btn-lg rounded-pill px-4 me-3" style="display: none;" disabled>
                                <i class="bi bi-search me-2"></i>{% trans "Buscar Lugares" %}
                            </button>
                            
                            <a href="{% url 'explorer:lugares_list' %}" class="btn btn-gradient-green btn-lg rounded-pill px-4">
                                <i class="bi bi-compass me-2"></i>{% trans "Ver Todos los Lugares" %}
                            </a>
                        </div>
                    </div>
                    
                    <!-- Loading y Resultados AJAX -->
                    <div id="ajax-loading" class="text-center py-5" style="display: none; position: relative; z-index: 1;">
                        <div class="spinner-border text-light" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <div class="text-white mt-3">
                            <h5>{% trans "Buscando lugares..." %}</h5>
                            <p>{% trans "Esto puede tardar unos segundos" %}</p>
                        </div>
                    </div>
                    
                    <!-- Contenedor de resultados principal se define fuera del hero para no afectar el fondo -->

                    <!-- Burbujas de √°reas de Medell√≠n (en la parte inferior de la card) -->
                    {% if regiones_areas %}
                    <div class="areas-burbujas mt-2">
                        {% for area in regiones_areas %}
                            <a href="{% url 'explorer:lugares_por_comuna' area.slug %}" class="area-bubble">
                                <span class="dot"></span>
                                <span class="label">{{ area.name }}</span>
                            </a>
                        {% endfor %}
                        <a href="{% url 'explorer:lugares_list' %}" class="area-bubble area-bubble-all">
                            <span class="dot"></span>
                            <span class="label">{% trans "Ver todas las √°reas" %}</span>
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Secci√≥n separada para resultados din√°micos (sem√°nticos, cerca de m√≠, etc.) -->
<section id="search-results-section" style="display: none;">
    <div id="ajax-results"></div>
</section>

    <!-- Pre-carga i18n para textos usados solo en JS (oculto) -->
    <div class="visually-hidden" aria-hidden="true">
        {% trans "Obteniendo ubicaci√≥n..." %}
        {% trans "Ubicaci√≥n encontrada" %}
        {% trans "Permiso de ubicaci√≥n denegado. Por favor, habilita la ubicaci√≥n en tu navegador." %}
        {% trans "No se pudo determinar tu ubicaci√≥n. Intenta de nuevo." %}
        {% trans "La solicitud de ubicaci√≥n tard√≥ demasiado. Intenta de nuevo." %}
        {% trans "Error desconocido al obtener la ubicaci√≥n." %}
        {% trans "Error en la b√∫squeda" %}
        {% trans "Error de conexi√≥n" %}
        {% trans "No hay lugares cercanos disponibles en este momento." %}
        {% trans "Error al cargar lugares cercanos." %}
        {% trans "Reintentar" %}
        {% trans "No hay lugares similares disponibles en este momento." %}
        {% trans "Error al cargar lugares similares." %}
        {% trans "No hay m√°s lugares en esta zona disponibles en este momento." %}
        {% trans "Error al cargar lugares de la zona." %}
    </div>
{% endblock %}

{% block extra_css %}
<style>
/* Ocultar espaciador del navbar solo en home */
.navbar-spacer {
    display: none;
}

/* Botones de idioma dentro del hero (home) */
.home-lang-switch .btn-lang-home {
    border-radius: 999px;
    padding: 0.35rem 0.9rem;
    font-size: 0.85rem;
    font-weight: 700;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    border: 1px solid rgba(255, 255, 255, 0.35);
    background: rgba(0, 0, 0, 0.25);
    color: rgba(255, 255, 255, 0.85);
    box-shadow: 0 4px 14px rgba(0, 0, 0, 0.35);
}

.home-lang-switch .btn-lang-home.active {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    border-color: transparent;
    color: #03120a;
}

.home-lang-switch .btn-lang-home.inactive:hover {
    background: rgba(255, 255, 255, 0.18);
}

/* Hero Section con foto limpia de Medell√≠n como fondo */
.hero-section-clean {
    position: relative;
    background-image: url("{% static 'img/juan-saravia-03gVOLHq9ec-unsplash.jpg' %}");
    background-size: cover;
    background-position: center center;
    background-repeat: no-repeat;
    min-height: 100vh;
    margin-top: 0;
    padding-top: 95px;
    padding-bottom: 80px;
}

/* Contenedor central tipo ‚Äúglassmorphism‚Äù */
.hero-content {
    background: rgba(4, 20, 12, 0.7);
    border-radius: 28px;
    padding: 2.5rem 2rem 1.8rem 2rem;
    box-shadow: 0 24px 60px rgba(0, 0, 0, 0.55);
    border: 1px solid rgba(255, 255, 255, 0.12);
    backdrop-filter: blur(18px);
    min-height: 80vh;
    display: flex;
    flex-direction: column;
}

/* Hero title centrado y m√°s compacto, tipo landing moderna */
.hero-title {
    text-align: center;
    line-height: 1.15;
    letter-spacing: -0.03em;
}

/* Search Input Styling */
.search-modern-clean .form-control {
    padding: 0.95rem 1.6rem;
    font-size: 1.05rem;
    border-radius: 999px 0 0 999px;
}

.search-modern-clean .form-control:focus {
    box-shadow: 0 0 0 0.25rem rgba(102, 126, 234, 0.25);
    border-color: #667eea;
}

/* Bot√≥n de b√∫squeda grande, circular y protagonista */
.search-modern-clean .btn {
    border-radius: 0 999px 999px 0;
    font-weight: 600;
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    border: none;
    color: #fff;
}

.search-modern-clean .btn:hover {
    background: linear-gradient(135deg, #0f8a7f 0%, #2fd86f 100%);
    transform: translateY(-1px);
    box-shadow: 0 8px 20px rgba(47, 216, 111, 0.45);
}

/* Burbujas de √°reas (chips de zonas de Medell√≠n) al fondo de la card */
.areas-burbujas {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    padding: 0.5rem 0 0.25rem 0;
    justify-content: center;
}

.area-bubble {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.35rem 0.9rem;
    border-radius: 999px;
    border: 1px solid rgba(255, 255, 255, 0.55);
    background: rgba(0, 0, 0, 0.25);
    color: #f6fdfb;
    font-size: 0.85rem;
    text-decoration: none;
    white-space: nowrap;
    transition: all 0.2s ease;
}

.area-bubble .dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #38ef7d;
}

.area-bubble-all .dot {
    background: #ffca28;
}

.area-bubble:hover {
    background: rgba(0, 0, 0, 0.45);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
}

/* Grid/Carrusel de lugares */
.lugares-grid {
  padding: 0.5rem 0;
}

/* M√≥vil: Carrusel horizontal */
@media (max-width: 767.98px) {
  .lugares-grid {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    scroll-behavior: smooth;
    scrollbar-width: thin;
    scrollbar-color: rgba(102, 126, 234, 0.3) transparent;
    padding-bottom: 1rem;
    margin: 0 -1rem;
    padding-left: 1rem;
    padding-right: 1rem;
  }
  
  .lugares-grid::-webkit-scrollbar {
    height: 6px;
  }
  
  .lugares-grid::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 3px;
  }
  
  .lugares-grid::-webkit-scrollbar-thumb {
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    border-radius: 3px;
  }
  
  .lugar-card-wrapper {
    flex: 0 0 auto;
    width: 85vw;
    max-width: 400px;
  }
}

/* Desktop: Grid est√°ndar */
@media (min-width: 768px) {
  .lugares-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
  }
  
  .lugar-card-wrapper {
    width: 100%;
  }
}

/* Card Hover Effects */
.card {
    position: relative;
}

/* Badge overlay sobre imagen de card */
.badge-overlay {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    z-index: 10;
}

.badge-overlay .badge {
    background-color: rgba(13, 110, 253, 0.95) !important;
    backdrop-filter: blur(4px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    font-weight: 600;
}

.card:hover {
    transform: translateY(-5px);
    transition: all 0.3s ease;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

/* Filtros del Home */
.filtros-home {
    background: rgba(3, 30, 20, 0.88);
    backdrop-filter: blur(16px);
    border-radius: 22px;
    padding: 2rem 1.75rem;
    border: 1px solid rgba(255, 255, 255, 0.12);
    position: relative;
    z-index: 2; /* por encima del √°rea de resultados */
}

/* Botones Dropdown de Filtros */
.btn-filtro-dropdown {
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(5px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white !important;
    font-size: 1rem;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
}

.btn-filtro-dropdown:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    color: white !important;
    border-color: rgba(255, 255, 255, 0.5);
}

.btn-filtro-dropdown:focus {
    box-shadow: 0 0 0 0.25rem rgba(255, 255, 255, 0.25);
    color: white !important;
}

/* Dropdown Menus de Filtros */
.dropdown-menu-filtros {
    border-radius: 15px;
    padding: 0.75rem;
    margin-top: 0.5rem;
    min-width: 320px;
    max-width: 400px;
    background: white;
    border: none;
    box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
    backdrop-filter: blur(10px);
    max-height: 350px;
    overflow-y: auto;
    
    /* Forzar direcci√≥n hacia abajo pero con z-index menor que resultados */
    position: absolute !important;
    top: 100% !important;
    bottom: auto !important;
    left: 0 !important;
    right: auto !important;
    transform: none !important;
    will-change: auto !important;
    inset: auto !important;
    z-index: 100 !important;
}

/* Dropdown espec√≠fico para caracter√≠sticas (m√°s alto por tener m√°s contenido) */
#etiquetasDropdown + .dropdown-menu-filtros {
    max-height: 280px;
    overflow-y: auto;
    overflow-x: hidden;
}

/* Scrollbar personalizada para dropdowns */
.dropdown-menu-filtros::-webkit-scrollbar {
    width: 6px;
}

.dropdown-menu-filtros::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 3px;
}

.dropdown-menu-filtros::-webkit-scrollbar-thumb {
    background: rgba(102, 126, 234, 0.3);
    border-radius: 3px;
    transition: all 0.3s ease;
}

.dropdown-menu-filtros::-webkit-scrollbar-thumb:hover {
    background: rgba(102, 126, 234, 0.6);
}

/* Prevenir colapso autom√°tico de dropdowns en mobile */
@media (max-width: 768px) {
    .dropdown-menu-filtros {
        min-width: 280px;
        max-width: 90vw;
        max-height: 300px;
    }
    
    #etiquetasDropdown + .dropdown-menu-filtros {
        max-height: 250px;
    }
}

.dropdown-item-filtro {
    padding: 0.75rem;
    border-radius: 10px;
    border: none;
    display: flex;
    align-items: center;
    transition: all 0.3s ease;
    text-decoration: none;
}

.dropdown-item-filtro:hover {
    background-color: rgba(102, 126, 234, 0.1);
    transform: translateX(3px);
    color: #667eea;
}

.dropdown-item-filtro i {
    font-size: 1.1rem;
    width: 20px;
    flex-shrink: 0;
}

.dropdown-header {
    color: #495057;
    font-weight: 600;
    font-size: 0.9rem;
    padding: 0.5rem 0.75rem 0.25rem;
    margin-top: 0.5rem;
}

.dropdown-header:first-child {
    margin-top: 0;
}

/* Estados de filtros seleccionados */
.btn-filtro-dropdown.selected {
    background: rgba(40, 167, 69, 0.3);
    border-color: rgba(40, 167, 69, 0.5);
    color: white !important;
}

.btn-filtro-dropdown.selected:hover {
    background: rgba(40, 167, 69, 0.4);
    border-color: rgba(40, 167, 69, 0.6);
}

/* Bot√≥n de ubicaci√≥n "Cerca de M√≠" */
#cerca-de-mi-btn {
    position: relative;
    overflow: hidden;
}

#cerca-de-mi-btn:hover {
    background: rgba(255, 255, 255, 0.25);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
}

#cerca-de-mi-btn.locating {
    background: rgba(34, 139, 34, 0.3);
    border-color: rgba(34, 139, 34, 0.5);
    animation: pulse 2s infinite;
}

#cerca-de-mi-btn.success {
    background: rgba(40, 167, 69, 0.4);
    border-color: rgba(40, 167, 69, 0.6);
}

#cerca-de-mi-btn.error {
    background: rgba(220, 53, 69, 0.3);
    border-color: rgba(220, 53, 69, 0.5);
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(34, 139, 34, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(34, 139, 34, 0); }
    100% { box-shadow: 0 0 0 0 rgba(34, 139, 34, 0); }
}

/* √Årea de resultados AJAX envuelta en secci√≥n separada */
#search-results-section {
    background:
        radial-gradient(circle at top, rgba(17, 153, 142, 0.25) 0%, transparent 50%),
        linear-gradient(135deg, #020617 0%, #022c22 35%, #064e3b 100%);
    padding: 3rem 0 4rem;
}

#ajax-results {
    max-width: 1120px;
    margin: 0 auto;
}

#ajax-results .card:hover {
    transform: translateY(-5px);
    transition: all 0.3s ease;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

/* Loading spinner personalizado */
#ajax-loading {
    margin-top: 2.5rem;
    position: static;   /* evitar solaparse con filtros */
    z-index: auto;
}

#ajax-loading .spinner-border {
    width: 3rem;
    height: 3rem;
    border-width: 0.3em;
}

/* Asegurar z-index controlado para dropdowns */
.dropdown-menu.show {
    z-index: 100 !important;
}

.dropdown {
    position: relative !important;
}

/* Prevenir overflow de contenido detr√°s de dropdowns */
.dropdown.show {
    z-index: 100 !important;
}

/* === Resultados del home: reutilizar EXACTAMENTE el layout de list view (place-card) === */
.semantic-home-wrapper {
    background: rgba(4, 20, 12, 0.8);
    border-radius: 24px;
    padding: 2rem 1.5rem 2.25rem;
    border: 1px solid rgba(255, 255, 255, 0.12);
    box-shadow: 0 24px 55px rgba(0, 0, 0, 0.65);
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
}

@media (min-width: 992px) {
    .semantic-home-wrapper {
        padding: 2.25rem 2rem 2.5rem;
    }
}

.semantic-home-title {
    font-size: 2rem;
}

.semantic-home-query {
    font-weight: 600;
    color: #a5f3fc;
}

/* Reutilizar grid/carrusel de list view */
.semantic-home-grid {
  padding: 0.5rem 0;
}

@media (max-width: 767.98px) {
  .semantic-home-grid {
    display: flex;
    gap: 1.25rem;
    overflow-x: auto;
    scroll-behavior: smooth;
    scrollbar-width: thin;
    scrollbar-color: rgba(102, 126, 234, 0.3) transparent;
    padding-bottom: 1.25rem;
    margin: 0 -1.25rem;
    padding-left: 1.25rem;
    padding-right: 1.25rem;
  }

  .semantic-home-grid::-webkit-scrollbar {
    height: 6px;
  }

  .semantic-home-grid::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 3px;
  }

  .semantic-home-grid::-webkit-scrollbar-thumb {
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    border-radius: 3px;
  }

  .semantic-home-item {
    flex: 0 0 auto;
    width: 88vw;
    max-width: 420px;
  }
}

@media (min-width: 768px) {
  .semantic-home-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.25rem;
  }

  .semantic-home-item {
    width: 100%;
  }
}

/* Layout horizontal de place-card (copiado del list view) */
@media (min-width: 992px) {
  .place-card {
    display: grid;
    grid-template-columns: 280px minmax(0, 1fr);
  }

  .place-card-media img,
  .place-card-placeholder {
    height: 100%;
    min-height: 190px;
    max-height: 220px;
    border-radius: 1.25rem 0 0 1.25rem;
  }

  .place-card-media {
    height: 100%;
  }

  .place-card-body {
    padding: 1.25rem 1.5rem;
  }
}

.place-card-media img {
    height: 190px;
    object-fit: cover;
}

.place-card-placeholder {
    height: 190px;
    background: linear-gradient(135deg, rgba(17, 153, 142, 0.1) 0%, rgba(56, 239, 125, 0.05) 100%);
}

.place-card-rating {
    position: absolute;
    right: 12px;
    bottom: 12px;
    background: #ffffff;
    color: #11998e;
    font-size: 0.8rem;
    padding: 0.35rem 0.75rem;
    box-shadow: 0 4px 12px rgba(17, 153, 142, 0.3);
    border: 1px solid rgba(17, 153, 142, 0.2);
    font-weight: 600;
}

.place-card-body {
    padding-top: 0.9rem;
}

.place-card-title {
    color: #0f172a;
    font-weight: 600;
}

.place-type-pill {
    background: rgba(17, 153, 142, 0.1);
    border-radius: 999px;
    color: #11998e;
    border: 1px solid rgba(17, 153, 142, 0.3);
    font-size: 0.8rem;
    font-weight: 500;
}

.place-flag-pill {
    border-radius: 999px;
    font-size: 0.8rem;
    font-weight: 500;
}

.place-flag-featured {
    background: rgba(250, 204, 21, 0.15);
    color: #ca8a04;
    border: 1px solid rgba(250, 204, 21, 0.4);
}

.place-flag-exclusive {
    background: rgba(17, 153, 142, 0.15);
    color: #11998e;
    border: 1px solid rgba(17, 153, 142, 0.4);
}

.place-card-address {
    color: #64748b !important;
}

.place-card-cta {
    font-weight: 600;
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    border: none;
    color: white;
    transition: all 0.3s ease;
}

.place-card-cta:hover {
    background: linear-gradient(135deg, #0e8678 0%, #32d86a 100%);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(17, 153, 142, 0.4);
    color: white;
}

/* Search Autocomplete Styling */

/* Mobile Optimizations */
@media (max-width: 768px) {
    .hero-title {
        font-size: 2.5rem !important;
    }
    
    .search-modern-clean .form-control {
        font-size: 1rem;
        padding: 0.875rem 1.25rem;
    }
    
    .filtros-home {
        padding: 1.5rem;
        margin: 0 1rem;
    }
    
    .btn-filtro-dropdown {
        font-size: 0.9rem;
        padding: 0.6rem 1.2rem;
    }
    
    .dropdown-menu-filtros {
        min-width: 280px;
        max-width: 320px;
        max-height: 300px;
    }
    
    .dropdown-item-filtro {
        padding: 0.6rem;
        font-size: 0.9rem;
    }
}

/* Degradados para botones - M√°xima especificidad */
.btn.btn-gradient-purple, 
a.btn.btn-gradient-purple,
button.btn.btn-gradient-purple {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
    border: none !important;
    color: white !important;
    font-weight: 600 !important;
    transition: all 0.3s ease !important;
    box-shadow: none !important;
}

.btn.btn-gradient-purple:hover, 
a.btn.btn-gradient-purple:hover,
button.btn.btn-gradient-purple:hover,
.btn.btn-gradient-purple:focus,
a.btn.btn-gradient-purple:focus {
    background: linear-gradient(135deg, #0e8678 0%, #32d86a 100%) !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4) !important;
    color: white !important;
    border: none !important;
}

.btn.btn-gradient-green,
a.btn.btn-gradient-green,
button.btn.btn-gradient-green {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important;
    border: none !important;
    color: white !important;
    font-weight: 600 !important;
    transition: all 0.3s ease !important;
    box-shadow: none !important;
}

.btn.btn-gradient-green:hover,
a.btn.btn-gradient-green:hover,
button.btn.btn-gradient-green:hover,
.btn.btn-gradient-green:focus,
a.btn.btn-gradient-green:focus {
    background: linear-gradient(135deg, #0e8678 0%, #32d86a 100%) !important;
    transform: translateY(-2px) !important;
    box-shadow: 0 4px 15px rgba(17, 153, 142, 0.4) !important;
    color: white !important;
    border: none !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Constante de idioma disponible para todo el script
const CURRENT_LANG = '{{ LANGUAGE_CODE|default:"es" }}' || 'es';
// Helper seguro para traducciones en JS (usa djangojs si est√° disponible)
const gettext = (window.gettext) ? window.gettext : (s => s);

// Helper para construir la URL del detalle de un lugar
function buildPlaceUrl(slug, backendUrl) {
    if (backendUrl) return backendUrl;
    if (!slug) return null;
    if (CURRENT_LANG === 'es') {
        return `/lugar/${slug}/`;
    }
    return `/en/place/${slug}/`;
}

// Helper para construir la URL de lista de lugares (con o sin comuna)
function buildPlacesListUrl(areaSlug) {
    if (!areaSlug) {
        // Usa la URL i18n de Django para la lista general
        return '{% url "explorer:lugares_list" %}';
    }
    if (CURRENT_LANG === 'es') {
        return `/lugares/${areaSlug}/`;
    }
    // Versi√≥n traducida de "lugares/" -> "places/"
    return `/en/places/${areaSlug}/`;
}

// B√∫squeda sem√°ntica (Enter o bot√≥n)
$(document).ready(function() {
    function ejecutarBusquedaSemantica(texto) {
        if (!texto || texto.length < 2) return;
        $('#ajax-loading').show();
        $('#ajax-results').hide();
        $('#search-results-section').hide();
        $.ajax({
            url: "{% url 'explorer:semantic_search_ajax' %}",
            type: 'GET',
            data: { q: texto, top: 12 },
            success: function(resp) {
                $('#ajax-loading').hide();
                if (resp.success) {
                    renderizarResultadosSemanticos(resp);
                } else {
                    mostrarError(gettext('Error en b√∫squeda sem√°ntica') + ': ' + resp.error);
                }
            },
            error: function(xhr, status, error) {
                $('#ajax-loading').hide();
                mostrarError(gettext('Error de conexi√≥n') + ': ' + error);
            }
        });
    }
    $('#search-places').on('keydown', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            ejecutarBusquedaSemantica($(this).val().trim());
        }
    });
    $('.search-modern-clean button').on('click', function() {
        ejecutarBusquedaSemantica($('#search-places').val().trim());
    });
    
    // Smooth scroll for anchor links
    $('a[href^="#"]').on('click', function(e) {
        e.preventDefault();
        const target = $(this.getAttribute('href'));
        if(target.length) {
            $('html, body').animate({
                scrollTop: target.offset().top - 80
            }, 800);
        }
    });
    
    // Variables para almacenar selecciones
    let filtrosSeleccionados = {
        area: null,
        categoria: null,
        caracteristica: null
    };
    
    // Variable para almacenar ubicaci√≥n del usuario
    let ubicacionUsuario = null;

    // Control de b√∫squedas: auto-b√∫squeda con debounce y una sola request activa
    let currentSearchRequest = null;
    let searchTimeoutId = null;
    const SEARCH_DEBOUNCE_MS = 600;
    
    // Cerrar dropdowns al hacer scroll (sin romper futuros clics)
    $(window).on('scroll', function() {
        $('.dropdown-menu.show').removeClass('show').css('display', '');
        $('.dropdown.show').removeClass('show');
        $('[data-bs-toggle="dropdown"][aria-expanded="true"]').attr('aria-expanded', 'false');
    });
    
    // Configurar dropdowns para que siempre se abran hacia abajo
    document.addEventListener('show.bs.dropdown', function(event) {
        // Forzar posici√≥n hacia abajo
        const dropdown = event.target;
        const menu = dropdown.nextElementSibling;
        
        if (menu && menu.classList.contains('dropdown-menu-filtros')) {
            // Configurar Popper.js para forzar posici√≥n bottom
            menu.setAttribute('data-bs-popper', 'static');
            
            // Aplicar estilos directamente para forzar posici√≥n
            setTimeout(() => {
                menu.style.position = 'absolute';
                menu.style.top = '100%';
                menu.style.bottom = 'auto';
                menu.style.left = '0';
                menu.style.right = 'auto';
                menu.style.transform = 'none';
                menu.style.inset = 'auto';
            }, 10);
        }
    });
    
    // Funci√≥n para actualizar estado de filtros
    function actualizarEstadoFiltros() {
        const requiredCount = (filtrosSeleccionados.area !== null ? 1 : 0) + (filtrosSeleccionados.categoria !== null ? 1 : 0);
        const totalCount = Object.values(filtrosSeleccionados).filter(v => v !== null).length;
        
        // Texto simple y robusto para el contador (evita depender de ngettext en JS)
        let countLabel;
        if (CURRENT_LANG === 'en') {
            countLabel = `${requiredCount}/2 required`;
        } else {
            countLabel = `${requiredCount}/2 obligatorios`;
        }
        $('#filtros-count').text(countLabel);
        
        if (totalCount > 0) {
            $('#filtros-estado').show();
            
            // Actualizar resumen
            let resumen = [];
            if (filtrosSeleccionados.area) resumen.push(`üìç ${filtrosSeleccionados.area.name}`);
            if (filtrosSeleccionados.categoria) resumen.push(`üè¢ ${filtrosSeleccionados.categoria.name}`);
        if (filtrosSeleccionados.caracteristica) resumen.push(`‚≠ê ${filtrosSeleccionados.caracteristica.name}`);
            $('#filtros-resumen').html(resumen.join(' ‚Ä¢ '));
            
            // Solo requiere √°rea y categor√≠a para habilitar b√∫squeda
            if (requiredCount === 2) {
                $('#buscar-btn').show().prop('disabled', false);
                // Disparar auto-b√∫squeda con debounce
                programarBusquedaAuto();
            } else {
                $('#buscar-btn').prop('disabled', true);
            }
        } else {
            $('#filtros-estado').hide();
            $('#buscar-btn').hide();
        }
    }
    
    // Funci√≥n para limpiar filtros
    function limpiarFiltros() {
        filtrosSeleccionados = {
            area: null,
            categoria: null,
            caracteristica: null
        };
        
        // Resetear UI de √°reas
        $('#area-selected-text').text(gettext('Seleccionar √Årea'));
        $('#area-check').hide();
        $('#areasDropdown').removeClass('selected');
        
        // Resetear UI de categor√≠as
        $('#categoria-selected-text').text(gettext('Seleccionar Tipo'));
        $('#categoria-check').hide();
        $('#categoriasDropdown').removeClass('selected');
        
        // Resetear UI de caracter√≠sticas
        $('#caracteristica-selected-text').text(gettext('Caracter√≠sticas'));
        $('#caracteristica-check').hide();
        $('#etiquetasDropdown').removeClass('selected');
        
        // Cancelar b√∫squedas pendientes
        if (searchTimeoutId) {
            clearTimeout(searchTimeoutId);
            searchTimeoutId = null;
        }
        if (currentSearchRequest) {
            currentSearchRequest.abort();
            currentSearchRequest = null;
        }

        // Ocultar resultados y estado
        $('#ajax-results').hide();
        $('#search-results-section').hide();
        $('#filtros-estado').hide();
        $('#buscar-btn').hide();
        
        actualizarEstadoFiltros();
    }
    
    // Bot√≥n para limpiar filtros
    $('#limpiar-filtros-btn').on('click', function(e) {
        e.preventDefault();
        limpiarFiltros();
    });
    
    // Manejar selecci√≥n de √°rea
    $('.area-option').on('click', function(e) {
        e.preventDefault();
        filtrosSeleccionados.area = {
            id: $(this).data('area-id'),
            name: $(this).data('area-name'),
            slug: $(this).data('area-slug')
        };
        $('#area-selected-text').text(filtrosSeleccionados.area.name);
        $('#area-check').show();
        $('#areasDropdown').addClass('selected');
        $('#areasDropdown').dropdown('hide');
        actualizarEstadoFiltros();
    });
    
    // Manejar selecci√≥n de categor√≠a
    $('.categoria-option').on('click', function(e) {
        e.preventDefault();
        filtrosSeleccionados.categoria = {
            id: $(this).data('categoria-id'),
            name: $(this).data('categoria-name')
        };
        $('#categoria-selected-text').text(filtrosSeleccionados.categoria.name);
        $('#categoria-check').show();
        $('#categoriasDropdown').addClass('selected');
        $('#categoriasDropdown').dropdown('hide');
        actualizarEstadoFiltros();
    });
    
    // Manejar selecci√≥n de caracter√≠stica
    $('.caracteristica-option').on('click', function(e) {
        e.preventDefault();
        const caracteristicaId = $(this).data('caracteristica-id');
        const caracteristicaName = $(this).data('caracteristica-name');
        
        if (caracteristicaId === 'none') {
            filtrosSeleccionados.caracteristica = null;
            $('#caracteristica-selected-text').text(gettext('Caracter√≠sticas (Opcional)'));
            $('#caracteristica-check').hide();
            $('#etiquetasDropdown').removeClass('selected');
        } else {
            filtrosSeleccionados.caracteristica = {
                id: caracteristicaId,
                name: caracteristicaName
            };
            $('#caracteristica-selected-text').text(filtrosSeleccionados.caracteristica.name);
            $('#caracteristica-check').show();
            $('#etiquetasDropdown').addClass('selected');
        }
        
        $('#etiquetasDropdown').dropdown('hide');
        actualizarEstadoFiltros();
    });
    
    // Programar auto-b√∫squeda (debounced)
    function programarBusquedaAuto() {
        // Solo buscar si tenemos √°rea y categor√≠a
        if (!filtrosSeleccionados.area || !filtrosSeleccionados.categoria) {
            return;
        }

        if (searchTimeoutId) {
            clearTimeout(searchTimeoutId);
        }

        searchTimeoutId = setTimeout(ejecutarBusquedaFiltros, SEARCH_DEBOUNCE_MS);
    }

    // Ejecutar b√∫squeda AJAX (garantizando una sola request activa)
    function ejecutarBusquedaFiltros() {
        searchTimeoutId = null;

        if (!filtrosSeleccionados.area || !filtrosSeleccionados.categoria) {
            return;
        }

        // Cancelar request anterior si sigue en curso
        if (currentSearchRequest && currentSearchRequest.readyState !== 4) {
            currentSearchRequest.abort();
        }

        // Mostrar loading
        $('#ajax-loading').show();
        $('#ajax-results').hide();
        $('#search-results-section').hide();

        currentSearchRequest = $.ajax({
            url: "{% url 'explorer:filtros_ajax' %}",
            type: 'GET',
            data: {
                area: filtrosSeleccionados.area.id,
                categoria: filtrosSeleccionados.categoria.id,
                caracteristica: filtrosSeleccionados.caracteristica ? filtrosSeleccionados.caracteristica.id : 'all'
            },
            success: function(response) {
                $('#ajax-loading').hide();
                
                if (response.success) {
                    renderizarResultados(response);
                } else {
                    mostrarError('Error en la b√∫squeda: ' + response.error);
                }
            },
            error: function(xhr, status, error) {
                if (status === 'abort') {
                    // B√∫squeda cancelada por una nueva, no mostrar error
                    return;
                }
                $('#ajax-loading').hide();
                mostrarError('Error de conexi√≥n: ' + error);
            },
            complete: function() {
                currentSearchRequest = null;
            }
        });
    }

    // Bot√≥n "Buscar Lugares" como disparador manual adicional (sin debounce)
    $('#buscar-btn').on('click', function() {
        ejecutarBusquedaFiltros();
    });
    
    // Funci√≥n para generar URL completa con slugs
    function generarUrlCompleta(data) {
        let baseUrl;
        let params = new URLSearchParams();
        
        // Priorizar slug de √°rea seleccionada, luego del area_info del response
        let areaSlug = null;
        if (filtrosSeleccionados.area && filtrosSeleccionados.area.slug) {
            areaSlug = filtrosSeleccionados.area.slug;
        } else if (data.area_info && data.area_info.slug) {
            areaSlug = data.area_info.slug;
        }
        
        // Usar helper que respeta el idioma actual
        baseUrl = buildPlacesListUrl(areaSlug);
        if (!areaSlug && filtrosSeleccionados.area) {
            // Cuando no tenemos slug pero s√≠ id de comuna, a√±adirlo como query param
            params.append('comuna', filtrosSeleccionados.area.id);
        }
        
        // Agregar otros filtros como par√°metros
        if (filtrosSeleccionados.categoria && filtrosSeleccionados.categoria.id !== 'all') {
            params.append('tipo', filtrosSeleccionados.categoria.id);
        }
        
        if (filtrosSeleccionados.caracteristica && filtrosSeleccionados.caracteristica.id !== 'all') {
            params.append(filtrosSeleccionados.caracteristica.id, 'true');
        }
        
        // Construir URL final
        return params.toString() ? `${baseUrl}?${params.toString()}` : baseUrl;
    }
    
    // Funci√≥n para renderizar resultados
    function renderizarResultados(data) {
        // Cerrar TODOS los dropdowns de forma agresiva (pero sin dejar inline display:none)
        $('.dropdown-menu-filtros').removeClass('show').css('display', '');
        $('.dropdown-menu').removeClass('show').css('display', '');
        $('.dropdown').removeClass('show');
        $('[data-bs-toggle="dropdown"]').attr('aria-expanded', 'false').removeClass('show');
        
        // Forzar cierre con Bootstrap API
        document.querySelectorAll('[data-bs-toggle="dropdown"]').forEach(btn => {
            const dropdown = bootstrap.Dropdown.getInstance(btn);
            if (dropdown) dropdown.hide();
        });
        
        // Mensaje de resultados: usar ngettext si est√° disponible, si no, fallback simple
        let msgResultados;
        if (typeof ngettext === 'function' && typeof interpolate === 'function') {
            msgResultados = interpolate(
                ngettext(
                    'Encontramos %s lugar que coincide con tus filtros',
                    'Encontramos %s lugares que coinciden con tus filtros',
                    data.total
                ),
                [data.total]
            );
        } else {
            if (CURRENT_LANG === 'en') {
                msgResultados = data.total === 1
                    ? `We found ${data.total} place matching your filters`
                    : `We found ${data.total} places matching your filters`;
            } else {
                msgResultados = data.total === 1
                    ? `Encontramos ${data.total} lugar que coincide con tus filtros`
                    : `Encontramos ${data.total} lugares que coinciden con tus filtros`;
            }
        }

        let html = `
            <div class="semantic-home-wrapper">
                <div class="semantic-home-header text-center mb-4 text-white">
                    <h2 class="fw-bold semantic-home-title">{% trans "Resultados de tu B√∫squeda" %}</h2>
                    <p class="lead mb-0">${msgResultados}</p>
                    <div class="mt-3">
                        <span class="badge bg-primary bg-opacity-20 text-white fs-6 px-3 py-2 me-2">
                            üìç ${filtrosSeleccionados.area.name}
                        </span>
                        <span class="badge bg-primary bg-opacity-20 text-white fs-6 px-3 py-2 me-2">
                            üè¢ ${filtrosSeleccionados.categoria.name}
                        </span>
                        ${filtrosSeleccionados.caracteristica ? 
                            `<span class="badge bg-primary bg-opacity-20 text-white fs-6 px-3 py-2">
                                ‚≠ê ${filtrosSeleccionados.caracteristica.name}
                            </span>` : 
                            `<span class="badge bg-secondary bg-opacity-20 text-white fs-6 px-3 py-2">${gettext('Sin filtro especial')}</span>`
                        }
                    </div>
                </div>
                
                <div class="semantic-home-grid lugares-grid">
        `;
        
        data.lugares.forEach(lugar => {
            html += `
                <div class="semantic-home-item lugar-card-wrapper">
                    <div class="card h-100 shadow-sm border-0 rounded-4 place-card semantic-home-card">
                        <div class="place-card-media position-relative">
                            ${lugar.imagen ? 
                                `<img src="${lugar.imagen}" class="card-img-top rounded-top-4" alt="${lugar.nombre}" loading="lazy">` :
                                `<div class="place-card-placeholder rounded-top-4 d-flex align-items-center justify-content-center">
                                    <i class="bi bi-image text-muted fs-2"></i>
                                </div>`
                            }
                            ${typeof lugar.rating === 'number' ? `
                                <div class="place-card-rating badge rounded-pill">
                                    <i class="bi bi-star-fill me-1"></i>
                                    <span class="fw-semibold">${lugar.rating.toFixed(1)}</span>
                                </div>` : ''
                            }
                        </div>

                        <div class="card-body d-flex flex-column place-card-body">
                            <h5 class="card-title fw-semibold mb-2 place-card-title">${lugar.nombre}</h5>
                            
                            <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                                ${lugar.tipo ? `<span class="badge place-type-pill"><i class="bi bi-geo-alt me-1"></i>${lugar.tipo}</span>` : ''}
                                ${lugar.es_destacado ? `<span class="badge place-flag-pill place-flag-featured"><i class="bi bi-star-fill me-1"></i>${gettext('Destacado')}</span>` : ''}
                                ${lugar.es_exclusivo ? `<span class="badge place-flag-pill place-flag-exclusive"><i class="bi bi-gem me-1"></i>${gettext('Exclusivo')}</span>` : ''}
                            </div>

                            ${typeof lugar.rating === 'number' ? `
                                <div class="small text-muted mb-2">
                                    <i class="bi bi-star-fill text-warning me-1"></i>
                                    <span class="fw-semibold">${lugar.rating.toFixed(1)}</span>/5
                                </div>` : ''
                            }

                            ${lugar.direccion ? `
                                <div class="small text-muted mb-2 place-card-address">
                                    <i class="bi bi-map me-1"></i>${lugar.direccion}
                                </div>` : ''
                            }

                            ${lugar.slug ? 
                                `<a href="${buildPlaceUrl(lugar.slug, lugar.url)}" class="btn mt-auto w-100 rounded-pill place-card-cta">
                                    <i class="bi bi-eye me-1"></i>${gettext('Ver detalles')}
                                </a>` :
                                `<span class="btn btn-outline-secondary disabled mt-auto w-100 rounded-pill">${gettext('Sin detalles')}</span>`
                            }
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
                
                <div class="text-center mt-5">
                    <a href="${generarUrlCompleta(data)}" 
                       class="btn btn-outline-light btn-lg rounded-pill px-4">
                        <i class="bi bi-arrow-right me-2"></i>{% trans "Ver Todos los Resultados" %}
                    </a>
                </div>
            </div>
        `;
        
        $('#ajax-results').html(html).show();
        $('#search-results-section').show();
        
        // Scroll suave a los resultados
        $('html, body').animate({
            scrollTop: $('#ajax-results').offset().top - 100
        }, 800);
    }
    
    // Funci√≥n para mostrar errores
    function mostrarError(mensaje) {
        $('#ajax-results').html(`
            <div class="container py-5">
                <div class="text-center text-white">
                    <i class="bi bi-exclamation-triangle fs-1 text-warning mb-3"></i>
                    <h3>{% trans "¬°Ups! Algo sali√≥ mal" %}</h3>
                    <p class="lead">${mensaje}</p>
                    <button class="btn btn-outline-light" onclick="location.reload();">
                        <i class="bi bi-arrow-clockwise me-2"></i>{% trans "Intentar de nuevo" %}
                    </button>
                </div>
            </div>
        `).show();
    }
    
    // GEOLOCALIZACI√ìN - Bot√≥n "Cerca de m√≠"
    $('#cerca-de-mi-btn').on('click', function() {
        obtenerUbicacionYBuscar();
    });
    
    // Constantes traducidas para geolocalizaci√≥n (inyectadas desde plantilla)
    const T_GETTING_LOCATION = '{% trans "Obteniendo ubicaci√≥n..." %}';
    const T_LOCATION_FOUND = '{% trans "Ubicaci√≥n encontrada" %}';
    const T_LOCATION_ERROR = '{% trans "Error de ubicaci√≥n" %}';

    function obtenerUbicacionYBuscar() {
        const btn = $('#cerca-de-mi-btn');
        const textSpan = $('#ubicacion-text');
        const loadingSpan = $('#ubicacion-loading');
        
        // Verificar soporte de geolocalizaci√≥n
        if (!navigator.geolocation) {
            mostrarErrorUbicacion(gettext('Tu navegador no soporta geolocalizaci√≥n'));
            return;
        }
        
        // Estado: obteniendo ubicaci√≥n
        btn.removeClass('success error').addClass('locating');
        textSpan.text(T_GETTING_LOCATION);
        loadingSpan.show();
        
        // Opciones de geolocalizaci√≥n
        const options = {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 300000 // 5 minutos de cache
        };
        
        navigator.geolocation.getCurrentPosition(
            function(position) {
                // √âxito al obtener ubicaci√≥n
                ubicacionUsuario = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    accuracy: position.coords.accuracy
                };
                
                // Actualizar UI
                btn.removeClass('locating').addClass('success');
                textSpan.text(T_LOCATION_FOUND);
                loadingSpan.hide();
                
                // Buscar lugares cercanos
                buscarLugaresCercanos();
            },
            function(error) {
                // Error al obtener ubicaci√≥n
                let mensaje;
                switch(error.code) {
                    case error.PERMISSION_DENIED:
                        mensaje = 'Permiso de ubicaci√≥n denegado. Por favor, habilita la ubicaci√≥n en tu navegador.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        mensaje = 'No se pudo determinar tu ubicaci√≥n. Intenta de nuevo.';
                        break;
                    case error.TIMEOUT:
                        mensaje = 'La solicitud de ubicaci√≥n tard√≥ demasiado. Intenta de nuevo.';
                        break;
                    default:
                        mensaje = 'Error desconocido al obtener la ubicaci√≥n.';
                        break;
                }
                
                mostrarErrorUbicacion(mensaje);
            },
            options
        );
    }
    
    function buscarLugaresCercanos() {
        if (!ubicacionUsuario) {
            mostrarErrorUbicacion('No se ha obtenido la ubicaci√≥n del usuario');
            return;
        }
        
        // Mostrar loading
        $('#ajax-loading').show();
        $('#ajax-results').hide();
        
        // Llamada AJAX
        $.ajax({
            url: "{% url 'explorer:lugares_cercanos_ajax' %}",
            type: 'GET',
            data: {
                lat: ubicacionUsuario.lat,
                lng: ubicacionUsuario.lng,
                radio: 0.8 // 800m por defecto
            },
            success: function(response) {
                $('#ajax-loading').hide();
                
                if (response.success) {
                    renderizarResultadosCercanos(response);
                } else {
                    mostrarError('Error en la b√∫squeda: ' + response.error);
                }
            },
            error: function(xhr, status, error) {
                $('#ajax-loading').hide();
                mostrarError('Error de conexi√≥n: ' + error);
            }
        });
    }
    
    function renderizarResultadosCercanos(data) {
        // Cerrar TODOS los dropdowns de forma agresiva (pero sin forzar display:none permanente)
        $('.dropdown-menu-filtros').removeClass('show').css('display', '');
        $('.dropdown-menu').removeClass('show').css('display', '');
        $('.dropdown').removeClass('show');
        $('[data-bs-toggle="dropdown"]').attr('aria-expanded', 'false').removeClass('show');
        
        // Forzar cierre con Bootstrap API
        document.querySelectorAll('[data-bs-toggle="dropdown"]').forEach(btn => {
            const dropdown = bootstrap.Dropdown.getInstance(btn);
            if (dropdown) dropdown.hide();
        });
        
        // Textos traducidos inyectados desde servidor
        const T_VIEW_DETAILS = '{% trans "Ver detalles" %}';
        const T_NO_DETAILS = '{% trans "Sin detalles" %}';
        const T_FEATURED = '{% trans "Destacado" %}';
        const T_EXCLUSIVE = '{% trans "Exclusivo" %}';
        const T_TOP_RATED = '{% trans "Top Valorado" %}';
        const T_RADIUS = '{% trans "Radio:" %}';
        let html = `
            <div class="semantic-home-wrapper">
                <div class="semantic-home-header text-center mb-4 text-white">
                    <h2 class="fw-bold semantic-home-title">{% trans "Lugares Cerca de Ti" %}</h2>
                    <p class="lead mb-0">${data.mensaje}</p>
                    <div class="mt-3">
                        <span class="badge bg-success bg-opacity-20 text-white fs-6 px-3 py-2">
                            <i class="bi bi-geo-fill me-2"></i>${T_RADIUS} ${data.ubicacion_usuario.radio < 1 ? (data.ubicacion_usuario.radio * 1000) + 'm' : data.ubicacion_usuario.radio + 'km'}
                        </span>
                        <span class="badge bg-info bg-opacity-20 text-white fs-6 px-3 py-2 ms-2">
                            <i class="bi bi-bullseye me-2"></i>{% trans "Precisi√≥n GPS activa" %}
                        </span>
                    </div>
                </div>
                
                <div class="semantic-home-grid lugares-grid">
        `;
        
        data.lugares.forEach(lugar => {
            html += `
                <div class="semantic-home-item lugar-card-wrapper">
                    <div class="card h-100 shadow-sm border-0 rounded-4 place-card semantic-home-card">
                        <div class="place-card-media position-relative">
                            ${lugar.imagen ? 
                                `<img src="${lugar.imagen}" class="card-img-top rounded-top-4" alt="${lugar.nombre}" loading="lazy">` :
                                `<div class="place-card-placeholder rounded-top-4 d-flex align-items-center justify-content-center">
                                    <i class="bi bi-image text-muted fs-2"></i>
                                </div>`
                            }
                            
                            <div class="badge-overlay">
                                <span class="badge bg-primary rounded-pill">
                                    <i class="bi bi-geo-alt me-1"></i>${lugar.distancia < 1 ? Math.round(lugar.distancia * 1000) + 'm' : lugar.distancia + 'km'}
                                </span>
                            </div>
                        </div>
                        
                        <div class="card-body d-flex flex-column place-card-body">
                            <h5 class="card-title fw-semibold mb-2 place-card-title">${lugar.nombre}</h5>
                            
                            <div class="d-flex flex-wrap align-items-center gap-2 mb-2 small">
                                <span class="badge place-type-pill">
                                    <i class="bi bi-geo-alt me-1"></i>${lugar.tipo}
                                </span>
                                ${lugar.es_destacado ? `<span class="badge place-flag-pill place-flag-featured"><i class="bi bi-star-fill me-1"></i>${T_FEATURED}</span>` : ''}
                                ${lugar.es_exclusivo ? `<span class="badge place-flag-pill place-flag-exclusive"><i class="bi bi-gem me-1"></i>${T_EXCLUSIVE}</span>` : ''}
                                ${lugar.rating >= 4.5 ? `<span class="badge place-flag-pill place-flag-featured"><i class="bi bi-award me-1"></i>${T_TOP_RATED}</span>` : ''}
                            </div>

                            ${typeof lugar.rating === 'number' ? `
                                <div class="small text-muted mb-2">
                                    <i class="bi bi-star-fill text-warning me-1"></i>
                                    <span class="fw-semibold">${lugar.rating.toFixed(1)}</span>/5
                                </div>` : ''
                            }
                            
                            ${lugar.direccion ? `
                                <div class="small text-muted mb-3 place-card-address">
                                    <i class="bi bi-map me-1"></i>${lugar.direccion}
                                </div>` : ''
                            }

                            ${lugar.slug ? 
                                `<a href="${buildPlaceUrl(lugar.slug, lugar.url)}" class="btn mt-auto w-100 rounded-pill place-card-cta">
                                    <i class="bi bi-eye me-1"></i>${T_VIEW_DETAILS}
                                </a>` :
                                `<span class="btn btn-outline-secondary disabled mt-auto w-100 rounded-pill">${T_NO_DETAILS}</span>`
                            }
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
                
                <div class="text-center mt-4">
                    <button class="btn btn-outline-light btn-lg rounded-pill px-4 me-3" onclick="obtenerUbicacionYBuscar()">
                        <i class="bi bi-arrow-clockwise me-2"></i>{% trans "Actualizar Ubicaci√≥n" %}
                    </button>
                    <a href="{% url 'explorer:lugares_list' %}" 
                       class="btn btn-gradient-green btn-lg rounded-pill px-4">
                        <i class="bi bi-arrow-right me-2"></i>{% trans "Ver Todos los Lugares" %}
                    </a>
                </div>
            </div>
        `;
        
        $('#ajax-results').html(html).show();
        $('#search-results-section').show();
        
        // Scroll suave a los resultados
        $('html, body').animate({
            scrollTop: $('#ajax-results').offset().top - 100
        }, 800);
    }
    
    function mostrarErrorUbicacion(mensaje) {
        const btn = $('#cerca-de-mi-btn');
        const textSpan = $('#ubicacion-text');
        const loadingSpan = $('#ubicacion-loading');
        
        btn.removeClass('locating success').addClass('error');
        textSpan.text(T_LOCATION_ERROR);
        loadingSpan.hide();
        
        // Mostrar error en resultados
        $('#ajax-results').html(`
            <div class="container py-5">
                <div class="text-center text-white">
                    <i class="bi bi-geo-alt-fill fs-1 text-danger mb-3"></i>
                    <h3>${gettext('Error de Geolocalizaci√≥n')}</h3>
                    <p class="lead">${mensaje}</p>
                    <div class="mt-4">
                        <button class="btn btn-outline-light me-3" onclick="obtenerUbicacionYBuscar();">
                            <i class="bi bi-arrow-clockwise me-2"></i>${gettext('Intentar de nuevo')}
                        </button>
                        <a href="{% url 'explorer:lugares_list' %}" class="btn btn-gradient-green">
                            <i class="bi bi-compass me-2"></i>${gettext('Ver todos los lugares')}
                        </a>
                    </div>
                </div>
            </div>
        `).show();
        
        // Reset del bot√≥n despu√©s de 3 segundos
        setTimeout(() => {
            btn.removeClass('error');
            textSpan.text(gettext('Cerca de M√≠'));
        }, 3000);
    }
});

    function renderizarResultadosSemanticos(data) {
        // Cerrar TODOS los dropdowns de forma agresiva (sin bloquear futuros clics)
        $('.dropdown-menu-filtros').removeClass('show').css('display', '');
        $('.dropdown-menu').removeClass('show').css('display', '');
        $('.dropdown').removeClass('show');
        $('[data-bs-toggle="dropdown"]').attr('aria-expanded', 'false').removeClass('show');
        
        // Forzar cierre con Bootstrap API
        document.querySelectorAll('[data-bs-toggle="dropdown"]').forEach(btn => {
            const dropdown = bootstrap.Dropdown.getInstance(btn);
            if (dropdown) dropdown.hide();
        });
        
        const T_VIEW_DETAILS = '{% trans "Ver detalles" %}';
        const T_NO_DETAILS = '{% trans "Sin detalles" %}';
        
        let html = `
            <div class="semantic-home-wrapper">
                <div class="semantic-home-header text-center mb-4 text-white">
                    <h2 class="fw-bold semantic-home-title">${gettext('Resultados Sem√°nticos')}</h2>
                    <p class="lead mb-0">${gettext('Consulta')}: <span class="semantic-home-query">‚Äú${data.query || ''}‚Äù</span></p>
                </div>
                <div class="semantic-home-grid lugares-grid">
        `;
        
        (data.lugares || []).forEach(lugar => {
            html += `
                <div class="semantic-home-item lugar-card-wrapper">
                    <div class="card h-100 shadow-sm border-0 rounded-4 place-card semantic-home-card">
                        <div class="place-card-media position-relative">
                            ${lugar.imagen ? 
                                `<img src="${lugar.imagen}" class="card-img-top rounded-top-4" alt="${lugar.nombre || ''}" loading="lazy">` :
                                `<div class="place-card-placeholder rounded-top-4 d-flex align-items-center justify-content-center">
                                    <i class="bi bi-image text-muted fs-2"></i>
                                </div>`
                            }
                            ${typeof lugar.rating === 'number' ? `
                                <div class="place-card-rating badge rounded-pill">
                                    <i class="bi bi-star-fill me-1"></i><span class="fw-semibold">${lugar.rating.toFixed(1)}</span>
                                </div>` : ''
                            }
                        </div>

                        <div class="card-body d-flex flex-column place-card-body">
                            <h5 class="card-title fw-semibold mb-2 place-card-title">${lugar.nombre || ''}</h5>
                            
                            <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                                ${lugar.tipo ? `<span class="badge place-type-pill"><i class="bi bi-geo-alt me-1"></i>${lugar.tipo}</span>` : ''}
                                ${lugar.es_destacado ? `<span class="badge place-flag-pill place-flag-featured"><i class="bi bi-star-fill me-1"></i>${gettext('Destacado')}</span>` : ''}
                                ${lugar.es_exclusivo ? `<span class="badge place-flag-pill place-flag-exclusive"><i class="bi bi-gem me-1"></i>${gettext('Exclusivo')}</span>` : ''}
                            </div>

                            ${typeof lugar.rating === 'number' ? `
                                <div class="small text-muted mb-2">
                                    <i class="bi bi-star-fill text-warning me-1"></i><span class="fw-semibold">${lugar.rating.toFixed(1)}</span>/5
                                </div>` : ''
                            }

                            ${lugar.direccion ? `
                                <div class="small text-muted mb-3 place-card-address">
                                    <i class="bi bi-map me-1"></i>${lugar.direccion}
                                </div>` : ''
                            }

                            ${lugar.slug ? 
                                `<a href="${buildPlaceUrl(lugar.slug, lugar.url)}" class="btn mt-auto w-100 rounded-pill place-card-cta">
                                    <i class="bi bi-eye me-1"></i>${T_VIEW_DETAILS}
                                </a>` :
                                `<span class="btn btn-outline-secondary disabled mt-auto w-100 rounded-pill">${T_NO_DETAILS}</span>`
                            }
                        </div>
                    </div>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
        
        $('#ajax-results').html(html).show();
        $('#search-results-section').show();
        $('html, body').animate({ scrollTop: $('#ajax-results').offset().top - 100 }, 800);
    }
</script>
{% endblock %}
